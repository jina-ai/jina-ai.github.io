{
  "slug": "using-deepseek-r1-reasoning-model-in-deepsearch",
  "id": "67dd5037143bda0001036423",
  "uuid": "3ebc2ba7-b65b-408b-9466-ca902b28756a",
  "title": "DeepSeek R1 推論モデルを DeepSearch で使用する",
  "html": "<p><a href=\"https://jina.ai/news/a-practical-guide-to-implementing-deepsearch-deepresearch\">我々の見方では、DeepSearch は本質的に一つの大きな while ループです。</a>最大トークン予算の中で、最適な回答を見つけるまで検索、読解、思考のサイクルを繰り返します。LLM の重要なタスクの一つは、現在のメモリ状態に基づいて次にどのアクションを取るべきかを判断することです。検索を続けるべきでしょうか？ウェブページを読むべきでしょうか？それとも直接質問に答えるべきでしょうか？</p><p>私たちの <a href=\"https://github.com/jina-ai/node-DeepResearch\">node-deepresearch</a> の実装では、アクションの選択に <em>標準的な</em> LLM（<code>gemini-2.0-flash</code>）を使用しています。これを「標準的」と呼ぶのは、推論プロセスがプロンプトエンジニアリングを通じて明示的に概要化され、選択されたアクションが JSON オブジェクトとして返される sequence-in, sequence-out として動作するからです。そこで自然な疑問が生じます：この判断ステップを専用の推論モデルに置き換えることで、DeepSearch のパフォーマンスは向上するでしょうか？</p><figure class=\"kg-card kg-image-card kg-card-hascaption\"><img src=\"https://jina-ai-gmbh.ghost.io/content/images/2025/04/Heading--91-.png\" class=\"kg-image\" alt=\"\" loading=\"lazy\" width=\"1200\" height=\"630\" srcset=\"https://jina-ai-gmbh.ghost.io/content/images/size/w600/2025/04/Heading--91-.png 600w, https://jina-ai-gmbh.ghost.io/content/images/size/w1000/2025/04/Heading--91-.png 1000w, https://jina-ai-gmbh.ghost.io/content/images/2025/04/Heading--91-.png 1200w\" sizes=\"(min-width: 720px) 720px\"><figcaption><span style=\"white-space: pre-wrap;\">DeepSearch 実装の大きな while ループにおけるアクション決定ステップは、現在のコンテキストとメモリに基づいて、次のアクションを決定します。</span></figcaption></figure><p>この投稿では、<a href=\"https://github.com/deepseek-ai/DeepSeek-R1\">DeepSeek R1</a> 671b という推論 LLM を使用して、この判断ステップの <code>gemini-2.0-flash</code> を置き換えることを検討します。R1 の推論能力は、ウェブ検索とその結果の分析における複雑な問題の解決に役立つと考えています。</p><p>このコンセプトをテストするために、実践的な例として包括的な 3 日間の休暇計画を立てるタスクを実行し、その性能を評価します。ディープサーチタスクを実行するエージェントは、人間と同じような問題に遭遇する可能性が高いため、この休暇タスクでは以下のような問題に直面する可能性があります：</p><ul><li><strong>知識のギャップ（他の情報に依存する情報）</strong>：例えば、エッフェル塔を訪れたいが、祝日に開いているかどうかわからない。塔の休日スケジュールとフランスの祝日の日付の両方を調べる必要があります。</li><li><strong>誤ったまたは古い情報</strong>：2020 年の旅行ブログでは、ローマのある特定のレストランが日曜日に営業していると書かれていますが、実際に行ってみると営業時間が変更されており、現在は日曜日が休業日になっています。</li><li><strong>矛盾する情報</strong>：あるウェブサイトではニューヨークのあるホテルが無料の朝食を提供すると主張している一方で、別のサイトでは朝食は宿泊料金に含まれていないと述べています。</li><li><strong>曖昧な情報</strong>：旅行フォーラムの投稿で「バルセロナ近くの素晴らしいビーチ」と言及されているが、具体的なビーチ名や明確な方向が示されておらず、正確な場所を特定するのが困難です。</li></ul><p>R1 は複雑なタスクを実行可能なステップに分解し、ギャップと矛盾を特定し、ブロックされたウェブサイトや購読者向けウォールなどの障害を乗り越えることができます。必要な知識を収集し、回答を統合する推論能力を持っています。しかし、単独で休暇を計画することはできません — それにはウェブ検索とその結果の理解が必要です。このタスクに対応できるようにするには、フレームワークを設定し、その能力を強化する必要があります。</p><h2 id=\"implementation\">実装</h2><figure class=\"kg-card kg-bookmark-card kg-card-hascaption\"><a class=\"kg-bookmark-container\" href=\"https://colab.research.google.com/drive/18sqU8_eWqFleKqpd-SnGDNmZ_P1KLfXw?usp=sharing#scrollTo=2jFWdbnp_6ws\"><div class=\"kg-bookmark-content\"><div class=\"kg-bookmark-title\">Google Colab</div><div class=\"kg-bookmark-description\"></div><div class=\"kg-bookmark-metadata\"><img class=\"kg-bookmark-icon\" src=\"https://jina-ai-gmbh.ghost.io/content/images/icon/favicon-32.ico\" alt=\"\"></div></div><div class=\"kg-bookmark-thumbnail\"><img src=\"https://jina-ai-gmbh.ghost.io/content/images/thumbnail/colab_favicon_256px-7.png\" alt=\"\" onerror=\"this.style.display = 'none'\"></div></a><figcaption><p><span style=\"white-space: pre-wrap;\">ノートブックを実行するには、</span><a href=\"https://jina.ai\"><span style=\"white-space: pre-wrap;\">Jina AI</span></a><span style=\"white-space: pre-wrap;\">と</span><a href=\"https://openrouter.ai\"><span style=\"white-space: pre-wrap;\">OpenRouter</span></a><span style=\"white-space: pre-wrap;\">の無料 API キーが必要です。</span></p></figcaption></figure><p>R1 はエージェントのエンジンですが、いくつかのツール、状態オブジェクト、そしてもちろん（かなり大きな）プロンプトも追加します。以下は簡略化した表現です：</p><figure class=\"kg-card kg-image-card\"><img src=\"https://jina-ai-gmbh.ghost.io/content/images/2025/03/image-29.png\" class=\"kg-image\" alt=\"\" loading=\"lazy\" width=\"1639\" height=\"2256\" srcset=\"https://jina-ai-gmbh.ghost.io/content/images/size/w600/2025/03/image-29.png 600w, https://jina-ai-gmbh.ghost.io/content/images/size/w1000/2025/03/image-29.png 1000w, https://jina-ai-gmbh.ghost.io/content/images/size/w1600/2025/03/image-29.png 1600w, https://jina-ai-gmbh.ghost.io/content/images/2025/03/image-29.png 1639w\" sizes=\"(min-width: 720px) 720px\"></figure><ul><li><strong>ツール</strong>はモデルから呼び出して Web の検索とスクレイピングを行い、結果は状態に保存されます。</li><li><strong>状態</strong>はツールの結果、タスクのステータス、知識を追跡します。これはプロンプト自体に保存されます。</li><li><strong>単一のプロンプト</strong>は指示を提供し、タスクとその実行方法を指定するとともに、状態を保存します。</li></ul><p>これらの詳細については後ほど、特にプロンプトについて説明します。簡単に言うと、システムは次のように機能します：</p><p>状態オブジェクトが未設定のプロンプトから始まります。タスクが進行中（つまり回答を生成しようとしている）の間、エージェントは回答を生成するまで以下のループを実行します：</p><ol><li>モデルはプロンプトからタスクとその状態を検証し、回答を得るためにツールをどのように使用するのが最適かを推論します。</li><li>モデルはステータス（<code>IN PROGRESS</code>または<code>DONE</code>）、メモリの更新、ツールの呼び出し、回答（最初は<code>null</code>）を指定する JSON オブジェクトを出力します。</li><li>エージェントは非同期でツールを呼び出し、結果はステップ 3 の JSON オブジェクトとともにプロンプトに埋め込まれます。</li><li>この新しい情報を含むプロンプトがモデルに戻され、別のループを実行します。</li></ol><p>モデルが出力で回答を提供し次第、タスクは終了し、回答が配信されます。</p><div class=\"kg-card kg-callout-card kg-callout-card-blue\"><div class=\"kg-callout-emoji\">💡</div><div class=\"kg-callout-text\">エージェントの動作をより良く理解するために、<a href=\"https://colab.research.google.com/drive/18sqU8_eWqFleKqpd-SnGDNmZ_P1KLfXw?usp=sharing#scrollTo=2jFWdbnp_6ws\">ノートブック</a>を自分で試して、各イテレーションでの出力を確認することをお勧めします。</div></div><p>全体像を把握したところで、ツール、状態、プロンプトを順番に見ていきましょう：</p><h2 id=\"tools\">ツール</h2><p>R1 は単独で Web の検索やスクレイピングができないため、Jina の Reader API を使用してその機能を拡張します。これには 2 つのモードがあります：</p><ul><li><strong>検索モード</strong>：関連する用語の Web 検索を行い、検索エンジンの結果（各結果の URL、タイトル、説明を含む）を返します。</li><li><strong>読み取りモード</strong>：検索結果からページをスクレイピングし、Markdown 形式で返します。</li></ul><p>R1 のコンテキストウィンドウには制限があるため、プロンプトの <code>Tool Results</code> セクションにページ全体をダンプすることはできません。モデルに渡す前に最も関連性の高い情報だけを選択するための追加のツールが必要です：</p><ul><li><a href=\"https://python.langchain.com/docs/concepts/text_splitters/\"><strong>LangChain recursive character text splitter</strong></a>：<code>RecursiveCharacterTextSplitter</code> を使用して長い出力を段落と文で再帰的に分割し、目的のセグメントサイズを得ます。これにより、R1 の限られたコンテキストウィンドウで処理しやすい出力が保証されます。</li><li><a href=\"https://jina.ai/reranker\"><strong>Jina Reranker</strong></a>：<code>jina-reranker-v2-base-multilingual</code> でセグメントを再ランク付けし、上位ランクのセグメントを 1 つの結果に結合します。</li></ul><p>残念ながら、DeepSeek R1 は <code>o3-mini</code> のようなツールの使用をサポートしていません。例えば、<code>o3-mini</code> では以下のようなことができます：</p><figure class=\"kg-card kg-code-card\"><pre><code class=\"language-python\">def scrape_page(url: str):\n    \"\"\"Scrape a web page with Jina Reader\"\"\"\n\ntools = [\n    {\n        \"type\": \"function\",\n        \"function\": {\n            \"name\": \"scrape_page\",\n            \"description\": \"Scrape the content of a webpage\",\n            \"parameters\": {\n                \"url\": {\"type\": \"string\", \"description\": \"The URL to scrape\"}\n            }\n        }\n    }\n]\n\nclient = OpenAI()\nresponse = client.completions.create(\n    model=\"o3-mini\",\n    prompt=f\"Scrape www.skyscanner.net/routes/gr/de/germany-to-crete.html\",\n    tools=tools\n)\n</code></pre><figcaption><p><span style=\"white-space: pre-wrap;\">ツール使用をサポートする o3-mini コードの例</span></p></figcaption></figure><p>しかし、これは R1 では簡単ではありません：API に渡せる <code>tools</code> パラメータはなく、レスポンスの一部として構造化された <code>tool_calls</code> を返しません。簡単に言えば、ツールを使用するように訓練されていないのです（<a href=\"https://github.com/deepseek-ai/DeepSeek-R1/issues/9\">そして近い将来もサポートされる予定はありません</a>）。少なくとも、従来の意味ではサポートしていません。しかし、R1 にツール呼び出しを JSON 形式で出力させ、ツール呼び出しの結果をモデルに戻して分析させることは可能です：</p><figure class=\"kg-card kg-code-card\"><pre><code class=\"language-markdown\">You must respond with a valid JSON object containing:\n```json\n{\n  \"tool_calls\": [\n    {\"tool\": \"search\", \"input\": \"Cheapest flights from Germany to Crete May 2025\"},\n    {\"tool\": \"scrape\", \"input\": \"&lt;https://www.skyscanner.net/routes/gr/de/germany-to-crete.html&gt;\"}\n  ]\n}\n```</code></pre><figcaption><p><span style=\"white-space: pre-wrap;\">R1 のプロンプトの一部としてのツール呼び出し</span></p></figcaption></figure><p>モデルが反復 <em>n</em> でツール呼び出しを出力した後、ツールが呼び出され、その結果は反復 <em>n+1</em> でモデルが推論するためのプロンプトの <code>Tool Results</code> セクションに埋め込まれます：</p><figure class=\"kg-card kg-code-card\"><pre><code class=\"language-markdown\">Tool Results:\n\nSource 1️: search: Cheapest flights from Germany to Crete May 2025\nResult:\n\n```\nTitle: Affordable flights: Germany - Heraklion (Crete) (HER) | Eurowings URL Source: https://www.eurowings.com/en/booking/offers/flights-from/DE/to/GR/HER.html Description: Affordable flights from Germany to Heraklion (Crete) ✈ Eurowings brings you closer to your dream destination from as little as €89.99*. Book now and enjoy.\nTitle: Are you a person or a robot? URL Source: https://www.skyscanner.com/routes/fran/her/frankfurt-to-crete-heraklion.html Description: Book a one-way ticket from Frankfurt to Heraklion Airport from $78 or travel return from just $154. The prices shown are based on availability and could change ...\n```\n</code></pre><figcaption><p><span style=\"white-space: pre-wrap;\">ドイツ-クレタ間のフライト検索結果を示すツール結果</span></p></figcaption></figure><h2 id=\"state\">状態</h2><p>状態は、タスクのステータス（<code>Status</code>）とモデルが分析・更新する必要のある知識（<code>Memory</code>）を追跡します。簡単に言えば、システムのワーキングメモリとメモリバンクです。これは <code>{{ workspace }}</code> と呼ばれるプロンプトのセクションに保存され、白紙の状態から始まります：</p><figure class=\"kg-card kg-code-card\"><pre><code class=\"language-markdown\">Status: IN_PROGRESS\nMemory: \n... no memory blocks ..\n</code></pre><figcaption><p><span style=\"white-space: pre-wrap;\">空の状態オブジェクト</span></p></figcaption></figure><p>モデルがタスクについて推論し、ツールを実行し、出力を収集するにつれて、状態にはランダムに割り当てられた ID を持つメモリブロック（ツール出力から導出）が追加されていきます。私たちの休暇プランニングの例では、エージェントの 1 回の反復を実行した後、状態は次のようになります：</p><figure class=\"kg-card kg-code-card\"><pre><code class=\"language-markdown\">Status: IN_PROGRESS\nMemory: \n&lt;nuz-032&gt;Potential warm May destinations: Malaga (Spain), Crete (Greece), Algarve (Portugal)&lt;/nuz-032&gt;\n&lt;xwj-969&gt;URL to scrape for Crete hotel details: &lt;https://www.tripadvisor.com/HotelsList-Crete-Beachfront-Cheap-Hotels-zfp13280541.html&gt;&lt;/xwj-969&gt;\n&lt;vsc-583&gt;URL to scrape for flight details: &lt;https://www.expedia.com/lp/flights/fra/her/frankfurt-to-heraklion&gt;&lt;/vsc-583&gt;\n</code></pre><figcaption><p><span style=\"white-space: pre-wrap;\">DeepSeek R1 によって追加された状態</span></p></figcaption></figure><p>メモリブロックは、モデルの JSON レスポンスに <code>memory_updates</code> のリストを含めることで更新されます：</p><figure class=\"kg-card kg-code-card\"><pre><code class=\"language-json\">{\n\t\"memory_updates\": [\n\t  {\"operation\": \"add\", \"content\": \"Round-trip flight from Berlin to Tenerife in May 2025 ranges from €59.99 to €200 round-trip as per the Skyscanner and Iberia sources.\"},\n\t  {\"operation\": \"delete\", \"id\": \"nuz-032\"},\n\t  ...\n\t]\n}</code></pre><figcaption><p><span style=\"white-space: pre-wrap;\">R1 の JSON 出力の一部としてのメモリ更新</span></p></figcaption></figure><ul><li><strong><code>add</code> 操作</strong>はメモリブロックを追加し、リード、発見、情報ギャップ、すでに実行したアクションなどの重要な情報を保存するために使用できます。</li><li><strong><code>delete</code> 操作</strong>はメモリブロックを削除し、古い、不要な、または誤った情報を削除してクリーンなワークスペースを維持することができます。</li></ul><div class=\"kg-card kg-callout-card kg-callout-card-yellow\"><div class=\"kg-callout-emoji\">💡</div><div class=\"kg-callout-text\"><code spellcheck=\"false\" style=\"white-space: pre-wrap;\">replace</code> 操作もテストしましたが、モデルが大きな情報ブロックを生成し（<code spellcheck=\"false\" style=\"white-space: pre-wrap;\">replace</code> に過度に依存）、このオプションを削除することにしました。</div></div><p>ツール呼び出しと比較すると、R1 は自身のメモリ管理にはそれほど慣れていません。モデルは複雑な数学問題やコーディングタスクを推論するように特別にトレーニングされていました（これにより正確な JSON オブジェクトを生成しツール呼び出しを実行できます）が、メモリのような状態を管理するようにはトレーニングされていませんでした（私たちの知る限り、他のモデルもそうです）。</p><p>コンパクトなメモリのような状態を使用して情報を保存することは、モデルの各ラウンドの出力全体を保存することと比べていくつかの利点があります。このアプローチではプロンプト内の情報を凝縮し、コンテキストのオーバーフローを防ぎながら、関連する知識へのモデルの焦点を強化します。JSON は更新が容易なため JSON として保持しますが、JSON はプロンプト内で人間が読みやすい形式でレンダリングされます。</p><p>それでもなお、メモリ管理は R1 のコアドメイン外にあります。モデルが適切にメモリ操作を処理するように、複数の指示を実装する必要がありました。以下がそれを扱うプロンプトの部分です：</p><figure class=\"kg-card kg-code-card\"><pre><code class=\"language-markdown\">... プロンプトの他の内容 ...\n\n## Memory Block Usage\n- Each memory block has a unique ID in format &lt;abc-123&gt;content&lt;/abc-123&gt;\n- Create separate blocks for distinct pieces of information:\n  * Discovered URLs (both explored and pending)\n  * Information gaps that need investigation\n  * Actions already taken (to avoid repetition)\n  * Promising leads for future exploration\n  * Key facts and findings\n  * Contradictions or inconsistencies found\n- Keep each block focused on a single idea or piece of information\n- Always cite sources when recording information from tool results\n- Use IDs to track and manage your knowledge (e.g., deleting outdated information)\n- Make sure to store sources (URLs) for the facts and findings you store\n\n## Lead Management\n- Since you can only make 3 tool calls per round, store promising leads for later\n- Create dedicated memory blocks for URLs to scrape later\n- Maintain blocks for potential search queries to explore in future rounds\n- Prioritize leads based on relevance to the task\n\n... プロンプトの他の内容 ...</code></pre><figcaption><p><span style=\"white-space: pre-wrap;\">プロンプト内のメモリ処理指示</span></p></figcaption></figure><h2 id=\"prompt\">プロンプト</h2><p>プロンプトは <a href=\"https://jinja.palletsprojects.com/en/stable/templates/\">Jinja テンプレート形式</a>を使用して作成しました。以下のセクションで構成されています：</p><ul><li><strong>コンテキスト</strong>（この場合、現在の日付）</li><li><strong>指示</strong>、すべての動作方法と、利用可能なツールについてモデルに伝えます</li><li><strong>状態</strong>、上記で説明したもの</li><li><strong>ツール出力</strong>、<code>search</code> と <code>scrape</code> ツールからの出力</li></ul><figure class=\"kg-card kg-code-card\"><pre><code class=\"language-markdown\">{% macro format_tool_results(tool_records) %}\n{% for to in tool_records %}\nSource {{ loop.index }}️: {{ to.tool }}: {{ to.input }}\nResult:\n```\n{{ to.output }}\n```\n{% endfor %}\n{% endmacro %}\n\nThe date: `{{ current_date }}`.\nYou are an information analysis and exploration agent that builds solutions through systematic investigation.\n\n## Investigation Cycle\nYou operate in a continuous investigation cycle:\n\n1. Review current workspace (your memory blocks)\n2. Analyze new tool results (or initial task if first round)\n3. Update memory with new insights and track investigation progress\n4. Decide on next tools to call based on identified leads and information gaps\n5. Repeat until task completion\n\n## Memory Structure\nYour memory persists between investigation cycles and consists of:\n- **Status**: Always the first line, indicates if the task is IN_PROGRESS or DONE\n- **Memory**: A collection of discrete information blocks, each with a unique ID\n\n## Memory Block Usage\n- Each memory block has a unique ID in format &lt;abc-123&gt;content&lt;/abc-123&gt;\n- Create separate blocks for distinct pieces of information:\n  * Discovered URLs (both explored and pending)\n  * Information gaps that need investigation\n  * Actions already taken (to avoid repetition)\n  * Promising leads for future exploration\n  * Key facts and findings\n  * Contradictions or inconsistencies found\n- Keep each block focused on a single idea or piece of information\n- Always cite sources when recording information from tool results\n- Use IDs to track and manage your knowledge (e.g., deleting outdated information)\n- Make sure to store sources (URLs) for the facts and findings you store\n\n## Lead Management\n- Since you can only make 3 tool calls per round, store promising leads for later\n- Create dedicated memory blocks for URLs to scrape later\n- Maintain blocks for potential search queries to explore in future rounds\n- Prioritize leads based on relevance to the task\n\n## Available Tools\n- **search**: Use for broad information gathering on new topics or concepts\n  * Example: {\"tool\": \"search\", \"input\": \"renewable energy statistics 2023\"}\n- **scrape**: Use for extracting specific details from discovered URLs\n  * Example: {\"tool\": \"scrape\", \"input\": \"https://example.com/energy-report\"}\n\n## Tool Usage Guidelines\n- **When to use search**: For new concepts, filling knowledge gaps, or exploring new directions\n- **When to use scrape**: For URLs discovered that likely contain detailed information\n- **Maximum 3 tool calls per round**\n- **Never repeat the exact same tool call**\n- **Always record valuable information from tool results in memory blocks**\n\n## Response Format\nYou must respond with a valid JSON object containing:\n\n```json\n{\n  \"status_update\": \"IN_PROGRESS or DONE\",\n  \"memory_updates\": [\n    {\"operation\": \"add\", \"content\": \"New insight or lead to investigate\"},\n    {\"operation\": \"delete\", \"id\": \"abc-123\"}\n  ],\n  \"tool_calls\": [\n    {\"tool\": \"search\", \"input\": \"specific search query\"},\n    {\"tool\": \"scrape\", \"input\": \"https://discovered-url.com\"}\n  ],\n  \"answer\": \"Your final, comprehensive answer when status is DONE\"\n}\n```\n\n## Important Rules\n- The \"add\" operation creates a new memory block\n\tYou do not need to specify an ID, it will be added automatically by the system.\n- The \"delete\" operation requires the specific ID of the block to remove\n- Never invent or fabricate information - only use facts from your memory or tool results\n- Never make up URLs - only use URLs discovered through tool results\n- CRITICAL: Any information not recorded in your memory blocks will be lost in the next round\n  For example, if you find a potential webpage to scrap, you must store the URL and your intention\n  Example: `{\"operation\": \"add\", \"content\": \"Found relevant URL: https://... to scrape ...\"}`\n- Set status to \"DONE\" only when you have fully addressed the task\n- Only include the \"answer\" field when status is \"DONE\"\n\nTask:\n```\n{{ task }}\n```\n\nCurrent workspace:\n```\n{{ workspace }}\n```\n\nTool Results:\n{{ format_tool_results(tool_records) if tool_records else '... no previous tool results ...'}}\n\nIMPORTANT: Generate a valid JSON response following the format above.\n\nThink carefully about:\n- what information do you need to preserve\n- which tools to call next\n- how to build your answer systematically with focused memory blocks</code></pre><figcaption><p><span style=\"white-space: pre-wrap;\">ディープサーチシステムで使用される完全なプロンプト</span></p></figcaption></figure><div class=\"kg-card kg-callout-card kg-callout-card-yellow\"><div class=\"kg-callout-emoji\">💡</div><div class=\"kg-callout-text\">プロンプトの上部にある Jinja マクロ関数は、ツールの結果をより見やすい形式でレンダリングするためのものです。</div></div><h2 id=\"evaluation\">評価</h2><p>私たちは休暇計画の例でシステムをテストしました。以下がプロンプトに組み込まれたタスクです：</p><pre><code class=\"language-text\">Help me plan a 3 day holiday in Europe in May for under 2000 EUR\n1. I need specific flight and hotel recommendations.\n2. I want the destination to be warm.\n3. I want to have a beach nearby the hotel.\nI live in Germany.</code></pre><p>これが最終的な結果です（ループ5回後）：</p><figure class=\"kg-card kg-code-card\"><pre><code class=\"language-markdown\">**3-Day Crete Holiday Plan (Total ≈ €600-800)**\n\n✈️ *Flights (From Frankfurt):*  \n- Skyscanner: €154 round trip (May 2025 dates)  \n  Source: &lt;https://www.skyscanner.com/routes/fran/her/frankfurt-to-crete-heraklion.html&gt;  \n- Backup: Eurowings €180 round trip  \n\n🏨 *Beachfront Hotels:*  \n1. **Georgioupolis Beach Hotel**  \n   - Direct beach access, bike rentals €10  \n   - Source: &lt;https://www.tripadvisor.com/HotelsList-Crete-Beachfront-Cheap-Hotels-zfp13280541.html&gt;  \n\n2. **JT Apartments**  \n   - €57/night, 9.5/10 rating, 5-min walk to beach  \n   - Source: &lt;https://www.booking.com/region/gr/crete.html&gt;  \n\n3. **FNK Apartments**  \n   - Sea views, 9.6/10 rating  \n\n💰 *Budget Breakdown:*  \n- Flights: €154  \n- Hotel (3 nights): €171-250  \n- Remaining: €1,600+ for meals/activities  \n\n*Note:* All hotels are &lt;5 mins from beaches. Crete averages 25°C in May (Source: TravelSupermarket).\n</code></pre><figcaption><p><span style=\"white-space: pre-wrap;\">休暇検索タスクの結果（5回のイテレーション後）</span></p></figcaption></figure><p>この回答は正当に見えます。しかし、本当にそうでしょうか？モデルは幻覚を見ることで知られており、複数の部品が動くシステムでは、何かが間違う可能性が高いです。R1の出力のいくつかの詳細を検証してみましょう：</p><h3 id=\"destination-and-total-budget\">目的地と総予算</h3><p>各項目の計算は全て合計が合います（各項目が正確かどうかは後で詳しく見ていきます）。結局のところ、R1は数学の問題で訓練されました。目的地も確認できます。クレタ島は人気のある場所です。</p><h3 id=\"flights\">フライト</h3><p>フライト料金はほぼ合計が合いますが、どこが間違っているか見てみましょう。まず、フランクフルトからヘラクリオンへの2025年5月の往復の実際の Skyscanner の価格は次の通りです：</p><figure class=\"kg-card kg-image-card kg-card-hascaption\"><img src=\"https://jina-ai-gmbh.ghost.io/content/images/2025/03/image-25.png\" class=\"kg-image\" alt=\"\" loading=\"lazy\" width=\"2000\" height=\"2384\" srcset=\"https://jina-ai-gmbh.ghost.io/content/images/size/w600/2025/03/image-25.png 600w, https://jina-ai-gmbh.ghost.io/content/images/size/w1000/2025/03/image-25.png 1000w, https://jina-ai-gmbh.ghost.io/content/images/size/w1600/2025/03/image-25.png 1600w, https://jina-ai-gmbh.ghost.io/content/images/2025/03/image-25.png 2048w\" sizes=\"(min-width: 720px) 720px\"><figcaption><span style=\"white-space: pre-wrap;\">2025年5月のフランクフルト-ヘラクリオン間フライトの実際の Skyscanner 検索結果</span></figcaption></figure><p>価格は全て200 EUR前後で、約束された往復154 EURではありません！しかし、このエラーはどこから来たのでしょうか？ログを見ると、ラウンド3で関連するメモリブロックが追加されていました：</p><figure class=\"kg-card kg-code-card\"><pre><code class=\"language-json\">{\"operation\": \"add\", \"content\": \"Crete flight options: Eurowings €89.99* one-way ...\"}</code></pre><figcaption><p><span style=\"white-space: pre-wrap;\">ドイツ-クレタ間フライトに関連するメモリブロック</span></p></figcaption></figure><p>このブロックは添付された検索結果から推測されたようです：</p><figure class=\"kg-card kg-code-card\"><pre><code class=\"language-markdown\">Source 1️: search: Cheapest flights from Germany to Crete May 2025\nResult:\n```\n... other results ...\nTitle: Are you a person or a robot?\nURL Source: https://www.skyscanner.com/routes/fran/her/frankfurt-to-crete-heraklion.html\nDescription: Book a one-way ticket from Frankfurt to Heraklion Airport from $78 or travel \nreturn from just $154. The prices shown are based on availability and could change ...\n```</code></pre><figcaption><p><span style=\"white-space: pre-wrap;\">ドイツ-クレタ間フライトの検索結果</span></p></figcaption></figure><p>モデルは結果を確認するためにこのウェブページをスクレイピングしようとしませんでしたが、それは違いを生まなかったかもしれません。しかし、少なくとも検索結果に「5月」という期間が含まれていないことに気付くべきでした。</p><h3 id=\"hotel\">ホテル</h3><p>ホテルは確認できますが、いくつかの改善点が見つかりました。まず、モデルが Georgioupolis Beach Hotel と FNK Apartments の価格を見つけることにもっと努力を払うべきでした - 他の情報は提供していますが、残念ながら価格が欠けています。これが何を意味するのか、ホテルの推薦に使用された<a href=\"https://www.booking.com/region/gr/crete.html\">URL</a>のスクレイピング結果の生データを見てみましょう。最初と最後の結果の価格しか表示されておらず、真ん中の3つは省略されています：</p><figure class=\"kg-card kg-code-card\"><pre><code class=\"language-markdown\">ソース 3️: スクレイプ: https://www.booking.com/region/gr/crete.html\n結果:\n```\nもっと表示 閉じる\n\nMoritz ドイツ\n\n*   ### [JT Apartments](https://www.booking.com/hotel/gr/jt-apatments.html?label=gen173nr-1FCAYoXEIFY3JldGVIM1gEaJUCiAEBmAExuAEZyAEM2AEB6AEB-AECiAIBqAIDuALSvqC-BsACAdICJDc5ZWE5ZDJkLTI2ZWEtNGNiMS04MzNlLTJhNWIyMGI5Y2M3NdgCBeACAQ&amp;sid=f21cdd5fe9eb08dcac7d3a0304f9ccc9)\n\nキッサモス\n\n1泊 $57 から\n\n9.5 特exceptional 313件のレビュー\n\nJT Apartments への滞在を強くお勧めします。アパートメントに入った時、素晴らしい驚きがありました。すべてが完備されていました。周辺は静かで、近くにスーパーマーケットがあります。ビーチまで徒歩圏内です。クレタ島で最も美しいビーチを訪れたい方にとって、絶好のロケーションです。おかげで私たちの滞在は夢見ていた通りになりました :)\n\nもっと表示 閉じる\n\nKatarzyna ポーランド\nもっと表示 閉じる\n\nAitor ドイツ\n\n*   ### [FNK Apartments with Sea View](https://www.booking.com/hotel/gr/f-amp-k-apartments.html?label=gen173nr-1FCAYoXEIFY3JldGVIM1gEaJUCiAEBmAExuAEZyAEM2AEB6AEB-AECiAIBqAIDuALSvqC-BsACAdICJDc5ZWE5ZDJkLTI2ZWEtNGNiMS04MzNlLTJhNWIyMGI5Y2M3NdgCBeACAQ&amp;sid=f21cdd5fe9eb08dcac7d3a0304f9ccc9)\n\nアギア・ペラギア\n\n9.6 特exceptional 64件のレビュー \n\n私たちは1週間クレタ島に滞在しました。その間、FnK Apartments に泊まりました。Froso と Konstantinos は非常にフレンドリーで素晴らしいホストでした。質問や要望があれば、いつでも対応してくれました。アパートメント自体はアギア・ペラギアと周辺の入り江の美しい眺め（そして美しい日の出も）があります。FnK Apartments を強くお勧めします！\n\nもっと表示 閉じる\n\nMoritz ドイツ\nもっと表示 閉じる\n\nmary アメリカ合衆国\n\n*   ### [Artemis Hotel Apartments](https://www.booking.com/hotel/gr/artemis-hersonisos.html?label=gen173nr-1FCAYoXEIFY3JldGVIM1gEaJUCiAEBmAExuAEZyAEM2AEB6AEB-AECiAIBqAIDuALSvqC-BsACAdICJDc5ZWE5ZDJkLTI2ZWEtNGNiMS04MzNlLTJhNWIyMGI5Y2M3NdgCBeACAQ&amp;sid=f21cdd5fe9eb08dcac7d3a0304f9ccc9)\n\nリメナス・ヘルソニソス、ヘルソニソス\n\n9.0 すばらしい 419件のレビュー\n\n歓迎され、友人のように扱われ、何事にも助けてもらえると感じたい方には、このホテルをお勧めします。温かく非常に個人的な対応をしてくれた Konstantine に心から感謝します！次回クレタ島を訪れる際も、ぜひ Artemis Hotel に滞在したいと思います！\n\nもっと表示 閉じる\n\nIrina イスラエル\nもっと表示 閉じる\n\nAnn Marie アイルランド\n\n*   ### [Pinelopi Hotel](https://www.booking.com/hotel/gr/pinelopi.html?label=gen173nr-1FCAYoXEIFY3JldGVIM1gEaJUCiAEBmAExuAEZyAEM2AEB6AEB-AECiAIBqAIDuALSvqC-BsACAdICJDc5ZWE5ZDJkLTI2ZWEtNGNiMS04MzNlLTJhNWIyMGI5Y2M3NdgCBeACAQ&amp;sid=f21cdd5fe9eb08dcac7d3a0304f9ccc9)\n\nプラタネス\n\n7.8 良い 198件のレビュー\n\nビーチに近い絶好のロケーション、素晴らしいタベルナがあり、車での観光にも便利な場所です。静かなエリアで、素晴らしい休暇を過ごすのに最適です。必要なものがすべて揃った広々とした客室。価格に見合う価値があります。プールエリアは素晴らしく、一日中くつろげます。ホテル近くの駐車場は完璧でした。次回クレタ島を訪れる際も、必ず Pinelopi Hotel に戻ってきます。\n\nもっと表示 閉じる\n\nRita ルーマニア\nもっと表示 閉じる\n\nKatarzyna ポーランド\n\n*   ### [Elizabeth Suites](https://www.booking.com/hotel/gr/elizabeth-suites.html?label=gen173nr-1FCAYoXEIFY3JldGVIM1gEaJUCiAEBmAExuAEZyAEM2AEB6AEB-AECiAIBqAIDuALSvqC-BsACAdICJDc5ZWE5ZDJkLTI2ZWEtNGNiMS04MzNlLTJhNWIyMGI5Y2M3NdgCBeACAQ&amp;sid=f21cdd5fe9eb08dcac7d3a0304f9ccc9)\n\nカト・ダラツォ\n\n1泊 $74 から\n\n9.1 すばらしい 86件のレビュー\n\n素晴らしい滞在でした。オーナーの Epas は常に笑顔で、とても親切でしたし、特に Anna などのスタッフも素敵でした。朝食を2日ほど取りましたが、十分すぎるほどでした。アパートメントはビーチやレストランへのアクセスに最適な場所にありました。Elizabeth Suites は私たちの初めてのクレタ島での休暇を素晴らしいものにしてくれました 😊\n\nもっと表示 閉じる\n\nJean イギリス\n```</code></pre><figcaption><p><span style=\"white-space: pre-wrap;\">booking.com のクレタ島ホテル一覧の生スクレイプ結果</span></p></figcaption></figure><p>次に、Reranker を事前定義された <code>top_n</code> が 5 の結果で使用している際に追加の問題を特定しました。スクレイプしたページには5件以上の関連結果が含まれていることが判明しました。各結果の関連性スコアを実際にチェックし、上位5件（または任意の数）だけを取るのではなく、これに対処することができました。しかし、理想的な再ランク付けの設定はタスクによって異なります。この問題に対するより良い対処方法は、スクレイプしたページ全体を使用することですが、残念ながら R1 のコンテキスト長の制限により不可能です。</p><h3 id=\"overall-performance-and-potential-improvements\">全体的なパフォーマンスと改善の可能性</h3><p>モデルは最初は順調でしたが、特に指示されない限り、戦略を切り替えたり複雑な計画を立てたりすることはほとんどありませんでした。R1 は数学やコーディングの問題（特に訓練された分野）にはこれらのアプローチを自然に採用しますが、検索タスクには同じ推論を適用しません。この制限に対処するためにプロンプトをさらに微調整（または複数のプロンプトを使用）することもできましたが、それは私たちの主な目標ではありませんでした。</p><p>また、R1 が時間に敏感な情報を適切に扱っていないことも確認されました。要するに、検索結果が明示的に誤った日付に言及していない場合、モデルはさらなる検証なしにその情報が有効であると仮定します。例えば、5月1日のフライトを計画する場合：</p><ul><li>ドイツからクレタ島まで $80 5月1日: <strong>正確</strong> - モデルはこの情報を信頼できます。</li><li>ドイツからクレタ島まで $80 1月1日: <strong>不正確</strong> - モデルは適切に識別し、この情報を破棄します。</li><li>ドイツからクレタ島まで $80: <strong>誤検知</strong> - 日付が指定されていない場合、モデルは情報を検証せず、誤って有効と仮定します。</li></ul><p>このプロジェクトを継続する場合、以下のような潜在的な改善を検討できます：</p><ul><li>メモリブロック数を追跡し、状態が大きくなりすぎた場合にエントリを<strong>要約するようモデルに指示する</strong>。</li><li>探索を終了して質問に回答する前に、<strong>すべての手がかりを使い切るよう</strong>モデルに指示する。</li><li><strong>時間に敏感な情報の検証</strong>を強調する。</li><li>検索ツールが返した URL をスクレイプして、モデルが<strong>結果をダブルチェックする</strong>ようにする。</li><li><strong>より大きなコンテキストウィンドウをサポートする将来の推論モデル</strong>でシステムをテストする。ただし、これには異なるモデル用にプロンプトを適応させるための大幅なリファクタリングとテストが必要になります。</li></ul><h2 id=\"conclusion\">結論</h2><p>R1 のリリースからそれほど時間が経っていないにもかかわらず、状況は大きく進化しています。驚くほど低コスト（中には $5 程度）で推論モデルを訓練するプロジェクトが登場しています。この民主化により、専門モデルの訓練がこれまで以上にアクセスしやすくなっています。R1 での実験は、複雑な検索タスクに取り組むためのツールで推論重視の LLM をどのように強化できるかを引き続き探求する上で、有用なベースラインを提供しています。</p><p>休暇プランニングの例は有望な結果を示しましたが（特に短期デモプロジェクトとしては）、数学やコーディングでの強みと比較して、検索やメモリタスクの処理における R1 の限界も明らかになりました。システムは予算内で旅行計画を作成することに成功しましたが、時間に敏感な情報の検証や利用可能なすべてのオプションの徹底的な探索などの面で不十分でした。これは、モデルのトレーニングの焦点と異なるドメインへの応用との間のギャップを浮き彫りにしています。</p>",
  "comment_id": "67dd5037143bda0001036423",
  "feature_image": "https://jina-ai-gmbh.ghost.io/content/images/2025/04/Heading--92-.png",
  "featured": false,
  "visibility": "public",
  "created_at": "2025-03-21T12:40:39.000+01:00",
  "updated_at": "2025-04-01T09:38:45.000+02:00",
  "published_at": "2025-04-01T09:38:45.000+02:00",
  "custom_excerpt": "Standard LLM or reasoning model, which is better for DeepSearch? In this post, we explored using DeepSeek-R1 in the DeepSearch implementation for choosing the next action.",
  "codeinjection_head": null,
  "codeinjection_foot": null,
  "custom_template": null,
  "canonical_url": null,
  "authors": [
    {
      "id": "64ae64a4733bc60001949ca4",
      "name": "Andrei Ungureanu",
      "slug": "andrei",
      "profile_image": "https://jina-ai-gmbh.ghost.io/content/images/2023/07/Me.jpg",
      "cover_image": null,
      "bio": "Software / AI Engineer, with a passion for content creation.",
      "website": null,
      "location": "Beijing, China",
      "facebook": null,
      "twitter": null,
      "meta_title": null,
      "meta_description": null,
      "url": "https://jina-ai-gmbh.ghost.io/author/andrei/"
    },
    {
      "id": "632ade4a3e4e55003d525971",
      "name": "Alex C-G",
      "slug": "alexcg",
      "profile_image": "https://jina-ai-gmbh.ghost.io/content/images/2022/09/alex.jpg",
      "cover_image": "https://jina-ai-gmbh.ghost.io/content/images/2022/11/twitter_banner.jpg",
      "bio": "Open-source Evangelist @ Jina AI. Old, grim, and full of Vim",
      "website": null,
      "location": "Berlin, Germany",
      "facebook": null,
      "twitter": "@alexcg",
      "meta_title": null,
      "meta_description": null,
      "url": "https://jina-ai-gmbh.ghost.io/author/alexcg/"
    }
  ],
  "tags": [
    {
      "id": "634a1a8ccebfc1003d8ab706",
      "name": "Tech Blog",
      "slug": "tech-blog",
      "description": null,
      "feature_image": null,
      "visibility": "public",
      "og_image": null,
      "og_title": null,
      "og_description": null,
      "twitter_image": null,
      "twitter_title": null,
      "twitter_description": null,
      "meta_title": null,
      "meta_description": null,
      "codeinjection_head": null,
      "codeinjection_foot": null,
      "canonical_url": null,
      "accent_color": null,
      "url": "https://jina-ai-gmbh.ghost.io/tag/tech-blog/"
    }
  ],
  "primary_author": {
    "id": "64ae64a4733bc60001949ca4",
    "name": "Andrei Ungureanu",
    "slug": "andrei",
    "profile_image": "https://jina-ai-gmbh.ghost.io/content/images/2023/07/Me.jpg",
    "cover_image": null,
    "bio": "Software / AI Engineer, with a passion for content creation.",
    "website": null,
    "location": "Beijing, China",
    "facebook": null,
    "twitter": null,
    "meta_title": null,
    "meta_description": null,
    "url": "https://jina-ai-gmbh.ghost.io/author/andrei/"
  },
  "primary_tag": {
    "id": "634a1a8ccebfc1003d8ab706",
    "name": "Tech Blog",
    "slug": "tech-blog",
    "description": null,
    "feature_image": null,
    "visibility": "public",
    "og_image": null,
    "og_title": null,
    "og_description": null,
    "twitter_image": null,
    "twitter_title": null,
    "twitter_description": null,
    "meta_title": null,
    "meta_description": null,
    "codeinjection_head": null,
    "codeinjection_foot": null,
    "canonical_url": null,
    "accent_color": null,
    "url": "https://jina-ai-gmbh.ghost.io/tag/tech-blog/"
  },
  "url": "https://jina-ai-gmbh.ghost.io/podcast/using-deepseek-r1-reasoning-model-in-deepsearch/",
  "excerpt": "DeepSearch には標準的な LLM と推論モデルのどちらが適しているのか？この投稿では、次のアクションを選択する DeepSearch の実装において DeepSeek-R1 を使用することについて検討しました。",
  "reading_time": 17,
  "access": true,
  "comments": false,
  "og_image": null,
  "og_title": null,
  "og_description": null,
  "twitter_image": null,
  "twitter_title": null,
  "twitter_description": null,
  "meta_title": null,
  "meta_description": null,
  "email_subject": null,
  "frontmatter": null,
  "feature_image_alt": null,
  "feature_image_caption": null
}