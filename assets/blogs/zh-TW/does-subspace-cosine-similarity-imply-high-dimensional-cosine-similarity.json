{
  "slug": "does-subspace-cosine-similarity-imply-high-dimensional-cosine-similarity",
  "id": "65af98d28da8040001e17008",
  "uuid": "d8fdbdb8-0820-42bf-aab7-6751ae6141e1",
  "title": "子空間餘弦相似度是否意味著高維度餘弦相似度？",
  "html": "<div class=\"kg-card kg-callout-card kg-callout-card-blue\"><div class=\"kg-callout-emoji\">💡</div><div class=\"kg-callout-text\">2024 年 1 月 25 日，OpenAI 發布了<a href=\"https://openai.com/blog/new-embedding-models-and-api-updates?ref=jina-ai-gmbh.ghost.io\">一個新的 embedding 模型</a>，其中包含一個名為<i><b><strong class=\"italic\" style=\"white-space: pre-wrap;\">「shortening」</strong></b></i>的新功能，該功能允許開發者在不影響 embedding 有效表達概念能力的前提下，從序列末尾裁剪數值。本文將深入探討這項創新背後的理論基礎和合理性。</div></div><p>思考這個問題：當在高維空間中測量 embedding 向量的餘弦相似度時，它們在低維子空間的相似度如何影響整體相似度？這是一個直接的比例關係，還是高維資料的情況更為複雜？</p><p>更具體地說，<strong>向量在前 256 維的高度相似是否能確保它們在完整的 768 維中也具有高度相似性？</strong>相反地，如果向量在某些維度上有顯著差異，是否意味著整體相似度較低？這些不僅僅是理論思考，它們對向量檢索、資料庫索引和 RAG 系統的效能都至關重要。</p><p>開發者經常依賴經驗法則，假設子空間的高相似度等同於整體的高相似度，或者某一維度的顯著差異會大幅影響整體相似度。問題是：這些啟發式方法是建立在堅實的理論基礎上，還是僅僅是為了方便而做出的假設？</p><p>本文將深入探討這些問題，研究子空間相似度與整體向量相似度之間的理論關係及其實際應用。</p><h2 id=\"bounding-the-cosine-similarity\">餘弦相似度的界限</h2><p>給定向量 $\\mathbf{A}, \\mathbf{B}\\in \\mathbb{R}^d$，我們將它們分解為 $\\mathbf{A}=[\\mathbf{A}_1, \\mathbf{A}_2]$ 和 $\\mathbf{B}=[\\mathbf{B}_1, \\mathbf{B}_2]$，其中 $\\mathbf{A}_1,\\mathbf{B}_1\\in\\mathbb{R}^m$ 且 $\\mathbf{A}_2,\\mathbf{B}_2\\in\\mathbb{R}^n$，且 $m+n=d$。</p><p>在子空間 $\\mathbb{R}^m$ 中的餘弦相似度為 $\\cos(\\mathbf{A}_1, \\mathbf{B}_1)=\\frac{\\mathbf{A}_1\\cdot\\mathbf{B}_1}{\\|\\mathbf{A}_1\\|\\|\\mathbf{B}_1\\|}$；同樣地，在子空間 $\\mathbb{R}^n$ 中的相似度為 $\\cos(\\mathbf{A}_2, \\mathbf{B}_2)=\\frac{\\mathbf{A}_2\\cdot\\mathbf{B}_2}{\\|\\mathbf{A}_2\\|\\|\\mathbf{B}_2\\|}$。</p><p>在原始空間 $\\mathbb{R}^d$ 中，餘弦相似度定義為：$$\\begin{align*}\\cos(\\mathbf{A},\\mathbf{B})&amp;=\\frac{\\mathbf{A}\\cdot\\mathbf{B}}{\\|\\mathbf{A}\\|\\|\\mathbf{B}\\|}\\\\&amp;=\\frac{\\mathbf{A}_1\\cdot\\mathbf{B}_1+\\mathbf{A}_2\\cdot\\mathbf{B}_2}{\\sqrt{\\|\\mathbf{A}_1\\|^2+\\|\\mathbf{A}_2\\|^2}\\sqrt{\\|\\mathbf{B}_1\\|^2+\\|\\mathbf{B}_2\\|^2}}\\\\&amp;=\\frac{\\cos(\\mathbf{A}_1, \\mathbf{B}_1)\\|\\mathbf{A}_1\\|\\|\\mathbf{B}_1\\|+\\cos(\\mathbf{A}_2, \\mathbf{B}_2)\\|\\mathbf{A}_2\\|\\|\\mathbf{B}_2\\|}{\\sqrt{\\|\\mathbf{A}_1\\|^2+\\|\\mathbf{A}_2\\|^2}\\sqrt{\\|\\mathbf{B}_1\\|^2+\\|\\mathbf{B}_2\\|^2}}\\end{align*}$$</p><p>現在，令 $s := \\max(\\cos(\\mathbf{A}_1, \\mathbf{B}_1), \\cos(\\mathbf{A}_2, \\mathbf{B}_2))$。則我們有：$$\\begin{align*}\\cos(\\mathbf{A},\\mathbf{B})&amp;\\leq\\frac{s\\|\\mathbf{A}_1\\|\\|\\mathbf{B}_1\\|+s\\|\\mathbf{A}_2\\|\\|\\mathbf{B}_2\\|}{\\sqrt{\\|\\mathbf{A}_1\\|^2+\\|\\mathbf{A}_2\\|^2}\\sqrt{\\|\\mathbf{B}_1\\|^2+\\|\\mathbf{B}_2\\|^2}}\\\\&amp;=\\frac{\\|\\mathbf{A}_1\\|\\|\\mathbf{B}_1\\|+\\|\\mathbf{A}_2\\|\\|\\mathbf{B}_2\\|}{\\sqrt{\\|\\mathbf{A}_1\\|^2+\\|\\mathbf{A}_2\\|^2}\\sqrt{\\|\\mathbf{B}_1\\|^2+\\|\\mathbf{B}_2\\|^2}}\\cdot s\\\\&amp;=\\cos(\\underbrace{[\\|\\mathbf{A}_1\\|, \\|\\mathbf{A}_2\\|]}_{\\mathbb{R}^2}, \\underbrace{[\\|\\mathbf{B}_1\\|, \\|\\mathbf{B}_2\\|]}_{\\mathbb{R}^2})\\cdot s\\\\&amp;\\leq 1\\cdot s \\\\&amp;= \\max(\\cos(\\mathbf{A}_1, \\mathbf{B}_1), \\cos(\\mathbf{A}_2, \\mathbf{B}_2))\\end{align*}$$</p><p>證明完畢。</p><p>注意，在證明的最後一步中，我們利用了餘弦相似度總是小於等於 1 的特性。這構成了我們的上界。同樣地，我們可以證明 \\(\\cos(\\mathbf{A},\\mathbf{B})\\) 的下界為：</p><p>\\[ \\cos(\\mathbf{A},\\mathbf{B}) \\geq t \\cdot \\cos([\\|\\mathbf{A}_1\\|, \\|\\mathbf{A}_2\\|], [\\|\\mathbf{B}_1\\|, \\|\\mathbf{B}_2\\|]) \\]，其中 $t:= \\min(\\cos(\\mathbf{A}_1, \\mathbf{B}_1), \\cos(\\mathbf{A}_2, \\mathbf{B}_2))$。</p><p>注意，對於下界，我們不能急於得出 \\(\\cos(\\mathbf{A},\\mathbf{B}) \\geq t\\) 的結論。這是因為餘弦函數的範圍在 \\([-1, 1]\\) 之間。由於這個範圍，我們無法建立比平凡值 -1 更緊的下界。</p><p>因此總結來說，我們有以下寬鬆的界限：$$ -1\\leq\\cos(\\mathbf{A},\\mathbf{B})\\leq\\max(\\cos(\\mathbf{A}_1, \\mathbf{B}_1), \\cos(\\mathbf{A}_2, \\mathbf{B}_2)).$$ 和一個更緊的界限 \\[\\begin{align*}  \\gamma \\cdot t\\leq&amp;\\cos(\\mathbf{A}, \\mathbf{B}) \\leq\\gamma\\cdot s\\\\\\gamma \\cdot \\min(\\cos(\\mathbf{A}_1, \\mathbf{B}_1), \\cos(\\mathbf{A}_2, \\mathbf{B}_2)) \\leq &amp;\\cos(\\mathbf{A}, \\mathbf{B}) \\leq \\gamma \\cdot \\max(\\cos(\\mathbf{A}_1, \\mathbf{B}_1), \\cos(\\mathbf{A}_2, \\mathbf{B}_2))\\end{align*}\\]，其中 $\\gamma = \\cos([\\|\\mathbf{A}_1\\|, \\|\\mathbf{A}_2\\|], [\\|\\mathbf{B}_1\\|, \\|\\mathbf{B}_2\\|]) $。</p><h3 id=\"connection-to-johnson%E2%80%93lindenstrauss-lemma\">與 Johnson–Lindenstrauss 引理的關聯</h3><p>JL 引理指出，對於任意 \\(0 &lt; \\epsilon &lt; 1\\) 和任意有限點集 \\( S \\) 在 \\( \\mathbb{R}^d \\) 中，存在一個映射 \\( f: \\mathbb{R}^d \\rightarrow \\mathbb{R}^k \\)（其中 \\( k = O(\\epsilon^{-2} \\log |S|) \\)）使得對於所有 \\( \\mathbf{u}, \\mathbf{v} \\in S \\)，歐式距離大致得以保留：<br><br>\\[(1 - \\epsilon) \\|\\mathbf{u} - \\mathbf{v}\\|^2 \\leq \\|f(\\mathbf{u}) - f(\\mathbf{v})\\|^2 \\leq (1 + \\epsilon) \\|\\mathbf{u} - \\mathbf{v}\\|^2\\]</p><figure class=\"kg-card kg-bookmark-card\"><a class=\"kg-bookmark-container\" href=\"https://en.wikipedia.org/wiki/Johnson%E2%80%93Lindenstrauss_lemma?ref=jina-ai-gmbh.ghost.io\"><div class=\"kg-bookmark-content\"><div class=\"kg-bookmark-title\">Johnson–Lindenstrauss lemma - Wikipedia</div><div class=\"kg-bookmark-description\"></div><div class=\"kg-bookmark-metadata\"><img class=\"kg-bookmark-icon\" src=\"https://en.wikipedia.org/static/apple-touch/wikipedia.png\" alt=\"\"><span class=\"kg-bookmark-author\">Wikimedia Foundation, Inc.</span><span class=\"kg-bookmark-publisher\">Contributors to Wikimedia projects</span></div></div><div class=\"kg-bookmark-thumbnail\"><img src=\"https://wikimedia.org/api/rest_v1/media/math/render/svg/7f173a9fe1686cca4e497db35b4f908926294930\" alt=\"\"></div></a></figure><p>為了使 $f$ 像子空間選擇一樣工作，我們可以使用對角矩陣進行投影，例如一個 \\(5 \\times 3\\) 矩陣 \\(f\\)，儘管不是隨機的（注意，JL 引理的典型表述涉及通常使用從高斯分布中抽取的隨機矩陣的線性變換）。例如，如果我們想要從五維向量空間中保留第 1、3 和第 5 維，矩陣 \\(f\\) 可以設計如下：\\[f = \\begin{bmatrix}1 &amp; 0 &amp; 0 \\\\0 &amp; 0 &amp; 0 \\\\0 &amp; 1 &amp; 0 \\\\0 &amp; 0 &amp; 0 \\\\0 &amp; 0 &amp; 1\\end{bmatrix}\\]<br>然而，通過將 $f$ 限定為對角矩陣，我們限制了可用於投影的函數類別。JL 引理保證了在更廣泛的線性變換類別中存在合適的 $f$，但當我們將 $f$ 限制為對角矩陣時，在這個受限的類別中可能不存在適合應用 JL 引理界限的 $f$。</p><h2 id=\"validating-the-bounds\">驗證界限</h2><p>為了經驗性地探索高維向量空間中餘弦相似度的理論界限，我們可以使用蒙特卡羅模擬。這種方法允許我們生成大量隨機向量對，計算它們在原始空間和子空間中的相似度，然後評估理論上界和下界在實踐中的適用性。</p><p>以下 Python 程式碼片段實現了這個概念。它隨機生成高維空間中的向量對並計算它們的餘弦相似度。然後，它將每個向量分為兩個子空間，計算每個子空間內的餘弦相似度，並根據子空間相似度評估全維度餘弦相似度的上界和下界。</p><figure class=\"kg-card kg-code-card\"><pre><code class=\"language-python\">import numpy as np\n\n\ndef compute_cosine_similarity(U, V):\n    # Normalize the rows to unit vectors\n    U_norm = U / np.linalg.norm(U, axis=1, keepdims=True)\n    V_norm = V / np.linalg.norm(V, axis=1, keepdims=True)\n    # Compute pairwise cosine similarity\n    return np.sum(U_norm * V_norm, axis=1)\n\n\n# Generate random data\nnum_points = 5000\nd = 1024\nA = np.random.random([num_points, d])\nB = np.random.random([num_points, d])\n\n# Compute cosine similarity between A and B\ncos_sim = compute_cosine_similarity(A, B)\n\n# randomly divide A and B into subspaces\nm = np.random.randint(1, d)\nA1 = A[:, :m]\nA2 = A[:, m:]\nB1 = B[:, :m]\nB2 = B[:, m:]\n\n# Compute cosine similarity in subspaces\ncos_sim1 = compute_cosine_similarity(A1, B1)\ncos_sim2 = compute_cosine_similarity(A2, B2)\n\n# Find the element-wise maximum and minimum of cos_sim1 and cos_sim2\ns = np.maximum(cos_sim1, cos_sim2)\nt = np.minimum(cos_sim1, cos_sim2)\n\nnorm_A1 = np.linalg.norm(A1, axis=1)\nnorm_A2 = np.linalg.norm(A2, axis=1)\nnorm_B1 = np.linalg.norm(B1, axis=1)\nnorm_B2 = np.linalg.norm(B2, axis=1)\n\n# Form new vectors in R^2 from the norms\nnorm_A_vectors = np.stack((norm_A1, norm_A2), axis=1)\nnorm_B_vectors = np.stack((norm_B1, norm_B2), axis=1)\n\n# Compute cosine similarity in R^2\ngamma = compute_cosine_similarity(norm_A_vectors, norm_B_vectors)\n\n# print some info and validate the lower bound and upper bound\nprint('d: %d\\n'\n      'm: %d\\n'\n      'n: %d\\n'\n      'avg. cosine(A,B): %f\\n'\n      'avg. upper bound: %f\\n'\n      'avg. lower bound: %f\\n'\n      'lower bound satisfied: %s\\n'\n      'upper bound satisfied: %s' % (\n          d, m, (d - m), np.mean(cos_sim), np.mean(s), np.mean(gamma * t), np.all(s &gt;= cos_sim),\n          np.all(gamma * t &lt;= cos_sim)))\n</code></pre><figcaption><p><span style=\"white-space: pre-wrap;\">用於驗證餘弦相似度邊界的蒙特卡洛驗證器</span></p></figcaption></figure><figure class=\"kg-card kg-code-card\"><pre><code class=\"language-output\">d: 1024\nm: 743\nn: 281\navg. cosine(A,B): 0.750096\navg. upper bound: 0.759080\navg. lower bound: 0.741200\nlower bound satisfied: True\nupper bound satisfied: True</code></pre><figcaption><p><span style=\"white-space: pre-wrap;\">我們的蒙特卡洛驗證器的範例輸出。需要注意的是，</span><code spellcheck=\"false\" style=\"white-space: pre-wrap;\"><span>lower/upper bound satisfied</span></code><span style=\"white-space: pre-wrap;\">條件是針對每個向量單獨檢查的。同時，</span><code spellcheck=\"false\" style=\"white-space: pre-wrap;\"><span>avg. lower/upper bound</span></code><span style=\"white-space: pre-wrap;\">提供了與這些邊界相關的統計概覽，但並不直接影響驗證過程。</span></p></figcaption></figure><h2 id=\"understanding-the-bounds\">理解邊界</h2><p>簡而言之，當比較兩個高維向量時，整體相似度介於其子空間最佳和最差相似度之間，並根據這些子空間在整體方案中的大小或重要性進行調整。這就是高維空間中餘弦相似度邊界所直觀表示的：根據各部分的相對大小或重要性，在最相似和最不相似部分之間取得平衡。</p><figure class=\"kg-card kg-image-card kg-card-hascaption\"><img src=\"https://jina-ai-gmbh.ghost.io/content/images/2024/01/Explore-image-storytelling-beyond-pixels--35-.png\" class=\"kg-image\" alt=\"在黑色背景上帶有標籤部分的兩支觸控筆筆帽和筆身的比較圖\" loading=\"lazy\" width=\"1200\" height=\"627\" srcset=\"https://jina-ai-gmbh.ghost.io/content/images/size/w600/2024/01/Explore-image-storytelling-beyond-pixels--35-.png 600w, https://jina-ai-gmbh.ghost.io/content/images/size/w1000/2024/01/Explore-image-storytelling-beyond-pixels--35-.png 1000w, https://jina-ai-gmbh.ghost.io/content/images/2024/01/Explore-image-storytelling-beyond-pixels--35-.png 1200w\" sizes=\"(min-width: 720px) 720px\"><figcaption><span style=\"white-space: pre-wrap;\">每支筆都有兩個主要組件：筆身和筆帽。</span></figcaption></figure><p>想像你正試圖比較兩個多部件物體（比如說，兩支精美的筆）的整體相似度。每支筆都有兩個主要組件：筆身和筆帽。我們要確定的是整支筆（包括筆身和筆帽）的相似度：</p><h3 id=\"upper-bound-gamma-cdot-s\">上界 ($\\gamma \\cdot s$)</h3><p>將 $s$ 理解為筆的對應部件之間的最佳匹配。如果筆帽很相似但筆身不相似，$s$ 就是筆帽的相似度。</p><p>而 $\\gamma$ 則是基於每個部分的大小（或重要性）的縮放因子。如果一支筆有很長的筆身和短的筆帽，而另一支筆有短的筆身和長的筆帽，$\\gamma$ 就會根據這些比例差異調整整體相似度。</p><p>上界告訴我們，無論某些部分多麼相似，整體相似度都不能超過這個經過比例因子縮放的\"最佳部分相似度\"。</p><h3 id=\"lower-bound-gamma-cdot-t\">下界 ($\\gamma \\cdot t$)</h3><p>這裡，$t$ 是最不匹配部分的相似度。如果筆身差異很大但筆帽相似，$t$ 就反映了筆身的相似度。</p><p>同樣，$\\gamma$ 根據每個部分的比例進行縮放。</p><p>下界意味著考慮每個部分的比例後，整體相似度不會比這個\"最差部分相似度\"更差。</p><h2 id=\"implications-of-the-bounds\">邊界的含義</h2><p>對於使用嵌入、向量搜索、檢索或資料庫的軟體工程師來說，理解這些邊界具有實際意義，特別是在處理高維數據時。向量搜索通常涉及在資料庫中找到與給定查詢向量最接近（最相似）的向量，通常使用餘弦相似度作為接近度的度量。我們討論的邊界可以為此類任務使用子空間相似度的有效性和限制提供見解。</p><h3 id=\"using-subspace-similarity-for-ranking\">使用子空間相似度進行排序</h3><p><strong>安全性和準確性</strong>：使用子空間相似度進行排序和檢索 top-k 結果可能是有效的，但需要謹慎。上界表明整體相似度不能超過子空間的最大相似度。因此，如果一對向量在特定子空間中高度相似，它很可能在高維空間中也相似。</p><p><strong>潛在陷阱</strong>：然而，下界表明在一個子空間中相似度低的兩個向量在整體上仍可能相當相似。因此，單純依賴子空間相似度可能會遺漏一些相關結果。</p><h3 id=\"misconceptions-and-cautions\">誤解和注意事項</h3><p><strong>過度估計子空間重要性</strong>：一個常見的誤解是過度估計特定子空間的重要性。雖然在一個子空間中的高相似度是個好的指標，但由於其他子空間的影響，它並不能保證整體相似度高。</p><p><strong>忽略負相似度</strong>：在子空間中餘弦相似度為負的情況下，表示在該維度上存在對立關係。工程師應該注意這些負相似度如何影響整體相似度。</p>",
  "comment_id": "65af98d28da8040001e17008",
  "feature_image": "https://jina-ai-gmbh.ghost.io/content/images/2024/01/Explore-image-storytelling-beyond-pixels--34-.png",
  "featured": true,
  "visibility": "public",
  "created_at": "2024-01-23T11:45:38.000+01:00",
  "updated_at": "2024-01-25T21:34:27.000+01:00",
  "published_at": "2024-01-23T12:22:57.000+01:00",
  "custom_excerpt": "Does high similarity in subspace assure a high overall similarity between vectors? This post examines the theory and practical implications of subspace similarity. ",
  "codeinjection_head": null,
  "codeinjection_foot": null,
  "custom_template": null,
  "canonical_url": null,
  "authors": [
    {
      "id": "633ffc6b393501004d1c8659",
      "name": "Han Xiao",
      "slug": "han",
      "profile_image": "https://jina-ai-gmbh.ghost.io/content/images/2022/10/Untitled-2.png",
      "cover_image": null,
      "bio": "Founder & CEO of Jina AI",
      "website": null,
      "location": null,
      "facebook": null,
      "twitter": "@hxiao",
      "meta_title": null,
      "meta_description": null,
      "url": "https://jina-ai-gmbh.ghost.io/author/han/"
    }
  ],
  "tags": [
    {
      "id": "634a1a8ccebfc1003d8ab706",
      "name": "Tech Blog",
      "slug": "tech-blog",
      "description": null,
      "feature_image": null,
      "visibility": "public",
      "og_image": null,
      "og_title": null,
      "og_description": null,
      "twitter_image": null,
      "twitter_title": null,
      "twitter_description": null,
      "meta_title": null,
      "meta_description": null,
      "codeinjection_head": null,
      "codeinjection_foot": null,
      "canonical_url": null,
      "accent_color": null,
      "url": "https://jina-ai-gmbh.ghost.io/tag/tech-blog/"
    }
  ],
  "primary_author": {
    "id": "633ffc6b393501004d1c8659",
    "name": "Han Xiao",
    "slug": "han",
    "profile_image": "https://jina-ai-gmbh.ghost.io/content/images/2022/10/Untitled-2.png",
    "cover_image": null,
    "bio": "Founder & CEO of Jina AI",
    "website": null,
    "location": null,
    "facebook": null,
    "twitter": "@hxiao",
    "meta_title": null,
    "meta_description": null,
    "url": "https://jina-ai-gmbh.ghost.io/author/han/"
  },
  "primary_tag": {
    "id": "634a1a8ccebfc1003d8ab706",
    "name": "Tech Blog",
    "slug": "tech-blog",
    "description": null,
    "feature_image": null,
    "visibility": "public",
    "og_image": null,
    "og_title": null,
    "og_description": null,
    "twitter_image": null,
    "twitter_title": null,
    "twitter_description": null,
    "meta_title": null,
    "meta_description": null,
    "codeinjection_head": null,
    "codeinjection_foot": null,
    "canonical_url": null,
    "accent_color": null,
    "url": "https://jina-ai-gmbh.ghost.io/tag/tech-blog/"
  },
  "url": "https://jina-ai-gmbh.ghost.io/podcast/does-subspace-cosine-similarity-imply-high-dimensional-cosine-similarity/",
  "excerpt": "子空間中的高度相似性是否能確保向量之間的整體相似性也很高？本文探討子空間相似性的理論和實際應用意涵。",
  "reading_time": 9,
  "access": true,
  "comments": false,
  "og_image": null,
  "og_title": null,
  "og_description": null,
  "twitter_image": null,
  "twitter_title": null,
  "twitter_description": null,
  "meta_title": null,
  "meta_description": null,
  "email_subject": null,
  "frontmatter": null,
  "feature_image_alt": "Diagram illustrating a neural network process with smiley faces and repeated mentions of \"Similar\" on a blackboard-like backg",
  "feature_image_caption": null
}