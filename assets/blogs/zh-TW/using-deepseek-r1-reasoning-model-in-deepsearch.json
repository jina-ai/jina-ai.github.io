{
  "slug": "using-deepseek-r1-reasoning-model-in-deepsearch",
  "id": "67dd5037143bda0001036423",
  "uuid": "3ebc2ba7-b65b-408b-9466-ca902b28756a",
  "title": "在 DeepSearch 中使用 DeepSeek R1 推理模型",
  "html": "<p>在<a href=\"https://jina.ai/news/a-practical-guide-to-implementing-deepsearch-deepresearch\">我們看來，DeepSearch 本質上就是一個大型的 while 迴圈。</a>在最大 token 預算限制下，它不斷地在搜尋、閱讀和思考之間循環，直到找到最佳答案。LLM 的一個關鍵任務是根據當前的記憶狀態決定下一步該採取什麼行動。它應該繼續搜索嗎？閱讀網頁？還是直接回答問題？</p><p>在我們的 <a href=\"https://github.com/jina-ai/node-DeepResearch\">node-deepresearch</a> 實作中，我們使用了一個<em>標準</em> LLM（<code>gemini-2.0-flash</code>）來選擇行動。我們稱之為「標準」，是因為推理過程是通過提示工程明確概述的，然後以序列輸入、序列輸出的方式運作，並將選擇的行動以 JSON 物件形式返回。因此，一個自然的問題出現了：用專門的推理模型替代這個決策步驟是否能提升 DeepSearch 的性能？</p><figure class=\"kg-card kg-image-card kg-card-hascaption\"><img src=\"https://jina-ai-gmbh.ghost.io/content/images/2025/04/Heading--91-.png\" class=\"kg-image\" alt=\"\" loading=\"lazy\" width=\"1200\" height=\"630\" srcset=\"https://jina-ai-gmbh.ghost.io/content/images/size/w600/2025/04/Heading--91-.png 600w, https://jina-ai-gmbh.ghost.io/content/images/size/w1000/2025/04/Heading--91-.png 1000w, https://jina-ai-gmbh.ghost.io/content/images/2025/04/Heading--91-.png 1200w\" sizes=\"(min-width: 720px) 720px\"><figcaption><span style=\"white-space: pre-wrap;\">在我們的 DeepSearch 實作中，大型 while 迴圈的行動決策步驟根據當前上下文和記憶來決定下一步應該做什麼。</span></figcaption></figure><p>在這篇文章中，我們探討使用 <a href=\"https://github.com/deepseek-ai/DeepSeek-R1\">DeepSeek R1</a> 671b 這個推理 LLM 來替代 <code>gemini-2.0-flash</code> 進行這個決策步驟。我們相信 R1 的推理能力將有助於解決在網路搜尋和分析結果時遇到的複雜問題。</p><p>為了測試這個概念，我們讓它執行一個實際的例子：規劃一個全面的三天假期行程，然後評估其表現。執行深度搜尋任務的代理可能會遇到與人類相同的問題，所以在我們的假期任務中，模型可能會遇到以下問題：</p><ul><li><strong>知識缺口（資訊依賴於其他資訊）</strong>：例如，你想參觀艾菲爾鐵塔，但不知道它在公共假期是否開放。你需要同時找出鐵塔的假期營業時間表和法國公共假期的日期。</li><li><strong>錯誤或過時的資訊</strong>：一篇 2020 年的旅遊部落格提到羅馬的某家餐廳週日有營業，但當你抵達時，發現它已經改變營業時間，現在週日不營業。</li><li><strong>矛盾的資訊</strong>：一個旅遊網站聲稱紐約的某家酒店提供免費早餐，而另一個網站則表示房價不包含早餐。</li><li><strong>模糊的資訊</strong>：一篇旅遊論壇的貼文提到「巴塞隆納附近的一個很棒的海灘」，但沒有指明是哪個海灘或提供清楚的方向，使得很難確定確切位置。</li></ul><p>R1 可以將複雜的任務分解成可執行的步驟，識別資訊缺口和不一致之處，並處理像被封鎖的網站和訂閱牆這樣的障礙。它具有收集所需知識和綜合答案的推理能力。然而，它無法單獨為我們規劃假期 — 這需要搜尋網路並理解返回的結果。我們必須對它進行強化，設置框架並增強其能力，才能勝任這項工作。</p><h2 id=\"implementation\">實作</h2><figure class=\"kg-card kg-bookmark-card kg-card-hascaption\"><a class=\"kg-bookmark-container\" href=\"https://colab.research.google.com/drive/18sqU8_eWqFleKqpd-SnGDNmZ_P1KLfXw?usp=sharing#scrollTo=2jFWdbnp_6ws\"><div class=\"kg-bookmark-content\"><div class=\"kg-bookmark-title\">Google Colab</div><div class=\"kg-bookmark-description\"></div><div class=\"kg-bookmark-metadata\"><img class=\"kg-bookmark-icon\" src=\"https://jina-ai-gmbh.ghost.io/content/images/icon/favicon-32.ico\" alt=\"\"></div></div><div class=\"kg-bookmark-thumbnail\"><img src=\"https://jina-ai-gmbh.ghost.io/content/images/thumbnail/colab_favicon_256px-7.png\" alt=\"\" onerror=\"this.style.display = 'none'\"></div></a><figcaption><p><span style=\"white-space: pre-wrap;\">要運行此 notebook，你需要免費的 </span><a href=\"https://jina.ai\"><span style=\"white-space: pre-wrap;\">Jina AI</span></a><span style=\"white-space: pre-wrap;\"> 和 </span><a href=\"https://openrouter.ai\"><span style=\"white-space: pre-wrap;\">OpenRouter</span></a><span style=\"white-space: pre-wrap;\"> API 金鑰。</span></p></figcaption></figure><p>雖然 R1 是我們代理的引擎，但我們還添加了一些工具、狀態物件，當然還有一個（相當大的）提示。以下是簡化的表示：</p><figure class=\"kg-card kg-image-card\"><img src=\"https://jina-ai-gmbh.ghost.io/content/images/2025/03/image-29.png\" class=\"kg-image\" alt=\"\" loading=\"lazy\" width=\"1639\" height=\"2256\" srcset=\"https://jina-ai-gmbh.ghost.io/content/images/size/w600/2025/03/image-29.png 600w, https://jina-ai-gmbh.ghost.io/content/images/size/w1000/2025/03/image-29.png 1000w, https://jina-ai-gmbh.ghost.io/content/images/size/w1600/2025/03/image-29.png 1600w, https://jina-ai-gmbh.ghost.io/content/images/2025/03/image-29.png 1639w\" sizes=\"(min-width: 720px) 720px\"></figure><ul><li><strong>工具</strong>可以被模型調用來搜尋和抓取網頁，結果存儲在狀態中。</li><li><strong>狀態</strong>追蹤工具結果、任務狀態和知識。它存儲在提示本身中。</li><li><strong>單一提示</strong>提供指示，指定任務和如何進行，以及存儲狀態。</li></ul><p>我們稍後會詳細介紹這些內容，特別是提示部分。但簡而言之，系統的運作方式如下：</p><p>我們從帶有未填充狀態物件的提示開始。當任務正在進行中（即嘗試產生答案）時，代理會循環執行以下步驟直到產生答案：</p><ol><li>模型從提示中檢查任務和其狀態，並推理如何最好地使用其工具來獲得答案。</li><li>模型輸出一個 JSON 物件，指定其狀態（<code>IN PROGRESS</code> 或 <code>DONE</code>）、記憶更新、工具調用和答案（最初為 <code>null</code>）。</li><li>代理異步調用工具，結果被嵌入回提示中，以及步驟 3 中的 JSON 物件。</li><li>包含這些新資訊的提示被重新輸入到模型中進行另一輪循環。</li></ol><p>一旦模型在其輸出中提供答案，任務就結束並交付答案。</p><div class=\"kg-card kg-callout-card kg-callout-card-blue\"><div class=\"kg-callout-emoji\">💡</div><div class=\"kg-callout-text\">要更好地了解代理如何運作，我們建議你自己試試<a href=\"https://colab.research.google.com/drive/18sqU8_eWqFleKqpd-SnGDNmZ_P1KLfXw?usp=sharing#scrollTo=2jFWdbnp_6ws\">這個 notebook</a>，並檢查每次迭代的輸出。</div></div><p>現在我們有了高層次的概述，讓我們依次看看工具、狀態和提示：</p><h2 id=\"tools\">工具</h2><p>由於 R1 無法自行搜尋或抓取網頁，我們使用 Jina 的 Reader API 來擴展其功能。這包括兩種模式：</p><ul><li><strong>搜尋模式</strong>：搜尋網路上的相關術語並返回搜尋引擎結果（包括每個結果的 URL、標題和描述）。</li><li><strong>閱讀模式</strong>：抓取搜尋結果中的頁面並以 Markdown 格式返回。</li></ul><p>由於 R1 的上下文視窗有限，我們不能只是將整個頁面丟進提示的 <code>Tool Results</code> 部分。我們需要額外的工具來選擇最相關的資訊，然後再傳遞給模型：</p><ul><li><a href=\"https://python.langchain.com/docs/concepts/text_splitters/\"><strong>LangChain 遞歸字符文本分割器</strong></a>：我們使用 <code>RecursiveCharacterTextSplitter</code> 將長輸出分成段落，在段落和句子上遞歸分割，直到獲得所需的段落大小。這確保輸出能夠被 R1 的有限上下文視窗輕鬆處理。</li><li><a href=\"https://jina.ai/reranker\"><strong>Jina Reranker</strong></a>：我們使用 <code>jina-reranker-v2-base-multilingual</code> 對段落重新排序，並將排名最高的段落組合成一個結果。</li></ul><p>不幸的是，DeepSeek R1 不像 <code>o3-mini</code> 那樣支援工具使用。例如，使用 <code>o3-mini</code>，我們可以使用類似以下的程式碼：</p><figure class=\"kg-card kg-code-card\"><pre><code class=\"language-python\">def scrape_page(url: str):\n    \"\"\"Scrape a web page with Jina Reader\"\"\"\n\ntools = [\n    {\n        \"type\": \"function\",\n        \"function\": {\n            \"name\": \"scrape_page\",\n            \"description\": \"Scrape the content of a webpage\",\n            \"parameters\": {\n                \"url\": {\"type\": \"string\", \"description\": \"The URL to scrape\"}\n            }\n        }\n    }\n]\n\nclient = OpenAI()\nresponse = client.completions.create(\n    model=\"o3-mini\",\n    prompt=f\"Scrape www.skyscanner.net/routes/gr/de/germany-to-crete.html\",\n    tools=tools\n)\n</code></pre><figcaption><p><span style=\"white-space: pre-wrap;\">支援工具使用的 o3-mini 程式碼示例</span></p></figcaption></figure><p>但這對 R1 來說並不容易：它沒有可以傳遞給 API 的 <code>tools</code> 參數，也不會在其回應中返回結構化的 <code>tool_calls</code>。簡單來說，它並未被訓練使用工具（<a href=\"https://github.com/deepseek-ai/DeepSeek-R1/issues/9\">而且在短期內也不會支援</a>）。至少，它不以傳統意義上支援工具。然而，我們<em>仍然</em>可以要求 R1 以 JSON 格式輸出工具調用，並將工具調用結果回饋給模型進行分析：</p><figure class=\"kg-card kg-code-card\"><pre><code class=\"language-markdown\">You must respond with a valid JSON object containing:\n```json\n{\n  \"tool_calls\": [\n    {\"tool\": \"search\", \"input\": \"Cheapest flights from Germany to Crete May 2025\"},\n    {\"tool\": \"scrape\", \"input\": \"&lt;https://www.skyscanner.net/routes/gr/de/germany-to-crete.html&gt;\"}\n  ]\n}\n```</code></pre><figcaption><p><span style=\"white-space: pre-wrap;\">Tool calls 作為 R1 提示詞的一部分</span></p></figcaption></figure><p>在模型在第 <em>n</em> 次迭代中輸出 tool calls 後，這些工具被調用，結果會被嵌入到提示詞的 <code>Tool Results</code> 部分，供模型在第 <em>n+1</em> 次迭代時進行推理：</p><figure class=\"kg-card kg-code-card\"><pre><code class=\"language-markdown\">Tool Results:\n\nSource 1️: search: Cheapest flights from Germany to Crete May 2025\nResult:\n\n```\nTitle: Affordable flights: Germany - Heraklion (Crete) (HER) | Eurowings URL Source: https://www.eurowings.com/en/booking/offers/flights-from/DE/to/GR/HER.html Description: Affordable flights from Germany to Heraklion (Crete) ✈ Eurowings brings you closer to your dream destination from as little as €89.99*. Book now and enjoy.\nTitle: Are you a person or a robot? URL Source: https://www.skyscanner.com/routes/fran/her/frankfurt-to-crete-heraklion.html Description: Book a one-way ticket from Frankfurt to Heraklion Airport from $78 or travel return from just $154. The prices shown are based on availability and could change ...\n```\n</code></pre><figcaption><p><span style=\"white-space: pre-wrap;\">工具結果，顯示德國到克里特島航班的搜索結果</span></p></figcaption></figure><h2 id=\"state\">狀態</h2><p>狀態用於追蹤任務狀態（<code>Status</code>）和模型需要分析和更新的知識（<code>Memory</code>）。簡而言之，這是系統的工作記憶和記憶庫。這些內容存儲在提示詞中名為 <code>{{ workspace }}</code> 的部分，一開始是空白的：</p><figure class=\"kg-card kg-code-card\"><pre><code class=\"language-markdown\">Status: IN_PROGRESS\nMemory: \n... no memory blocks ..\n</code></pre><figcaption><p><span style=\"white-space: pre-wrap;\">空的狀態對象</span></p></figcaption></figure><p>當模型對任務進行推理、運行工具並收集輸出時，狀態會被填充上記憶塊（來自工具輸出），每個記憶塊都有自己隨機分配的 ID。對於我們的度假規劃示例，在運行一次代理後，狀態可能如下所示：</p><figure class=\"kg-card kg-code-card\"><pre><code class=\"language-markdown\">Status: IN_PROGRESS\nMemory: \n&lt;nuz-032&gt;Potential warm May destinations: Malaga (Spain), Crete (Greece), Algarve (Portugal)&lt;/nuz-032&gt;\n&lt;xwj-969&gt;URL to scrape for Crete hotel details: &lt;https://www.tripadvisor.com/HotelsList-Crete-Beachfront-Cheap-Hotels-zfp13280541.html&gt;&lt;/xwj-969&gt;\n&lt;vsc-583&gt;URL to scrape for flight details: &lt;https://www.expedia.com/lp/flights/fra/her/frankfurt-to-heraklion&gt;&lt;/vsc-583&gt;\n</code></pre><figcaption><p><span style=\"white-space: pre-wrap;\">DeepSeek R1 填充的狀態</span></p></figcaption></figure><p>記憶塊通過在模型的 JSON 響應中包含 <code>memory_updates</code> 列表來更新：</p><figure class=\"kg-card kg-code-card\"><pre><code class=\"language-json\">{\n\t\"memory_updates\": [\n\t  {\"operation\": \"add\", \"content\": \"Round-trip flight from Berlin to Tenerife in May 2025 ranges from €59.99 to €200 round-trip as per the Skyscanner and Iberia sources.\"},\n\t  {\"operation\": \"delete\", \"id\": \"nuz-032\"},\n\t  ...\n\t]\n}</code></pre><figcaption><p><span style=\"white-space: pre-wrap;\">作為 R1 JSON 輸出一部分的記憶更新</span></p></figcaption></figure><ul><li><strong><code>add</code> 操作</strong>添加一個記憶塊，可用於存儲重要資訊，如線索、發現、資訊缺口和已執行的操作。</li><li><strong><code>delete</code> 操作</strong>刪除一個記憶塊，允許模型刪除舊的、不必要的或錯誤的資訊，並維護一個乾淨的工作空間。</li></ul><div class=\"kg-card kg-callout-card kg-callout-card-yellow\"><div class=\"kg-callout-emoji\">💡</div><div class=\"kg-callout-text\">我們也測試了 <code>replace</code> 操作，但我們發現模型會生成大量資訊（過度依賴 <code>replace</code>），因此決定移除這個選項。</div></div><p>與發出工具調用相比，R1 對管理自己的記憶較不熟悉。雖然模型經過專門訓練可以處理複雜的數學問題和編碼任務——這種訓練使其能夠產生準確的 JSON 對象並執行工具調用——但它並沒有被訓練來管理類記憶狀態（我們所知的其他模型也沒有）。</p><p>使用緊湊的記憶狀態存儲資訊比每輪存儲模型的全部輸出有幾個優勢。這種方法在提示詞中壓縮資訊，防止上下文溢出，同時增強模型對相關知識的關注。我們保持 JSON 格式是因為它易於更新，但 JSON 在提示詞中會以人類可讀的格式呈現。</p><p>即便如此，記憶管理仍然超出了 R1 的核心領域；我們需要實施多項指令來指導模型正確處理記憶操作。以下是我們提示詞中處理這部分的內容：</p><figure class=\"kg-card kg-code-card\"><pre><code class=\"language-markdown\">... other contents of the prompt ...\n\n## Memory Block Usage\n- Each memory block has a unique ID in format &lt;abc-123&gt;content&lt;/abc-123&gt;\n- Create separate blocks for distinct pieces of information:\n  * Discovered URLs (both explored and pending)\n  * Information gaps that need investigation\n  * Actions already taken (to avoid repetition)\n  * Promising leads for future exploration\n  * Key facts and findings\n  * Contradictions or inconsistencies found\n- Keep each block focused on a single idea or piece of information\n- Always cite sources when recording information from tool results\n- Use IDs to track and manage your knowledge (e.g., deleting outdated information)\n- Make sure to store sources (URLs) for the facts and findings you store\n\n## Lead Management\n- Since you can only make 3 tool calls per round, store promising leads for later\n- Create dedicated memory blocks for URLs to scrape later\n- Maintain blocks for potential search queries to explore in future rounds\n- Prioritize leads based on relevance to the task\n\n... other contents of the prompt ...</code></pre><figcaption><p><span style=\"white-space: pre-wrap;\">提示詞中的記憶處理指令</span></p></figcaption></figure><h2 id=\"prompt\">提示詞</h2><p>我們使用 <a href=\"https://jinja.palletsprojects.com/en/stable/templates/\">Jinja 模板格式</a>創建提示詞。它包含幾個部分：</p><ul><li><strong>上下文</strong>（在本例中是當前日期）。</li><li><strong>指令</strong>，涵蓋一切如何運作，並告訴模型有哪些工具可用。</li><li><strong>狀態</strong>，如上所述。</li><li><strong>工具輸出</strong>，來自 <code>search</code> 和 <code>scrape</code> 工具。</li></ul><figure class=\"kg-card kg-code-card\"><pre><code class=\"language-markdown\">{% macro format_tool_results(tool_records) %}\n{% for to in tool_records %}\nSource {{ loop.index }}️: {{ to.tool }}: {{ to.input }}\nResult:\n```\n{{ to.output }}\n```\n{% endfor %}\n{% endmacro %}\n\nThe date: `{{ current_date }}`.\nYou are an information analysis and exploration agent that builds solutions through systematic investigation.\n\n## Investigation Cycle\nYou operate in a continuous investigation cycle:\n\n1. Review current workspace (your memory blocks)\n2. Analyze new tool results (or initial task if first round)\n3. Update memory with new insights and track investigation progress\n4. Decide on next tools to call based on identified leads and information gaps\n5. Repeat until task completion\n\n## Memory Structure\nYour memory persists between investigation cycles and consists of:\n- **Status**: Always the first line, indicates if the task is IN_PROGRESS or DONE\n- **Memory**: A collection of discrete information blocks, each with a unique ID\n\n## Memory Block Usage\n- Each memory block has a unique ID in format &lt;abc-123&gt;content&lt;/abc-123&gt;\n- Create separate blocks for distinct pieces of information:\n  * Discovered URLs (both explored and pending)\n  * Information gaps that need investigation\n  * Actions already taken (to avoid repetition)\n  * Promising leads for future exploration\n  * Key facts and findings\n  * Contradictions or inconsistencies found\n- Keep each block focused on a single idea or piece of information\n- Always cite sources when recording information from tool results\n- Use IDs to track and manage your knowledge (e.g., deleting outdated information)\n- Make sure to store sources (URLs) for the facts and findings you store\n\n## Lead Management\n- Since you can only make 3 tool calls per round, store promising leads for later\n- Create dedicated memory blocks for URLs to scrape later\n- Maintain blocks for potential search queries to explore in future rounds\n- Prioritize leads based on relevance to the task\n\n## Available Tools\n- **search**: Use for broad information gathering on new topics or concepts\n  * Example: {\"tool\": \"search\", \"input\": \"renewable energy statistics 2023\"}\n- **scrape**: Use for extracting specific details from discovered URLs\n  * Example: {\"tool\": \"scrape\", \"input\": \"https://example.com/energy-report\"}\n\n## Tool Usage Guidelines\n- **When to use search**: For new concepts, filling knowledge gaps, or exploring new directions\n- **When to use scrape**: For URLs discovered that likely contain detailed information\n- **Maximum 3 tool calls per round**\n- **Never repeat the exact same tool call**\n- **Always record valuable information from tool results in memory blocks**\n\n## Response Format\nYou must respond with a valid JSON object containing:\n\n```json\n{\n  \"status_update\": \"IN_PROGRESS or DONE\",\n  \"memory_updates\": [\n    {\"operation\": \"add\", \"content\": \"New insight or lead to investigate\"},\n    {\"operation\": \"delete\", \"id\": \"abc-123\"}\n  ],\n  \"tool_calls\": [\n    {\"tool\": \"search\", \"input\": \"specific search query\"},\n    {\"tool\": \"scrape\", \"input\": \"https://discovered-url.com\"}\n  ],\n  \"answer\": \"Your final, comprehensive answer when status is DONE\"\n}\n```\n\n## Important Rules\n- The \"add\" operation creates a new memory block\n\tYou do not need to specify an ID, it will be added automatically by the system.\n- The \"delete\" operation requires the specific ID of the block to remove\n- Never invent or fabricate information - only use facts from your memory or tool results\n- Never make up URLs - only use URLs discovered through tool results\n- CRITICAL: Any information not recorded in your memory blocks will be lost in the next round\n  For example, if you find a potential webpage to scrap, you must store the URL and your intention\n  Example: `{\"operation\": \"add\", \"content\": \"Found relevant URL: https://... to scrape ...\"}`\n- Set status to \"DONE\" only when you have fully addressed the task\n- Only include the \"answer\" field when status is \"DONE\"\n\nTask:\n```\n{{ task }}\n```\n\nCurrent workspace:\n```\n{{ workspace }}\n```\n\nTool Results:\n{{ format_tool_results(tool_records) if tool_records else '... no previous tool results ...'}}\n\nIMPORTANT: Generate a valid JSON response following the format above.\n\nThink carefully about:\n- what information do you need to preserve\n- which tools to call next\n- how to build your answer systematically with focused memory blocks</code></pre><figcaption><p><span style=\"white-space: pre-wrap;\">我們深度搜索系統中使用的完整提示詞</span></p></figcaption></figure><div class=\"kg-card kg-callout-card kg-callout-card-yellow\"><div class=\"kg-callout-emoji\">💡</div><div class=\"kg-callout-text\">提示頂部的 Jinja 宏函數只是以更簡潔的格式呈現工具結果。</div></div><h2 id=\"evaluation\">評估</h2><p>我們用我們的假期規劃範例來測試我們的系統。以下是嵌入提示中的任務：</p><pre><code class=\"language-text\">Help me plan a 3 day holiday in Europe in May for under 2000 EUR\n1. I need specific flight and hotel recommendations.\n2. I want the destination to be warm.\n3. I want to have a beach nearby the hotel.\nI live in Germany.</code></pre><p>以下是最終結果（經過五次迭代循環後）：</p><figure class=\"kg-card kg-code-card\"><pre><code class=\"language-markdown\">**3-Day Crete Holiday Plan (Total ≈ €600-800)**\n\n✈️ *Flights (From Frankfurt):*  \n- Skyscanner: €154 round trip (May 2025 dates)  \n  Source: &lt;https://www.skyscanner.com/routes/fran/her/frankfurt-to-crete-heraklion.html&gt;  \n- Backup: Eurowings €180 round trip  \n\n🏨 *Beachfront Hotels:*  \n1. **Georgioupolis Beach Hotel**  \n   - Direct beach access, bike rentals €10  \n   - Source: &lt;https://www.tripadvisor.com/HotelsList-Crete-Beachfront-Cheap-Hotels-zfp13280541.html&gt;  \n\n2. **JT Apartments**  \n   - €57/night, 9.5/10 rating, 5-min walk to beach  \n   - Source: &lt;https://www.booking.com/region/gr/crete.html&gt;  \n\n3. **FNK Apartments**  \n   - Sea views, 9.6/10 rating  \n\n💰 *Budget Breakdown:*  \n- Flights: €154  \n- Hotel (3 nights): €171-250  \n- Remaining: €1,600+ for meals/activities  \n\n*Note:* All hotels are &lt;5 mins from beaches. Crete averages 25°C in May (Source: TravelSupermarket).\n</code></pre><figcaption><p><span style=\"white-space: pre-wrap;\">假期搜尋任務的結果，經過五次迭代後</span></p></figcaption></figure><p>這個答案看起來很合理。但它真的準確嗎？畢竟，模型有時會產生幻覺，而且在一個有多個運作部分的系統中，很可能會出錯。讓我們驗證 R1 輸出中的一些細節：</p><h3 id=\"destination-and-total-budget\">目的地和總預算</h3><p>每個項目的計算都加起來了（我們稍後會討論每個項目是否準確）。畢竟，R1 是在數學問題上訓練的。目的地也沒問題；克里特島是一個熱門地點。</p><h3 id=\"flights\">航班</h3><p>航班價格幾乎是對的，但讓我們看看哪裡出了問題。首先，以下是 2025 年 5 月從法蘭克福到赫拉克利翁的實際 Skyscanner 往返價格：</p><figure class=\"kg-card kg-image-card kg-card-hascaption\"><img src=\"https://jina-ai-gmbh.ghost.io/content/images/2025/03/image-25.png\" class=\"kg-image\" alt=\"\" loading=\"lazy\" width=\"2000\" height=\"2384\" srcset=\"https://jina-ai-gmbh.ghost.io/content/images/size/w600/2025/03/image-25.png 600w, https://jina-ai-gmbh.ghost.io/content/images/size/w1000/2025/03/image-25.png 1000w, https://jina-ai-gmbh.ghost.io/content/images/size/w1600/2025/03/image-25.png 1600w, https://jina-ai-gmbh.ghost.io/content/images/2025/03/image-25.png 2048w\" sizes=\"(min-width: 720px) 720px\"><figcaption><span style=\"white-space: pre-wrap;\">2025 年 5 月法蘭克福-赫拉克利翁航班的實際 Skyscanner 搜尋結果</span></figcaption></figure><p>我們可以看到價格都在 200 歐元左右，而不是承諾的往返 154 歐元！但這個錯誤從何而來？查看日誌，我們發現在第三輪中添加了一個相關的記憶區塊：</p><figure class=\"kg-card kg-code-card\"><pre><code class=\"language-json\">{\"operation\": \"add\", \"content\": \"Crete flight options: Eurowings €89.99* one-way ...\"}</code></pre><figcaption><p><span style=\"white-space: pre-wrap;\">與德國-克里特島航班相關的記憶區塊</span></p></figcaption></figure><p>這個區塊似乎是從附加的搜尋結果推斷出來的：</p><figure class=\"kg-card kg-code-card\"><pre><code class=\"language-markdown\">Source 1️: search: Cheapest flights from Germany to Crete May 2025\nResult:\n```\n... other results ...\nTitle: Are you a person or a robot?\nURL Source: https://www.skyscanner.com/routes/fran/her/frankfurt-to-crete-heraklion.html\nDescription: Book a one-way ticket from Frankfurt to Heraklion Airport from $78 or travel \nreturn from just $154. The prices shown are based on availability and could change ...\n```</code></pre><figcaption><p><span style=\"white-space: pre-wrap;\">德國-克里特島航班的搜尋結果</span></p></figcaption></figure><p>模型從未嘗試爬取此網頁以確認結果，但這可能不會有什麼區別。然而，它至少應該注意到搜尋結果中並沒有包含「五月」這個時期。</p><h3 id=\"hotel\">酒店</h3><p>酒店資訊是正確的，但我們發現了一些可以改進的地方。首先，我們希望模型在尋找 Georgioupolis Beach Hotel 和 FNK Apartments 的價格時投入更多努力 - 雖然它提供了其他資訊，但價格卻缺失了。為了說明我們的意思，這裡是用於生成酒店推薦的 <a href=\"https://www.booking.com/region/gr/crete.html\">URL</a> 爬取的原始輸出。它只顯示了第一個和最後一個結果的價格，跳過了中間三個：</p><figure class=\"kg-card kg-code-card\"><pre><code class=\"language-markdown\">資料來源 3️: 爬取: https://www.booking.com/region/gr/crete.html\n結果:\n```\n顯示更多 顯示更少\n\nMoritz 德國\n\n*   ### [JT Apartments](https://www.booking.com/hotel/gr/jt-apatments.html?label=gen173nr-1FCAYoXEIFY3JldGVIM1gEaJUCiAEBmAExuAEZyAEM2AEB6AEB-AECiAIBqAIDuALSvqC-BsACAdICJDc5ZWE5ZDJkLTI2ZWEtNGNiMS04MzNlLTJhNWIyMGI5Y2M3NdgCBeACAQ&amp;sid=f21cdd5fe9eb08dcac7d3a0304f9ccc9)\n\nKissamos\n\n每晚 $57 起\n\n9.5 極佳 313 則評論\n\n我強烈推薦入住 JT Apartments。當我們進入公寓時，受到了一個愉快的驚喜。一切設備齊全。周邊環境安靜，附近有超市。海灘就在步行距離內。如果您想參觀克里特島最美麗的海灘，這裡是絕佳位置。感謝您們讓我們的住宿體驗完全符合我們的夢想 :)\n\n顯示更多 顯示更少\n\nKatarzyna 波蘭\n顯示更多 顯示更少\n\nAitor 德國\n\n*   ### [FNK Apartments with Sea View](https://www.booking.com/hotel/gr/f-amp-k-apartments.html?label=gen173nr-1FCAYoXEIFY3JldGVIM1gEaJUCiAEBmAExuAEZyAEM2AEB6AEB-AECiAIBqAIDuALSvqC-BsACAdICJDc5ZWE5ZDJkLTI2ZWEtNGNiMS04MzNlLTJhNWIyMGI5Y2M3NdgCBeACAQ&amp;sid=f21cdd5fe9eb08dcac7d3a0304f9ccc9)\n\nAgia Pelagia\n\n9.6 極佳 64 則評論\n\n我們在克里特島待了一週。期間住在 FnK Apartments。Froso 和 Konstantinos 是超級友善且令人驚艷的房東。如果我們有任何問題或需求，他們總是隨時準備協助。公寓本身擁有 Agia Pelagia 和周圍海灣的美麗景色（甚至可以看到美麗的日出）。我們只能推薦 FnK Apartments！！\n\n顯示更多 顯示更少\n\nMoritz 德國\n顯示更多 顯示更少\n\nmary 美國\n\n*   ### [Artemis Hotel Apartments](https://www.booking.com/hotel/gr/artemis-hersonisos.html?label=gen173nr-1FCAYoXEIFY3JldGVIM1gEaJUCiAEBmAExuAEZyAEM2AEB6AEB-AECiAIBqAIDuALSvqC-BsACAdICJDc5ZWE5ZDJkLTI2ZWEtNGNiMS04MzNlLTJhNWIyMGI5Y2M3NdgCBeACAQ&amp;sid=f21cdd5fe9eb08dcac7d3a0304f9ccc9)\n\nLimenas Hersonissou, Hersonissos\n\n9.0 優異 419 則評論\n\n如果您想感受賓至如歸，被當作朋友對待，並且知道您會在各方面得到幫助，我們強烈推薦您入住這家飯店。衷心感謝 Konstantine 的溫暖和非常貼心的待遇！下次造訪克里特島時，我們很樂意再次入住 Artemis Hotel！\n\n顯示更多 顯示更少\n\nIrina 以色列\n顯示更多 顯示更少\n\nAnn Marie 愛爾蘭\n\n*   ### [Pinelopi Hotel](https://www.booking.com/hotel/gr/pinelopi.html?label=gen173nr-1FCAYoXEIFY3JldGVIM1gEaJUCiAEBmAExuAEZyAEM2AEB6AEB-AECiAIBqAIDuALSvqC-BsACAdICJDc5ZWE5ZDJkLTI2ZWEtNGNiMS04MzNlLTJhNWIyMGI5Y2M3NdgCBeACAQ&amp;sid=f21cdd5fe9eb08dcac7d3a0304f9ccc9)\n\nPlatanes\n\n7.8 好 198 則評論\n\n絕佳位置，靠近海灘，周圍有很棒的小餐館，也適合開車四處遊覽。安靜的區域，適合度過美好的假期。寬敞的房間配備所需的一切。物超所值。泳池區域非常棒，您可以在一天中任何時候在那裡放鬆。飯店附近的停車場很完美。下次再訪克里特島時，我一定會再回到 Pinelopi Hotel。\n\n顯示更多 顯示更少\n\nRita 羅馬尼亞\n顯示更多 顯示更少\n\nKatarzyna 波蘭\n\n*   ### [Elizabeth Suites](https://www.booking.com/hotel/gr/elizabeth-suites.html?label=gen173nr-1FCAYoXEIFY3JldGVIM1gEaJUCiAEBmAExuAEZyAEM2AEB6AEB-AECiAIBqAIDuALSvqC-BsACAdICJDc5ZWE5ZDJkLTI2ZWEtNGNiMS04MzNlLTJhNWIyMGI5Y2M3NdgCBeACAQ&amp;sid=f21cdd5fe9eb08dcac7d3a0304f9ccc9)\n\nKato Daratso\n\n每晚 $74 起\n\n9.1 優異 86 則評論\n\n我們有一個很棒的住宿體驗，老闆 Epas 總是面帶微笑且非常樂於助人，工作人員特別是 Anna 都很可愛，這讓體驗更加溫馨。我們吃了幾天早餐，份量都非常充足。公寓位置完美，靠近海灘和餐廳。我們強烈推薦 The Elizabeth Suites，讓我們在克里特島的首次假期非常愉快 😊\n\n顯示更多 顯示更少\n\nJean 英國\n```</code></pre><figcaption><p><span style=\"white-space: pre-wrap;\">在 booking.com 上爬取的克里特島飯店列表原始搜尋結果</span></p></figcaption></figure><p>其次，我們在使用 Reranker 時發現了一個額外問題，它預設的 <code>top_n</code> 為 5 個結果 — 結果發現爬取的頁面實際上包含超過五個相關結果 — 我們本可以通過實際檢查每個結果的相關性分數來解決這個問題，而不是僅僅取前五個（或其他數量的）結果。然而，理想的重新排序配置因任務而異。解決這個問題的更好方法應該是使用整個爬取頁面 — 但可惜由於 R1 的上下文長度限制，這是不可能的。</p><h3 id=\"overall-performance-and-potential-improvements\">整體表現和潛在改進</h3><p>模型一開始表現不錯，但我們注意到，除非特別提示，否則它很少嘗試切換策略或制定複雜的計劃。雖然 R1 自然會在數學和編碼問題上採用這些方法（這是它特別訓練的領域），但它並沒有將相同的推理應用於搜尋任務。雖然我們可以進一步微調提示（甚至使用多個提示）來解決這個限制，但這不是我們的主要目標。</p><p>我們也觀察到 R1 沒有充分處理時效性資訊。簡而言之，如果搜尋結果沒有明確提到錯誤的日期，模型會在沒有進一步驗證的情況下假設該資訊有效。例如，在規劃 5 月 1 日的航班時：</p><ul><li>德國到克里特島 $80 5 月 1 日：<strong>正確</strong> — 模型可以信任這個資訊。</li><li>德國到克里特島 $80 1 月 1 日：<strong>錯誤</strong> — 模型正確識別並放棄這個資訊。</li><li>德國到克里特島 $80：<strong>假陽性</strong> — 當沒有指定日期時，模型未能驗證資訊並錯誤地假設其有效。</li></ul><p>如果我們要繼續這個專案，我們可能會考慮實施幾個潛在的改進：</p><ul><li>追蹤記憶區塊數量，並在狀態變得太大時提示模型<strong>總結條目</strong>。</li><li>指示模型在完成探索和回應查詢之前<strong>窮盡所有線索</strong>。</li><li>強調<strong>驗證時效性資訊</strong>。</li><li>確保模型通過爬取搜尋工具返回的 URL 來<strong>複查結果</strong>。</li><li>使用<strong>支援更大上下文視窗的未來推理模型</strong>測試我們的系統，不過這需要大量重構和測試來調整提示以適應不同的模型。</li></ul><h2 id=\"conclusion\">結論</h2><p>即使在 R1 最近發布以來，這個領域已經有了顯著的發展。一些專案已經能以極低的成本（有些僅需 $5）訓練推理模型。這種民主化意味著訓練專門模型比以往更加容易。我們對 R1 的實驗為我們繼續探索如何增強推理型 LLM 以處理複雜搜尋任務提供了有用的基準。</p><p>雖然我們的度假規劃示例展示了令人期待的結果（尤其是對於一個快速的示範專案而言），但它也揭示了 R1 在處理搜尋和記憶任務方面的限制，相較於其在數學和編碼方面的優勢。雖然該系統成功地在預算限制內制定了旅行計劃，但在諸如驗證時效性資訊和徹底探索所有可用選項等方面表現不足，凸顯了模型訓練重點和其應用於不同領域之間的差距。</p>",
  "comment_id": "67dd5037143bda0001036423",
  "feature_image": "https://jina-ai-gmbh.ghost.io/content/images/2025/04/Heading--92-.png",
  "featured": false,
  "visibility": "public",
  "created_at": "2025-03-21T12:40:39.000+01:00",
  "updated_at": "2025-04-01T09:38:45.000+02:00",
  "published_at": "2025-04-01T09:38:45.000+02:00",
  "custom_excerpt": "Standard LLM or reasoning model, which is better for DeepSearch? In this post, we explored using DeepSeek-R1 in the DeepSearch implementation for choosing the next action.",
  "codeinjection_head": null,
  "codeinjection_foot": null,
  "custom_template": null,
  "canonical_url": null,
  "authors": [
    {
      "id": "64ae64a4733bc60001949ca4",
      "name": "Andrei Ungureanu",
      "slug": "andrei",
      "profile_image": "https://jina-ai-gmbh.ghost.io/content/images/2023/07/Me.jpg",
      "cover_image": null,
      "bio": "Software / AI Engineer, with a passion for content creation.",
      "website": null,
      "location": "Beijing, China",
      "facebook": null,
      "twitter": null,
      "meta_title": null,
      "meta_description": null,
      "url": "https://jina-ai-gmbh.ghost.io/author/andrei/"
    },
    {
      "id": "632ade4a3e4e55003d525971",
      "name": "Alex C-G",
      "slug": "alexcg",
      "profile_image": "https://jina-ai-gmbh.ghost.io/content/images/2022/09/alex.jpg",
      "cover_image": "https://jina-ai-gmbh.ghost.io/content/images/2022/11/twitter_banner.jpg",
      "bio": "Open-source Evangelist @ Jina AI. Old, grim, and full of Vim",
      "website": null,
      "location": "Berlin, Germany",
      "facebook": null,
      "twitter": "@alexcg",
      "meta_title": null,
      "meta_description": null,
      "url": "https://jina-ai-gmbh.ghost.io/author/alexcg/"
    }
  ],
  "tags": [
    {
      "id": "634a1a8ccebfc1003d8ab706",
      "name": "Tech Blog",
      "slug": "tech-blog",
      "description": null,
      "feature_image": null,
      "visibility": "public",
      "og_image": null,
      "og_title": null,
      "og_description": null,
      "twitter_image": null,
      "twitter_title": null,
      "twitter_description": null,
      "meta_title": null,
      "meta_description": null,
      "codeinjection_head": null,
      "codeinjection_foot": null,
      "canonical_url": null,
      "accent_color": null,
      "url": "https://jina-ai-gmbh.ghost.io/tag/tech-blog/"
    }
  ],
  "primary_author": {
    "id": "64ae64a4733bc60001949ca4",
    "name": "Andrei Ungureanu",
    "slug": "andrei",
    "profile_image": "https://jina-ai-gmbh.ghost.io/content/images/2023/07/Me.jpg",
    "cover_image": null,
    "bio": "Software / AI Engineer, with a passion for content creation.",
    "website": null,
    "location": "Beijing, China",
    "facebook": null,
    "twitter": null,
    "meta_title": null,
    "meta_description": null,
    "url": "https://jina-ai-gmbh.ghost.io/author/andrei/"
  },
  "primary_tag": {
    "id": "634a1a8ccebfc1003d8ab706",
    "name": "Tech Blog",
    "slug": "tech-blog",
    "description": null,
    "feature_image": null,
    "visibility": "public",
    "og_image": null,
    "og_title": null,
    "og_description": null,
    "twitter_image": null,
    "twitter_title": null,
    "twitter_description": null,
    "meta_title": null,
    "meta_description": null,
    "codeinjection_head": null,
    "codeinjection_foot": null,
    "canonical_url": null,
    "accent_color": null,
    "url": "https://jina-ai-gmbh.ghost.io/tag/tech-blog/"
  },
  "url": "https://jina-ai-gmbh.ghost.io/podcast/using-deepseek-r1-reasoning-model-in-deepsearch/",
  "excerpt": "標準 LLM 或推理模型，哪個更適合 DeepSearch？在這篇文章中，我們探討了在 DeepSearch 實作中使用 DeepSeek-R1 來選擇下一步行動。",
  "reading_time": 17,
  "access": true,
  "comments": false,
  "og_image": null,
  "og_title": null,
  "og_description": null,
  "twitter_image": null,
  "twitter_title": null,
  "twitter_description": null,
  "meta_title": null,
  "meta_description": null,
  "email_subject": null,
  "frontmatter": null,
  "feature_image_alt": null,
  "feature_image_caption": null
}