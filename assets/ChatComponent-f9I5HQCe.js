import{s as ht,m as F,p as R,ce as gt,j as Ne,a0 as De,u as rt,am as ke,k as ie,n as at,a2 as ze,a3 as C,a4 as O,a5 as S,aa as se,ah as ge,b5 as be,a6 as j,ab as ce,ad as Je,ae as Te,aq as bt,af as Ce,ag as we,q as oe,aj as vt,f as pt,h as yt,aB as xt,bS as _t,aQ as Ct,aU as wt,aL as kt,aP as St,W as qt,ba as jt,a9 as Ot,a7 as Et,V as Ze,ap as Tt,ai as Qt,a8 as Ye,T as It,bT as Nt}from"./index-BnG112Dc.js";import{Q as Le,b as Dt}from"./QChip-DV9Zibsx.js";import{Q as zt}from"./QScrollObserver-L0mLXO5R.js";import{Q as Lt}from"./QResizeObserver-CJJv4em9.js";import{f as Pt,i as Rt}from"./date-CY3ZM-xo.js";import{Q as At}from"./QSpinnerDots-BPlGTbzg.js";import{Q as Mt,d as Bt,U as Ft}from"./BrowserInfoDialog-C0P5e9W2.js";import{Q as Xe}from"./QItemLabel-BiFQo7df.js";import{Q as Ht}from"./QExpansionItem-Bm4pm3Pe.js";import{T as Ut}from"./QSpinnerRings-Bvdf6X-5.js";import{u as st}from"./use-dialog-plugin-component-9YtShkh-.js";import{P as Wt}from"./crypto-BZzo7nTD.js";import{Q as Vt}from"./QTooltip-B7fpT8zQ.js";import{a as Kt}from"./finetune-Cz1lTJDm.js";const Jt=ht({name:"QChatMessage",props:{sent:Boolean,label:String,bgColor:String,textColor:String,name:String,avatar:String,text:Array,stamp:String,size:String,labelHtml:Boolean,nameHtml:Boolean,textHtml:Boolean,stampHtml:Boolean},setup(e,{slots:r}){const a=F(()=>e.sent===!0?"sent":"received"),n=F(()=>`q-message-text-content q-message-text-content--${a.value}`+(e.textColor!==void 0?` text-${e.textColor}`:"")),l=F(()=>`q-message-text q-message-text--${a.value}`+(e.bgColor!==void 0?` text-${e.bgColor}`:"")),o=F(()=>"q-message-container row items-end no-wrap"+(e.sent===!0?" reverse":"")),t=F(()=>e.size!==void 0?`col-${e.size}`:""),i=F(()=>({msg:e.textHtml===!0?"innerHTML":"textContent",stamp:e.stampHtml===!0?"innerHTML":"textContent",name:e.nameHtml===!0?"innerHTML":"textContent",label:e.labelHtml===!0?"innerHTML":"textContent"}));function v(b){return r.stamp!==void 0?[b,R("div",{class:"q-message-stamp"},r.stamp())]:e.stamp?[b,R("div",{class:"q-message-stamp",[i.value.stamp]:e.stamp})]:[b]}function _(b,k){const g=k===!0?b.length>1?u=>u:u=>R("div",[u]):u=>R("div",{[i.value.msg]:u});return b.map((u,q)=>R("div",{key:q,class:l.value},[R("div",{class:n.value},v(g(u)))]))}return()=>{const b=[];r.avatar!==void 0?b.push(r.avatar()):e.avatar!==void 0&&b.push(R("img",{class:`q-message-avatar q-message-avatar--${a.value}`,src:e.avatar,"aria-hidden":"true"}));const k=[];r.name!==void 0?k.push(R("div",{class:`q-message-name q-message-name--${a.value}`},r.name())):e.name!==void 0&&k.push(R("div",{class:`q-message-name q-message-name--${a.value}`,[i.value.name]:e.name})),r.default!==void 0?k.push(_(gt(r.default()),!0)):e.text!==void 0&&k.push(_(e.text)),b.push(R("div",{class:t.value},k));const g=[];return r.label!==void 0?g.push(R("div",{class:"q-message-label"},r.label())):e.label!==void 0&&g.push(R("div",{class:"q-message-label",[i.value.label]:e.label})),g.push(R("div",{class:o.value},b)),R("div",{class:`q-message q-message-${a.value}`},g)}}}),Zt=Ne({__name:"MessageComponent",props:{message:{},width:{},index:{},disabled:{type:Boolean}},setup(e,{expose:r}){r();const a=e,n=at(),{t:l}=De(),o=rt(),{user:t}=ke(o),i=st(),v=ie(!1),_=F(()=>a.message.role==="user"),b=F(()=>a.message.role==="assistant"),k=F(()=>{var w;return((w=a.message.usage)==null?void 0:w.total_tokens)||0}),g=F(()=>{const w=a.message.content,x="<think>",L="</think>";if(w.includes(x))if(w.includes(L)){const z=/<think>(.*?)<\/think>/s,Z=w.match(z);if(Z)return Z[1]}else return w.substring(w.indexOf(x)+x.length);return""}),u=F(()=>a.message.content.includes("<think>")&&!a.message.content.includes("</think>")),q=F(()=>{const w=a.message.content;let x="";const L="</think>";return w.includes(L)?x=w.substring(w.indexOf(L)+L.length):w.includes("<think>")||(x=w),x.replace(/<references>|<\/references>/g,"")}),c={props:a,$q:n,t:l,userStore:o,user:t,embeddingStore:i,isLoading:v,isUserRole:_,isAssistantRole:b,tokens:k,think:g,isThinking:u,answer:q,onPurchase:()=>{n.dialog({component:Wt,componentProps:{purchaseKey:i.apiKey}})},TypingText:Ut,get formatNumber(){return Pt}};return Object.defineProperty(c,"__isScriptSetup",{enumerable:!1,value:!0}),c}}),Yt={key:0},Xt={key:1,class:"relative-position"};function Gt(e,r,a,n,l,o){return C(),O(Jt,{class:vt(["q-pa-md q-pb-lg relative-position message",n.isUserRole?"user-message":"assistant-message"]),sent:n.isUserRole,"text-color":"white"},{avatar:S(()=>{var t;return[n.isUserRole?(C(),se(ge,{key:0},[(t=n.user)!=null&&t.photoURL?(C(),O(be,{key:0,size:"md",round:"",class:"bordered-avatar q-ml-md"},{default:S(()=>[j(Le,{src:n.user.photoURL,referrerpolicy:"no-referrer",alt:n.user.displayName||""},null,8,["src","alt"])]),_:1})):(C(),O(be,{key:1,icon:"person",size:"md",class:"bordered-avatar q-ml-md"}))],64)):(C(),O(be,{key:1,icon:"img:/J.svg",class:"bordered-avatar q-mr-md bg-mixed-200",size:"md"}))]}),stamp:S(()=>[n.tokens?(C(),O(Dt,{key:0,icon:"straighten",label:`${n.formatNumber(n.tokens)} ${n.t("embedding.tokens")}`,size:"sm",class:"text-dim bg-transparent"},null,8,["label"])):ce("",!0)]),default:S(()=>[n.isUserRole?(C(),se("div",Yt,[j(n.TypingText,{text:a.message.content,dark:n.isAssistantRole},null,8,["text","dark"])])):(C(),se("div",Xt,[a.message.content.length?(C(),se(ge,{key:1},[n.isLoading||!n.isLoading&&a.message.content.includes("<think>")?(C(),O(Ht,{key:0,class:"full-width","expand-separator":"","model-value":n.isThinking,"header-class":"bg-mixed-200 text-black"},{header:S(()=>[j(Je,{class:"full-width",dense:""},{default:S(()=>[j(Te,{side:""},{default:S(()=>[n.isThinking?(C(),O(Mt,{key:0})):(C(),O(bt,{key:1,name:"task_alt"}))]),_:1}),j(Te,null,{default:S(()=>[n.isThinking?(C(),O(Xe,{key:0},{default:S(()=>[Ce(we(n.t("deepsearch.chat_ui.thinking")),1)]),_:1})):(C(),O(Xe,{key:1},{default:S(()=>[Ce(we(n.t("deepsearch.chat_ui.thinking_done")),1)]),_:1}))]),_:1})]),_:1})]),default:S(()=>[j(Je,{class:"q-pa-lg"},{default:S(()=>[j(Te,{class:"text-dim",style:{"font-family":"monospace"}},{default:S(()=>[Ce(we(n.think),1)]),_:1})]),_:1})]),_:1},8,["model-value"])):ce("",!0),n.answer?(C(),O(n.TypingText,{key:1,text:n.answer,loading:n.isLoading,"content-class":"q-ma-md"},null,8,["text","loading","content-class"])):ce("",!0),a.message.statusCode===402?(C(),se(ge,{key:2},[j(oe,{color:"primary",square:"",outline:"",label:n.t("deepsearch.chat_ui.purchase"),onClick:n.onPurchase,icon:"shopping_cart",class:"q-ma-sm"},null,8,["label"]),j(oe,{color:"white",square:"",outline:"",label:n.t("deepsearch.chat_ui.keyman"),to:"/api-dashboard/key-manager",icon:"key",class:"q-ma-sm"},null,8,["label"])],64)):ce("",!0)],64)):(C(),O(At,{key:0,size:"md",class:"q-ma-md"}))]))]),_:1},8,["class","sent"])}const $t=ze(Zt,[["render",Gt],["__file","MessageComponent.vue"]]),en=(e,r)=>{if(e.shiftKey&&e.key==="Enter")return 13;e.key==="Enter"&&(e.preventDefault(),r())},tn={},nn=Object.freeze(Object.defineProperty({__proto__:null,default:tn},Symbol.toStringTag,{value:"Module"})),rn=pt(nn);var an=rn;function sn(e,r){var a,n="",l=0,o=!0,t=0,i;function v(){return i=e.charAt(t),t++,i}for(v(),i==="-"&&(n="-",v());i>="0"&&i<="9";)o&&(i=="0"?l++:o=!1),n+=i,v();if(o&&l--,i===".")for(n+=".";v()&&i>="0"&&i<="9";)n+=i;if(i==="e"||i==="E")for(n+=i,v(),(i==="-"||i==="+")&&(n+=i,v());i>="0"&&i<="9";)n+=i,v();for(;i&&i<=" ";)v();if(r&&(i===","||i==="}"||i==="]"||i==="#"||i==="/"&&(e[t]==="/"||e[t]==="*"))&&(i=0),a=+n,!(i||l||!isFinite(a)))return a}function on(e,r){return Object.defineProperty&&Object.defineProperty(e,"__COMMENTS__",{enumerable:!1,writable:!0}),e.__COMMENTS__=r||{}}function ln(e){Object.defineProperty(e,"__COMMENTS__",{value:void 0})}function fn(e){return e.__COMMENTS__}function un(e){if(!e)return"";var r=e.split(`
`),a,n,l,o;for(l=0;l<r.length;l++)for(a=r[l],o=a.length,n=0;n<o;n++){var t=a[n];if(t==="#")break;if(t==="/"&&(a[n+1]==="/"||a[n+1]==="*")){a[n+1]==="*"&&(l=r.length);break}else if(t>" "){r[l]="# "+a;break}}return r.join(`
`)}var qe={EOL:an.EOL||`
`,tryParseNumber:sn,createComment:on,removeComment:ln,getComment:fn,forceComment:un},cn="3.2.1";function mn(e,r){if(Object.prototype.toString.apply(e)!=="[object Array]"){if(e)throw new Error("dsf option must contain an array!");return Ge}else if(e.length===0)return Ge;var a=[];function n(l){return{}.toString.call(l)==="[object Function]"}return e.forEach(function(l){if(!l.name||!n(l.parse)||!n(l.stringify))throw new Error("extension does not match the DSF interface");a.push(function(){try{if(r=="parse")return l.parse.apply(null,arguments);if(r=="stringify"){var o=l.stringify.apply(null,arguments);if(o!==void 0&&(typeof o!="string"||o.length===0||o[0]==='"'||[].some.call(o,function(t){return hn(t)})))throw new Error("value may not be empty, start with a quote or contain a punctuator character except colon: "+o);return o}else throw new Error("Invalid type")}catch(t){throw new Error("DSF-"+l.name+" failed; "+t.message)}})}),dn.bind(null,a)}function dn(e,r){if(e)for(var a=0;a<e.length;a++){var n=e[a](r);if(n!==void 0)return n}}function Ge(){}function hn(e){return e==="{"||e==="}"||e==="["||e==="]"||e===","}function it(){return{name:"math",parse:function(e){switch(e){case"+inf":case"inf":case"+Inf":case"Inf":return 1/0;case"-inf":case"-Inf":return-1/0;case"nan":case"NaN":return NaN}},stringify:function(e){if(typeof e=="number"){if(1/e===-1/0)return"-0";if(e===1/0)return"Inf";if(e===-1/0)return"-Inf";if(isNaN(e))return"NaN"}}}}it.description="support for Inf/inf, -Inf/-inf, Nan/naN and -0";function ot(e){var r=e&&e.out;return{name:"hex",parse:function(a){if(/^0x[0-9A-Fa-f]+$/.test(a))return parseInt(a,16)},stringify:function(a){if(r&&Number.isInteger(a))return"0x"+a.toString(16)}}}ot.description="parse hexadecimal numbers prefixed with 0x";function lt(){return{name:"date",parse:function(e){if(/^\d{4}-\d{2}-\d{2}$/.test(e)||/^\d{4}-\d{2}-\d{2}T\d{2}\:\d{2}\:\d{2}(?:.\d+)(?:Z|[+-]\d{2}:\d{2})$/.test(e)){var r=Date.parse(e);if(!isNaN(r))return new Date(r)}},stringify:function(e){if(Object.prototype.toString.call(e)==="[object Date]"){var r=e.toISOString();return r.indexOf("T00:00:00.000Z",r.length-14)!==-1?r.substr(0,10):r}}}}lt.description="support ISO dates";var Pe={loadDsf:mn,std:{math:it,hex:ot,date:lt}},gn=function(e,r){var a=qe,n=Pe,l,o,t,i={'"':'"',"'":"'","\\":"\\","/":"/",b:"\b",f:"\f",n:`
`,r:"\r",t:"	"},v,_;function b(){o=0,t=" "}function k(s){return s==="{"||s==="}"||s==="["||s==="]"||s===","||s===":"}function g(s){var d,f=0,m=1;for(d=o-1;d>0&&l[d]!==`
`;d--,f++);for(;d>0;d--)l[d]===`
`&&m++;throw new Error(s+" at line "+m+","+f+" >>>"+l.substr(o-f,20)+" ...")}function u(){return t=l.charAt(o),o++,t}function q(s){return l.charAt(o+s)}function Q(s){for(var d="",f=t;u();){if(t===f)return u(),s&&f==="'"&&t==="'"&&d.length===0?(u(),c()):d;if(t==="\\")if(u(),t==="u"){for(var m=0,p=0;p<4;p++){u();var y=t.charCodeAt(0),I;t>="0"&&t<="9"?I=y-48:t>="a"&&t<="f"?I=y-97+10:t>="A"&&t<="F"?I=y-65+10:g("Bad \\u char "+t),m=m*16+I}d+=String.fromCharCode(m)}else if(typeof i[t]=="string")d+=i[t];else break;else t===`
`||t==="\r"?g("Bad string containing newline"):d+=t}g("Bad string")}function c(){for(var s="",d=0,f=0;;){var m=q(-f-5);if(!m||m===`
`)break;f++}function p(){for(var y=f;t&&t<=" "&&t!==`
`&&y-- >0;)u()}for(;t&&t<=" "&&t!==`
`;)u();for(t===`
`&&(u(),p());;){if(!t)g("Bad multiline string");else if(t==="'"){if(d++,u(),d===3)return s.slice(-1)===`
`&&(s=s.slice(0,-1)),s;continue}else for(;d>0;)s+="'",d--;t===`
`?(s+=`
`,u(),p()):(t!=="\r"&&(s+=t),u())}}function w(){if(t==='"'||t==="'")return Q(!1);for(var s="",d=o,f=-1;;){if(t===":")return s?f>=0&&f!==s.length&&(o=d+f,g("Found whitespace in your key name (use quotes to include)")):g("Found ':' but no key name (for an empty key name use quotes)"),s;t<=" "?t?f<0&&(f=s.length):g("Found EOF while looking for a key name (check your syntax)"):k(t)?g("Found '"+t+"' where a key name was expected (check your syntax or use quotes if the key name includes {}[],: or whitespace)"):s+=t,u()}}function x(){for(;t;){for(;t&&t<=" ";)u();if(t==="#"||t==="/"&&q(0)==="/")for(;t&&t!==`
`;)u();else if(t==="/"&&q(0)==="*"){for(u(),u();t&&!(t==="*"&&q(0)==="/");)u();t&&(u(),u())}else break}}function L(){var s=t;for(k(t)&&g("Found a punctuator character '"+t+"' when expecting a quoteless string (check your syntax)");;){u();var d=t==="\r"||t===`
`||t==="";if(d||t===","||t==="}"||t==="]"||t==="#"||t==="/"&&(q(0)==="/"||q(0)==="*")){var f=s[0];switch(f){case"f":if(s.trim()==="false")return!1;break;case"n":if(s.trim()==="null")return null;break;case"t":if(s.trim()==="true")return!0;break;default:if(f==="-"||f>="0"&&f<="9"){var m=a.tryParseNumber(s);if(m!==void 0)return m}}if(d){s=s.trim();var p=_(s);return p!==void 0?p:s}}s+=t}}function z(s,d){var f;for(s--,f=o-2;f>s&&l[f]<=" "&&l[f]!==`
`;f--);l[f]===`
`&&f--,l[f]==="\r"&&f--;var m=l.substr(s,f-s+1);for(f=0;f<m.length;f++)if(m[f]>" "){var p=m.indexOf(`
`);if(p>=0){var y=[m.substr(0,p),m.substr(p+1)];return d&&y[0].trim().length===0&&y.shift(),y}else return[m]}return[]}function Z(s){function d(m,p){var y,I,M,h;switch(typeof m){case"string":m.indexOf(p)>=0&&(h=m);break;case"object":if(Object.prototype.toString.apply(m)==="[object Array]")for(y=0,M=m.length;y<M;y++)h=d(m[y],p)||h;else for(I in m)Object.prototype.hasOwnProperty.call(m,I)&&(h=d(m[I],p)||h)}return h}function f(m){var p=d(s,m);return p?"found '"+m+`' in a string value, your mistake could be with:
  > `+p+`
  (unquoted strings contain everything up to the next line!)`:""}return f("}")||f("]")}function Y(){var s=[],d,f,m;try{if(v&&(d=a.createComment(s,{a:[]})),u(),f=o,x(),d&&(m=z(f,!0).join(`
`)),t==="]")return u(),d&&(d.e=[m]),s;for(;t;){if(s.push(ne()),f=o,x(),t===","&&(u(),f=o,x()),d){var p=z(f);d.a.push([m||"",p[0]||""]),m=p[1]}if(t==="]")return u(),d&&(d.a[d.a.length-1][1]+=m||""),s;x()}g("End of input while parsing an array (missing ']')")}catch(y){throw y.hint=y.hint||Z(s),y}}function te(s){var d="",f={},m,p,y;try{if(v&&(m=a.createComment(f,{c:{},o:[]})),s?p=1:(u(),p=o),x(),m&&(y=z(p,!0).join(`
`)),t==="}"&&!s)return m&&(m.e=[y]),u(),f;for(;t;){if(d=w(),x(),t!==":"&&g("Expected ':' instead of '"+t+"'"),u(),f[d]=ne(),p=o,x(),t===","&&(u(),p=o,x()),m){var I=z(p);m.c[d]=[y||"",I[0]||""],y=I[1],m.o.push(d)}if(t==="}"&&!s)return u(),m&&(m.c[d][1]+=y||""),f;x()}if(s)return f;g("End of input while parsing an object (missing '}')")}catch(M){throw M.hint=M.hint||Z(f),M}}function ne(){switch(x(),t){case"{":return te();case"[":return Y();case"'":case'"':return Q(!0);default:return L()}}function W(s,d){var f=o;if(x(),t&&g("Syntax error, found trailing characters"),v){var m=d.join(`
`),p=z(f).join(`
`);if(p||m){var y=a.createComment(s,a.getComment(s));y.r=[m,p]}}return s}function je(){x();var s=v?z(1):null;switch(t){case"{":return W(te(),s);case"[":return W(Y(),s);default:return W(ne(),s)}}function Oe(){x();var s=v?z(1):null;switch(t){case"{":return W(te(),s);case"[":return W(Y(),s)}try{return W(te(!0),s)}catch(d){b();try{return W(ne(),s)}catch{throw d}}}if(typeof e!="string")throw new Error("source is not a string");var $=null,A=!0;return r&&typeof r=="object"&&(v=r.keepWsc,$=r.dsf,A=r.legacyRoot!==!1),_=n.loadDsf($,"parse"),l=e,b(),A?Oe():je()},bn=function(e,r){var a=qe,n=Pe,l={obj:["{","}"],arr:["[","]"],key:["",""],qkey:['"','"'],col:[":",""],com:[",",""],str:["",""],qstr:['"','"'],mstr:["'''","'''"],num:["",""],lit:["",""],dsf:["",""],esc:["\\",""],uni:["\\u",""],rem:["",""]},o=a.EOL,t="  ",i=!1,v=!1,_=!1,b=!1,k=0,g=1,u="",q=null,Q=!1,c=l;if(r&&typeof r=="object"){r.quotes=r.quotes==="always"?"strings":r.quotes,(r.eol===`
`||r.eol===`\r
`)&&(o=r.eol),i=r.keepWsc,k=r.condense||0,v=r.bracesSameLine,_=r.quotes==="all"||r.quotes==="keys",b=r.quotes==="all"||r.quotes==="strings"||r.separator===!0,b||r.multiline=="off"?g=0:g=r.multiline=="no-tabs"?2:1,u=r.separator===!0?c.com[0]:"",q=r.dsf,Q=r.sortProps,typeof r.space=="number"?t=new Array(r.space+1).join(" "):typeof r.space=="string"&&(t=r.space),r.colors===!0&&(c={obj:["\x1B[37m{\x1B[0m","\x1B[37m}\x1B[0m"],arr:["\x1B[37m[\x1B[0m","\x1B[37m]\x1B[0m"],key:["\x1B[33m","\x1B[0m"],qkey:['\x1B[33m"','"\x1B[0m'],col:["\x1B[37m:\x1B[0m",""],com:["\x1B[37m,\x1B[0m",""],str:["\x1B[37;1m","\x1B[0m"],qstr:['\x1B[37;1m"','"\x1B[0m'],mstr:["\x1B[37;1m'''","'''\x1B[0m"],num:["\x1B[36;1m","\x1B[0m"],lit:["\x1B[36m","\x1B[0m"],dsf:["\x1B[37m","\x1B[0m"],esc:["\x1B[31m\\","\x1B[0m"],uni:["\x1B[31m\\u","\x1B[0m"],rem:["\x1B[35m","\x1B[0m"]});var w,x=Object.keys(l);for(w=x.length-1;w>=0;w--){var L=x[w];c[L].push(l[L][0].length,l[L][1].length)}}var z,Z="-­؀-؄܏឴឵‌-‏\u2028- ⁠-⁯\uFEFF￰-￿",Y=new RegExp('[\\\\\\"\0-'+Z+"]","g"),te=new RegExp(`^\\s|^"|^'|^#|^\\/\\*|^\\/\\/|^\\{|^\\}|^\\[|^\\]|^:|^,|\\s$|[\0-`+Z+"]","g"),ne=new RegExp("'''|^[\\s]+$|[\0-"+(g===2?"	":"\b")+"\v\f-"+Z+"]","g"),W=new RegExp("^(true|false|null)\\s*((,|\\]|\\}|#|//|/\\*).*)?$"),je={"\b":"b","	":"t","\n":"n","\f":"f","\r":"r",'"':'"',"\\":"\\"},Oe=/[,\{\[\}\]\s:#"']|\/\/|\/\*/,$="",A=0;function s(h,B){return A+=h[0].length+h[1].length-h[2]-h[3],h[0]+B+h[1]}function d(h){return h.replace(Y,function(B){var H=je[B];return typeof H=="string"?s(c.esc,H):s(c.uni,("0000"+B.charCodeAt(0).toString(16)).slice(-4))})}function f(h,B,H,X){return h?(te.lastIndex=0,W.lastIndex=0,b||H||te.test(h)||a.tryParseNumber(h,!0)!==void 0||W.test(h)?(Y.lastIndex=0,ne.lastIndex=0,Y.test(h)?!ne.test(h)&&!X&&g?m(h,B):s(c.qstr,d(h)):s(c.qstr,h)):s(c.str,h)):s(c.qstr,"")}function m(h,B){var H,X=h.replace(/\r/g,"").split(`
`);if(B+=t,X.length===1)return s(c.mstr,X[0]);var le=o+B+c.mstr[0];for(H=0;H<X.length;H++)le+=o,X[H]&&(le+=B+X[H]);return le+o+B+c.mstr[1]}function p(h){return h?_||Oe.test(h)?(Y.lastIndex=0,s(c.qkey,Y.test(h)?d(h):h)):s(c.key,h):'""'}function y(h,B,H,X){function le(D){return D&&D[D[0]==="\r"?1:0]===`
`}function Re(D){return D&&!le(D)}function fe(D,mt,dt){if(!D)return"";D=a.forceComment(D);var ae,Ke=D.length;for(ae=0;ae<Ke&&D[ae]<=" ";ae++);return dt&&ae>0&&(D=D.substr(ae)),ae<Ke?mt+s(c.rem,D):D}var Ae=z(h);if(Ae!==void 0)return s(c.dsf,Ae);switch(typeof h){case"string":return f(h,$,B,X);case"number":return isFinite(h)?s(c.num,String(h)):s(c.lit,"null");case"boolean":return s(c.lit,String(h));case"object":if(!h)return s(c.lit,"null");var T;i&&(T=a.getComment(h));var ct=Object.prototype.toString.apply(h)==="[object Array]",Me=$;$+=t;var de=o+Me,xe=o+$,Be=H||v?"":de,E=[],V,N=k?[]:null,Fe=b,He=g,Ue=u?"":c.com[0],_e=0,U,ee,G,K,he,P,J,re,ue;if(ct){for(U=0,ee=h.length;U<ee;U++){if(V=U<ee-1,T?(P=T.a[U]||[],J=Re(P[1]),E.push(fe(P[0],`
`)+xe),N&&(P[0]||P[1]||J)&&(N=null)):E.push(xe),A=0,K=h[U],E.push(y(K,T?J:!1,!0)+(V?u:"")),N){switch(typeof K){case"string":A=0,b=!0,g=0,N.push(y(K,!1,!0)+(V?c.com[0]:"")),b=Fe,g=He;break;case"object":if(K){N=null;break}default:N.push(E[E.length-1]+(V?Ue:""));break}V&&(A+=c.com[0].length-c.com[2]),_e+=A}T&&P[1]&&E.push(fe(P[1],J?" ":`
`,J))}ee===0?T&&T.e&&E.push(fe(T.e[0],`
`)+de):E.push(de),E.length===0?re=s(c.arr,""):(re=Be+s(c.arr,E.join("")),N&&(ue=N.join(" "),ue.length-_e<=k&&(re=s(c.arr,ue))))}else{var We=T?T.o.slice():[],Ee=[];for(G in h)Object.prototype.hasOwnProperty.call(h,G)&&We.indexOf(G)<0&&Ee.push(G);Q&&Ee.sort();var Ve=We.concat(Ee);for(U=0,ee=Ve.length;U<ee;U++)if(V=U<ee-1,G=Ve[U],T?(P=T.c[G]||[],J=Re(P[1]),E.push(fe(P[0],`
`)+xe),N&&(P[0]||P[1]||J)&&(N=null)):E.push(xe),A=0,K=h[G],he=y(K,T&&J),E.push(p(G)+c.col[0]+(le(he)?"":" ")+he+(V?u:"")),T&&P[1]&&E.push(fe(P[1],J?" ":`
`,J)),N){switch(typeof K){case"string":A=0,b=!0,g=0,he=y(K,!1),b=Fe,g=He,N.push(p(G)+c.col[0]+" "+he+(V?c.com[0]:""));break;case"object":if(K){N=null;break}default:N.push(E[E.length-1]+(V?Ue:""));break}A+=c.col[0].length-c.col[2],V&&(A+=c.com[0].length-c.com[2]),_e+=A}ee===0?T&&T.e&&E.push(fe(T.e[0],`
`)+de):E.push(de),E.length===0?re=s(c.obj,""):(re=Be+s(c.obj,E.join("")),N&&(ue=N.join(" "),ue.length-_e<=k&&(re=s(c.obj,ue))))}return $=Me,re}}z=n.loadDsf(q,"stringify");var I="",M=i?M=(a.getComment(e)||{}).r:null;return M&&M[0]&&(I=M[0]+`
`),I+=y(e,null,!0,!0),M&&(I+=M[1]||""),I},me=qe;function ve(e,r,a){var n;return e&&(n={b:e}),r&&((n=n||{}).a=r),a&&((n=n||{}).x=a),n}function Qe(e,r){if(!(e===null||typeof e!="object")){var a=me.getComment(e);a&&me.removeComment(e);var n,l,o,t;if(Object.prototype.toString.apply(e)==="[object Array]"){for(t={a:{}},n=0,l=e.length;n<l;n++)$e(t.a,n,a.a[n],Qe(e[n]))&&(o=!0);!o&&a.e&&(t.e=ve(a.e[0],a.e[1]),o=!0)}else{t={s:{}};var i,v=Object.keys(e);for(a&&a.o?(i=[],a.o.concat(v).forEach(function(b){Object.prototype.hasOwnProperty.call(e,b)&&i.indexOf(b)<0&&i.push(b)})):i=v,t.o=i,n=0,l=i.length;n<l;n++){var _=i[n];$e(t.s,_,a.c[_],Qe(e[_]))&&(o=!0)}!o&&a.e&&(t.e=ve(a.e[0],a.e[1]),o=!0)}return r&&a&&a.r&&(t.r=ve(a.r[0],a.r[1])),o?t:void 0}}function vn(){var e="";return[].forEach.call(arguments,function(r){r&&r.trim()!==""&&(e&&(e+="; "),e+=r.trim())}),e}function pn(e,r){var a=[];if(Ie(e,r,a,[]),a.length>0){var n=Se(r,null,1);n+=`
# Orphaned comments:
`,a.forEach(function(l){n+=("# "+l.path.join("/")+": "+vn(l.b,l.a,l.e)).replace(`
`,"\\n ")+`
`}),Se(r,n,1)}}function $e(e,r,a,n){var l=ve(a?a[0]:void 0,a?a[1]:void 0,n);return l&&(e[r]=l),l}function pe(e,r){var a=ve(r.b,r.a);return a.path=e,a}function ye(e,r,a){if(e){var n,l;if(e.a)for(n=0,l=e.a.length;n<l;n++){var o=a.slice().concat([n]),t=e.a[n];t&&(r.push(pe(o,t)),ye(t.x,r,o))}else e.o&&e.o.forEach(function(i){var v=a.slice().concat([i]),_=e.s[i];_&&(r.push(pe(v,_)),ye(_.x,r,v))});e.e&&r.push(pe(a,e.e))}}function Ie(e,r,a,n){if(e){if(r===null||typeof r!="object"){ye(e,a,n);return}var l,o=me.createComment(r);if(n.length===0&&e.r&&(o.r=[e.r.b,e.r.a]),Object.prototype.toString.apply(r)==="[object Array]"){o.a=[];var t=e.a||{};for(var i in t)if(t.hasOwnProperty(i)){l=parseInt(i);var v=e.a[i];if(v){var _=n.slice().concat([l]);l<r.length?(o.a[l]=[v.b,v.a],Ie(v.x,r[l],a,_)):(a.push(pe(_,v)),ye(v.x,a,_))}}l===0&&e.e&&(o.e=[e.e.b,e.e.a])}else o.c={},o.o=[],(e.o||[]).forEach(function(b){var k=n.slice().concat([b]),g=e.s[b];Object.prototype.hasOwnProperty.call(r,b)?(o.o.push(b),g&&(o.c[b]=[g.b,g.a],Ie(g.x,r[b],a,k))):g&&(a.push(pe(k,g)),ye(g.x,a,k))}),e.e&&(o.e=[e.e.b,e.e.a])}}function Se(e,r,a){var n=me.createComment(e,me.getComment(e));return n.r||(n.r=["",""]),(r||r==="")&&(n.r[a]=me.forceComment(r)),n.r[a]||""}var yn={extract:function(e){return Qe(e,!0)},merge:pn,header:function(e,r){return Se(e,r,0)},footer:function(e,r){return Se(e,r,1)}};/*!
 * Hjson v3.2.1
 * https://hjson.github.io
 *
 * Copyright 2014-2017 Christian Zangl, MIT license
 * Details and documentation:
 * https://github.com/hjson/hjson-js
 *
 * This code is based on the the JSON version by Douglas Crockford:
 * https://github.com/douglascrockford/JSON-js (json_parse.js, json2.js)
 */var et=qe,xn=cn,tt=gn,nt=bn,_n=yn,Cn=Pe,wn={parse:tt,stringify:nt,endOfLine:function(){return et.EOL},setEndOfLine:function(e){(e===`
`||e===`\r
`)&&(et.EOL=e)},version:xn,rt:{parse:function(e,r){return(r=r||{}).keepWsc=!0,tt(e,r)},stringify:function(e,r){return(r=r||{}).keepWsc=!0,nt(e,r)}},comments:_n,dsf:Cn.std};const kn=yt(wn),Sn="https://deepsearch.jina.ai",ft=xt("chatStore",{state:()=>({messages:[],response:[],isLoading:!1,isStreaming:!1,abortController:void 0}),getters:{usage:e=>{var r;return(r=e.response[e.response.length-1])==null?void 0:r.usage}},actions:{async send(e,r,a){var n;if(!this.isLoading){this.abortController=new AbortController,this.isLoading=!0;try{this.messages.push({role:"user",content:e,timestamp:Date.now()});const l={model:a,messages:this.messages.concat().filter(i=>!i.statusCode||i.statusCode===200),stream:!0};this.messages.push({role:"assistant",content:"",timestamp:Date.now()});const o=await fetch(`${Sn}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(l),signal:this.abortController.signal}),t=this.messages[this.messages.length-1];if(t.statusCode=o.status,t.timestamp=Date.now(),(n=o.headers.get("content-type"))!=null&&n.includes("text/event-stream")){if(o.body){const i=o.body.getReader(),v=new TextDecoder;for(;;){const{done:_,value:b}=await i.read();if(_){this.isLoading=!1,this.isStreaming=!1;break}if(b){this.isStreaming=!0;const g=v.decode(b).split(`

data:`).filter(Boolean);let u="";g.forEach(q=>{const Q=q.replace(/data: /,"").trim().replace(/\n/g,"\\\\n");u+=Q,console.log("Data:",u);try{if(u){const c=kn.parse(u);u="",this.response.push(c),t.content+=c.choices[0].delta.content,c.usage&&(t.usage=c.usage)}}catch(c){console.error("Error parsing full JSON:",c)}})}}}}else{const i=await o.json();i&&(this.response=[i],this.messages.push(i.choices[0].message))}}catch(l){if(l.name!=="AbortError"){let o=l instanceof Error?l.message:String(l);this.messages[this.messages.length-1].statusCode===402&&(o=this.t("deepsearch.chat_ui.payment_required")),this.messages[this.messages.length-1].content=o,this.messages[this.messages.length-1].timestamp=Date.now(),_t.create({message:o,color:"negative",icon:"error"})}}finally{this.isLoading=!1,this.isStreaming=!1}}},cancel(){var r;(r=this.abortController)==null||r.abort(),this.isLoading=!1,this.messages[this.messages.length-1].role==="assistant"&&this.messages.pop()}}}),qn=Ne({__name:"InputComponent",props:{maximizedWindow:{type:Boolean,default:!1},query:{type:String,default:""}},setup(e,{expose:r}){const{t:a}=De({useScope:"global"}),n=at(),l=ie(),o=ie(""),t=ft(),{isLoading:i,messages:v}=ke(t),_=st(),b=rt(),{user:k}=ke(b),g=e,u=F(()=>!(typeof w(o.value)=="string"||i.value)),q=()=>{u.value&&(t.send(o.value,_.apiKey,"jina-deepsearch-v1"),x())},Q=()=>{i.value=!1,t.cancel()},c=()=>{n.dialog({title:a("deepsearch.chat_ui.clear_context_title"),message:a("deepsearch.chat_ui.clear_context_message"),cancel:!0}).onOk(()=>{v.value=[]})},w=z=>z.trim().length===0?a("deepsearch.chat_ui.input_cant_be_empty"):!0,x=()=>{o.value=""};r({reset:x}),Ct(()=>{g.query&&(o.value=g.query)});const L={t:a,$q:n,form:l,inputMessage:o,chatStore:t,isLoading:i,messages:v,embeddingStore:_,userStore:b,user:k,props:g,sendable:u,onSubmit:q,onCancel:Q,onClear:c,validateInput:w,reset:x,get QForm(){return Kt},get handleShiftEnter(){return en}};return Object.defineProperty(L,"__isScriptSetup",{enumerable:!1,value:!0}),L}});function jn(e,r,a,n,l,o){return C(),O(n.QForm,{ref:"form",class:"full-width",onSubmit:St(n.onSubmit,["prevent"])},{default:S(()=>[j(wt,{class:"full-height q-mb-xs",modelValue:n.inputMessage,"onUpdate:modelValue":[r[1]||(r[1]=t=>n.inputMessage=t),t=>{}],filled:"",autofocus:"",square:"",autogrow:"","hide-bottom-space":"","lazy-rules":"ondemand",rules:[n.validateInput],onKeydown:r[2]||(r[2]=t=>n.handleShiftEnter(t,()=>{var i;return(i=n.form)==null?void 0:i.submit(t)})),ref:"inputAnchor","input-style":"max-height: 50vh;",placeholder:n.t("deepsearch.chat_ui.input_placeholder")},kt({prepend:S(()=>[j(oe,{flat:"",round:"",icon:"add_comment",disable:n.isLoading||!n.messages.length,onClick:n.onClear},{default:S(()=>[j(Vt,null,{default:S(()=>[Ce(we(n.t("deepsearch.chat_ui.new_chat")),1)]),_:1})]),_:1},8,["disable"])]),append:S(()=>[n.isLoading?(C(),O(oe,{key:0,flat:"",round:"",icon:"o_stop_circle",color:"negative",onClick:n.onCancel})):(C(),O(oe,{key:1,flat:"",round:"",icon:"send",color:n.sendable?"primary":"grey",disable:!n.sendable||n.isLoading,onClick:r[0]||(r[0]=t=>{var i;return(i=n.form)==null?void 0:i.submit(t)})},null,8,["color","disable"]))]),_:2},[a.maximizedWindow?void 0:{name:"before",fn:S(()=>{var t;return[(t=n.user)!=null&&t.photoURL?(C(),O(be,{key:0,size:"md",round:"",class:"bordered-avatar q-ml-md"},{default:S(()=>[j(Le,{src:n.user.photoURL,referrerpolicy:"no-referrer",alt:n.user.displayName||""},null,8,["src","alt"])]),_:1})):(C(),O(be,{key:1,icon:"person",size:"md",class:"bordered-avatar q-ml-md"}))]}),key:"0"}]),1032,["modelValue","rules","placeholder"])]),_:1},512)}const On=ze(qn,[["render",jn],["__file","InputComponent.vue"]]);var ut=(e=>(e[e.TOP=0]="TOP",e[e.BOTTOM=1]="BOTTOM",e))(ut||{});const En=Ne({__name:"ChatComponent",props:{maximizedWindow:{type:Boolean,default:!1}},setup(e,{expose:r}){r();const{t:a}=De({useScope:"global"}),n=ft(),{messages:l,isLoading:o}=ke(n),t=ie(null),i=ie(!0),v=ie(""),_=ie(0),b=q=>{Ze(()=>{i.value&&(_.value=q.height,g(1))})},k=q=>{Ze(()=>{var w,x;const Q=(w=t.value)==null?void 0:w.$el,c=Q.offsetHeight+Q.scrollTop-Q.scrollHeight;q.direction==="up"&&((x=l.value)!=null&&x.length)&&c<-5&&(i.value=!1),q.direction==="down"&&c>=-5&&(i.value=!0)})},g=q=>{setTimeout(()=>{if(t.value&&t.value.$el){const Q=q===0?0:t.value.$el.scrollHeight;t.value.$el.scrollTo({top:Q,behavior:"smooth"})}},10)};qt(()=>{o.value=!1,l.value=[]}),jt(async()=>{i.value=!0});const u={t:a,chatStore:n,messages:l,isLoading:o,scrollTarget:t,autoScroll:i,exampleQuery:v,virtualScrollHeight:_,onResize:b,onScroll:k,SCROLL_POSITION:ut,scrollTo:g,get QVirtualScroll(){return Rt},get QCardSection(){return Ot},get QCard(){return Et},MessageComponent:$t,InputComponent:On,get deepSearchFlow(){return Bt},UsageHeader:Ft};return Object.defineProperty(u,"__isScriptSetup",{enumerable:!1,value:!0}),u}}),Tn={class:"column no-wrap"},Qn={class:"col-12"};function In(e,r,a,n,l,o){return C(),O(n.QCard,{bordered:!a.maximizedWindow,flat:"",square:"",class:"column fit relative-position no-wrap",style:{"max-height":"100vh"}},{default:S(()=>[a.maximizedWindow?(C(),se(ge,{key:0},[j(n.UsageHeader,{class:"full-width","home-link":"/deepsearch","faq-link":"/deepsearch#faq","issue-link":"https://github.com/jina-ai/node-DeepResearch/issues","is-support-c-s-p":!1,"api-link":"https://github.com/jina-ai/node-DeepResearch?tab=readme-ov-file#openai-compatible-server-api"}),j(Tt)],64)):ce("",!0),a.maximizedWindow?ce("",!0):(C(),O(oe,{key:1,flat:"",round:"",icon:"fullscreen",class:"absolute-top-left q-ml-md q-mt-md z-top",to:"/api-dashboard/deepsearch-chat"})),n.messages.length?(C(),O(n.QCardSection,{key:3,class:"column justify-between no-wrap q-px-lg scroll q-mb-xl",ref:"scrollTarget"},{default:S(()=>[j(zt,{onScroll:n.onScroll,debounce:300}),Ye("div",Tn,[j(It,{appear:"","enter-active-class":"animated fadeIn","leave-active-class":"animated fadeOut",duration:50},{default:S(()=>[Ye("div",Qn,[j(n.QVirtualScroll,{items:n.messages},{default:S(({item:t,index:i})=>[j(Lt,{onResize:n.onResize,debounce:300}),j(n.MessageComponent,{message:t,index:i},null,8,["message","index"])]),_:1},8,["items"])])]),_:1})])]),_:1},512)):(C(),O(n.QCardSection,{key:2,class:"full-height column justify-center"},{default:S(()=>[j(Le,{src:n.deepSearchFlow,"img-style":{opacity:.1},fit:"fill",class:"col-5"},null,8,["src"]),(C(),se(ge,null,Qt([1,2,3],t=>j(oe,{"no-caps":"",flat:"",label:n.t(`deepsearch.chat_ui.example_q${t}`),key:t,class:"text-dim q-py-md",onClick:i=>n.exampleQuery=n.t(`deepsearch.chat_ui.example_q${t}`)},null,8,["label","onClick"])),64))]),_:1})),j(Nt,{class:"lock-blur absolute-bottom"},{default:S(()=>[j(n.InputComponent,{maximizedWindow:a.maximizedWindow,query:n.exampleQuery},null,8,["maximizedWindow","query"])]),_:1})]),_:1},8,["bordered"])}const Kn=ze(En,[["render",In],["__file","ChatComponent.vue"]]);export{Kn as C};
