import{s as Y,m as x,p as b,ce as X,j as D,a0 as I,u as N,am as H,k as Q,n as F,a2 as V,a3 as i,a4 as h,a5 as d,aa as w,ah as M,b5 as L,a6 as l,ad as P,ae as U,aq as Z,af as j,ag as E,ab as R,q as T,aj as $,aB as ee,bS as ae,aQ as te,aU as se,aL as ne,aP as oe,W as re,ba as ie,a9 as le,a7 as ce,V as A,ap as de,ai as me,a8 as W,T as ue,bT as ge}from"./index-CahmJXAY.js";import{Q as O}from"./QChip-AIi_j3Ym.js";import{Q as he}from"./QScrollObserver-1cfkUk3J.js";import{Q as fe}from"./QResizeObserver-DnK07zGP.js";import{i as pe}from"./date-CypFhSUK.js";import{Q as ve}from"./QSpinnerDots-cEqI48Ja.js";import{Q as _e,d as be,U as ye}from"./BrowserInfoDialog-CIF3PTOm.js";import{Q as xe}from"./QItemLabel-BxNwHv0E.js";import{Q as ke}from"./QExpansionItem-BC9frj5C.js";import{T as Ce}from"./QSpinnerRings-DL8sGPbm.js";import{u as K}from"./use-dialog-plugin-component-hIPn9tpF.js";import{P as Se}from"./crypto-WGAZTYzz.js";import{Q as qe}from"./QTooltip-DN_p364K.js";import{a as we}from"./finetune-BRhYQTKU.js";const Qe=Y({name:"QChatMessage",props:{sent:Boolean,label:String,bgColor:String,textColor:String,name:String,avatar:String,text:Array,stamp:String,size:String,labelHtml:Boolean,nameHtml:Boolean,textHtml:Boolean,stampHtml:Boolean},setup(a,{slots:n}){const s=x(()=>a.sent===!0?"sent":"received"),e=x(()=>`q-message-text-content q-message-text-content--${s.value}`+(a.textColor!==void 0?` text-${a.textColor}`:"")),u=x(()=>`q-message-text q-message-text--${s.value}`+(a.bgColor!==void 0?` text-${a.bgColor}`:"")),r=x(()=>"q-message-container row items-end no-wrap"+(a.sent===!0?" reverse":"")),t=x(()=>a.size!==void 0?`col-${a.size}`:""),o=x(()=>({msg:a.textHtml===!0?"innerHTML":"textContent",stamp:a.stampHtml===!0?"innerHTML":"textContent",name:a.nameHtml===!0?"innerHTML":"textContent",label:a.labelHtml===!0?"innerHTML":"textContent"}));function C(m){return n.stamp!==void 0?[m,b("div",{class:"q-message-stamp"},n.stamp())]:a.stamp?[m,b("div",{class:"q-message-stamp",[o.value.stamp]:a.stamp})]:[m]}function k(m,_){const p=_===!0?m.length>1?f=>f:f=>b("div",[f]):f=>b("div",{[o.value.msg]:f});return m.map((f,v)=>b("div",{key:v,class:u.value},[b("div",{class:e.value},C(p(f)))]))}return()=>{const m=[];n.avatar!==void 0?m.push(n.avatar()):a.avatar!==void 0&&m.push(b("img",{class:`q-message-avatar q-message-avatar--${s.value}`,src:a.avatar,"aria-hidden":"true"}));const _=[];n.name!==void 0?_.push(b("div",{class:`q-message-name q-message-name--${s.value}`},n.name())):a.name!==void 0&&_.push(b("div",{class:`q-message-name q-message-name--${s.value}`,[o.value.name]:a.name})),n.default!==void 0?_.push(k(X(n.default()),!0)):a.text!==void 0&&_.push(k(a.text)),m.push(b("div",{class:t.value},_));const p=[];return n.label!==void 0?p.push(b("div",{class:"q-message-label"},n.label())):a.label!==void 0&&p.push(b("div",{class:"q-message-label",[o.value.label]:a.label})),p.push(b("div",{class:r.value},m)),b("div",{class:`q-message q-message-${s.value}`},p)}}}),Te=D({__name:"MessageComponent",props:{message:{},width:{},index:{},disabled:{type:Boolean}},setup(a,{expose:n}){n();const s=a,e=F(),{t:u}=I(),r=N(),{user:t}=H(r),o=K(),C=Q(!1),k=x(()=>s.message.role==="user"),m=x(()=>s.message.role==="assistant"),_=x(()=>{const c=s.message.content,g="<think>",S="</think>";if(c.includes(g))if(c.includes(S)){const z=/<think>(.*?)<\/think>/s,B=c.match(z);if(console.log(c,B),B)return B[1]}else return c.substring(c.indexOf(g)+g.length);return""}),p=x(()=>s.message.content.includes("<think>")&&!s.message.content.includes("</think>")),f=x(()=>{const c=s.message.content,g="<references>",S="</references>";if(c.includes(g))if(c.includes(S)){const z=/<references>(.*?)<\/references>/s,B=c.match(z);if(B)return B[1].split(`

`).filter(Boolean)}else return c.substring(c.indexOf(g)+g.length).split(`

`).filter(Boolean);return[]}),v=x(()=>{const c=s.message.content;let g="";const S="</think>";return c.includes(S)?g=c.substring(c.indexOf(S)+S.length):c.includes("<think>")||(g=c),g.replace(/<references>|<\/references>/g,"")}),q={props:s,$q:e,t:u,userStore:r,user:t,embeddingStore:o,isLoading:C,isUserRole:k,isAssistantRole:m,think:_,isThinking:p,references:f,answer:v,onPurchase:()=>{e.dialog({component:Se,componentProps:{purchaseKey:o.apiKey}})},TypingText:Ce};return Object.defineProperty(q,"__isScriptSetup",{enumerable:!1,value:!0}),q}}),ze={key:0},Be={key:1,class:"relative-position"};function Me(a,n,s,e,u,r){return i(),h(Qe,{class:$(["q-pa-md q-pb-lg relative-position message",e.isUserRole?"user-message":"assistant-message"]),sent:e.isUserRole,size:e.isUserRole?"auto":8,"text-color":"white"},{avatar:d(()=>{var t;return[e.isUserRole?(i(),w(M,{key:0},[(t=e.user)!=null&&t.photoURL?(i(),h(L,{key:0,size:"md",round:"",class:"bordered-avatar q-ml-md"},{default:d(()=>[l(O,{src:e.user.photoURL,referrerpolicy:"no-referrer",alt:e.user.displayName||""},null,8,["src","alt"])]),_:1})):(i(),h(L,{key:1,icon:"person",size:"md",class:"bordered-avatar q-ml-md"}))],64)):(i(),h(L,{key:1,icon:"img:/J.svg",class:"bordered-avatar q-mr-md bg-mixed-200",size:"md"}))]}),default:d(()=>[e.isUserRole?(i(),w("div",ze,[l(e.TypingText,{text:s.message.content,dark:e.isAssistantRole},null,8,["text","dark"])])):(i(),w("div",Be,[s.message.content.length?(i(),w(M,{key:1},[e.isLoading||!e.isLoading&&s.message.content.includes("<think>")?(i(),h(ke,{key:0,class:"full-width","expand-separator":"","model-value":e.isThinking,"header-class":"bg-mixed-200 text-black"},{header:d(()=>[l(P,{class:"full-width",dense:""},{default:d(()=>[l(U,{side:""},{default:d(()=>[e.isThinking?(i(),h(_e,{key:0})):(i(),h(Z,{key:1,name:"task_alt"}))]),_:1}),l(U,null,{default:d(()=>[l(xe,null,{default:d(()=>[j(E(e.t("deepsearch.chat_ui.thinking")),1)]),_:1})]),_:1})]),_:1})]),default:d(()=>[l(P,{class:"q-pa-lg"},{default:d(()=>[l(U,{class:"text-dim",style:{"font-family":"monospace"}},{default:d(()=>[j(E(e.think),1)]),_:1})]),_:1})]),_:1},8,["model-value"])):R("",!0),e.answer?(i(),h(e.TypingText,{key:1,text:e.answer,loading:e.isLoading,"content-class":"q-ma-md"},null,8,["text","loading","content-class"])):R("",!0),s.message.statusCode===402?(i(),w(M,{key:2},[l(T,{color:"primary",square:"",outline:"",label:e.t("deepsearch.chat_ui.purchase"),onClick:e.onPurchase,icon:"shopping_cart",class:"q-ma-sm"},null,8,["label"]),l(T,{color:"white",square:"",outline:"",label:e.t("deepsearch.chat_ui.keyman"),to:"/api-dashboard/key-manager",icon:"key",class:"q-ma-sm"},null,8,["label"])],64)):R("",!0)],64)):(i(),h(ve,{key:0,size:"md",class:"q-ma-md"}))]))]),_:1},8,["class","sent","size"])}const Le=V(Te,[["render",Me],["__file","MessageComponent.vue"]]),Re=(a,n)=>{if(a.shiftKey&&a.key==="Enter")return 13;a.key==="Enter"&&(a.preventDefault(),n())},He="https://deepsearch.jina.ai",J=ee("chatStore",{state:()=>({messages:[],response:[],isLoading:!1,isStreaming:!1,abortController:void 0}),getters:{usage:a=>{var n;return(n=a.response[a.response.length-1])==null?void 0:n.usage}},actions:{async send(a,n,s){var e;if(!this.isLoading){this.abortController=new AbortController,this.isLoading=!0;try{this.messages.push({role:"user",content:a,timestamp:Date.now()});const u={model:s,messages:this.messages.concat().filter(o=>!o.statusCode||o.statusCode===200),stream:!0};this.messages.push({role:"assistant",content:"",timestamp:Date.now()});const r=await fetch(`${He}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify(u),signal:this.abortController.signal}),t=this.messages[this.messages.length-1];if(t.statusCode=r.status,t.timestamp=Date.now(),(e=r.headers.get("content-type"))!=null&&e.includes("text/event-stream")){if(r.body){const o=r.body.getReader(),C=new TextDecoder;for(;;){const{done:k,value:m}=await o.read();if(k){this.isLoading=!1,this.isStreaming=!1;break}m&&(this.isStreaming=!0,C.decode(m).split(`

`).filter(Boolean).forEach(f=>{const v=f.replace(/data: /,"");try{if(v){const y=JSON.parse(v);this.response.push(y),t.content+=y.choices[0].delta.content}}catch(y){console.error("Error:",y)}}))}}}else{const o=await r.json();o&&(this.response=[o],this.messages.push(o.choices[0].message))}}catch(u){if(u.name!=="AbortError"){let r=u instanceof Error?u.message:String(u);this.messages[this.messages.length-1].statusCode===402&&(r=this.t("deepsearch.chat_ui.payment_required")),this.messages[this.messages.length-1].content=r,this.messages[this.messages.length-1].timestamp=Date.now(),ae.create({message:r,color:"negative",icon:"error"})}}finally{this.isLoading=!1,this.isStreaming=!1}}},cancel(){var n;(n=this.abortController)==null||n.abort(),this.isLoading=!1,this.messages[this.messages.length-1].role==="assistant"&&this.messages.pop()}}}),Ue=D({__name:"InputComponent",props:{maximizedWindow:{type:Boolean,default:!1},query:{type:String,default:""}},setup(a,{expose:n}){const{t:s}=I({useScope:"global"}),e=F(),u=Q(),r=Q(""),t=J(),{isLoading:o,messages:C}=H(t),k=K(),m=N(),{user:_}=H(m),p=a,f=x(()=>!(typeof c(r.value)=="string"||o.value)),v=()=>{f.value&&(t.send(r.value,k.apiKey,"jina-deepsearch-v1"),g())},y=()=>{o.value=!1,t.cancel()},q=()=>{e.dialog({title:s("deepsearch.chat_ui.clear_context_title"),message:s("deepsearch.chat_ui.clear_context_message"),cancel:!0}).onOk(()=>{C.value=[]})},c=z=>z.trim().length===0?s("deepsearch.chat_ui.input_cant_be_empty"):!0,g=()=>{r.value=""};n({reset:g}),te(()=>{p.query&&(r.value=p.query)});const S={t:s,$q:e,form:u,inputMessage:r,chatStore:t,isLoading:o,messages:C,embeddingStore:k,userStore:m,user:_,props:p,sendable:f,onSubmit:v,onCancel:y,onClear:q,validateInput:c,reset:g,get QForm(){return we},get handleShiftEnter(){return Re}};return Object.defineProperty(S,"__isScriptSetup",{enumerable:!1,value:!0}),S}});function je(a,n,s,e,u,r){return i(),h(e.QForm,{ref:"form",class:"full-width",onSubmit:oe(e.onSubmit,["prevent"])},{default:d(()=>[l(se,{class:"full-height q-mb-xs",modelValue:e.inputMessage,"onUpdate:modelValue":[n[1]||(n[1]=t=>e.inputMessage=t),t=>{}],filled:"",autofocus:"",square:"",autogrow:"","hide-bottom-space":"","lazy-rules":"ondemand",rules:[e.validateInput],onKeydown:n[2]||(n[2]=t=>e.handleShiftEnter(t,()=>{var o;return(o=e.form)==null?void 0:o.submit(t)})),ref:"inputAnchor","input-style":"max-height: 50vh;",placeholder:e.t("deepsearch.chat_ui.input_placeholder")},ne({prepend:d(()=>[l(T,{flat:"",round:"",icon:"add_comment",disable:e.isLoading||!e.messages.length,onClick:e.onClear},{default:d(()=>[l(qe,null,{default:d(()=>[j(E(e.t("deepsearch.chat_ui.new_chat")),1)]),_:1})]),_:1},8,["disable"])]),append:d(()=>[e.isLoading?(i(),h(T,{key:0,flat:"",round:"",icon:"o_stop_circle",color:"negative",onClick:e.onCancel})):(i(),h(T,{key:1,flat:"",round:"",icon:"send",color:e.sendable?"primary":"grey",disable:!e.sendable||e.isLoading,onClick:n[0]||(n[0]=t=>{var o;return(o=e.form)==null?void 0:o.submit(t)})},null,8,["color","disable"]))]),_:2},[s.maximizedWindow?void 0:{name:"before",fn:d(()=>{var t;return[(t=e.user)!=null&&t.photoURL?(i(),h(L,{key:0,size:"md",round:"",class:"bordered-avatar q-ml-md"},{default:d(()=>[l(O,{src:e.user.photoURL,referrerpolicy:"no-referrer",alt:e.user.displayName||""},null,8,["src","alt"])]),_:1})):(i(),h(L,{key:1,icon:"person",size:"md",class:"bordered-avatar q-ml-md"}))]}),key:"0"}]),1032,["modelValue","rules","placeholder"])]),_:1},512)}const Ee=V(Ue,[["render",je],["__file","InputComponent.vue"]]);var G=(a=>(a[a.TOP=0]="TOP",a[a.BOTTOM=1]="BOTTOM",a))(G||{});const De=D({__name:"ChatComponent",props:{maximizedWindow:{type:Boolean,default:!1}},setup(a,{expose:n}){n();const{t:s}=I({useScope:"global"}),e=J(),{messages:u,isLoading:r}=H(e),t=Q(null),o=Q(!0),C=Q(""),k=Q(0),m=v=>{A(()=>{o.value&&(k.value=v.height,p(1))})},_=v=>{A(()=>{var c,g;const y=(c=t.value)==null?void 0:c.$el,q=y.offsetHeight+y.scrollTop-y.scrollHeight;v.direction==="up"&&((g=u.value)!=null&&g.length)&&q<-5&&(o.value=!1),v.direction==="down"&&q>=-5&&(o.value=!0)})},p=v=>{setTimeout(()=>{if(t.value&&t.value.$el){const y=v===0?0:t.value.$el.scrollHeight;t.value.$el.scrollTo({top:y,behavior:"smooth"})}},10)};re(()=>{r.value=!1,u.value=[]}),ie(async()=>{o.value=!0});const f={t:s,chatStore:e,messages:u,isLoading:r,scrollTarget:t,autoScroll:o,exampleQuery:C,virtualScrollHeight:k,onResize:m,onScroll:_,SCROLL_POSITION:G,scrollTo:p,get QVirtualScroll(){return pe},get QCardSection(){return le},get QCard(){return ce},MessageComponent:Le,InputComponent:Ee,get deepSearchFlow(){return be},UsageHeader:ye};return Object.defineProperty(f,"__isScriptSetup",{enumerable:!1,value:!0}),f}}),Ie={class:"column no-wrap"},Ve={class:"col-12"};function Oe(a,n,s,e,u,r){return i(),h(e.QCard,{bordered:!s.maximizedWindow,flat:"",square:"",class:"column fit relative-position no-wrap",style:{"max-height":"100vh"}},{default:d(()=>[s.maximizedWindow?(i(),w(M,{key:0},[l(e.UsageHeader,{class:"full-width","home-link":"/deepsearch","faq-link":"/deepsearch#faq","issue-link":"https://github.com/jina-ai/node-DeepResearch/issues","is-support-c-s-p":!1,"api-link":"https://github.com/jina-ai/node-DeepResearch?tab=readme-ov-file#openai-compatible-server-api"}),l(de)],64)):R("",!0),s.maximizedWindow?R("",!0):(i(),h(T,{key:1,flat:"",round:"",icon:"fullscreen",class:"absolute-top-left q-ml-md q-mt-md z-top",to:"/api-dashboard/deepsearch-chat"})),e.messages.length?(i(),h(e.QCardSection,{key:3,class:"column justify-between no-wrap q-px-lg scroll q-mb-xl",ref:"scrollTarget"},{default:d(()=>[l(he,{onScroll:e.onScroll,debounce:300}),W("div",Ie,[l(ue,{appear:"","enter-active-class":"animated fadeIn","leave-active-class":"animated fadeOut",duration:50},{default:d(()=>[W("div",Ve,[l(e.QVirtualScroll,{items:e.messages},{default:d(({item:t,index:o})=>[l(fe,{onResize:e.onResize,debounce:300}),l(e.MessageComponent,{message:t,index:o},null,8,["message","index"])]),_:1},8,["items"])])]),_:1})])]),_:1},512)):(i(),h(e.QCardSection,{key:2,class:"full-height column justify-center"},{default:d(()=>[l(O,{src:e.deepSearchFlow,"img-style":{opacity:.1},fit:"fill",class:"col-5"},null,8,["src"]),(i(),w(M,null,me([1,2,3],t=>l(T,{"no-caps":"",flat:"",label:e.t(`deepsearch.chat_ui.example_q${t}`),key:t,class:"text-dim q-py-md",onClick:o=>e.exampleQuery=e.t(`deepsearch.chat_ui.example_q${t}`)},null,8,["label","onClick"])),64))]),_:1})),l(ge,{class:"lock-blur absolute-bottom"},{default:d(()=>[l(e.InputComponent,{maximizedWindow:s.maximizedWindow,query:e.exampleQuery},null,8,["maximizedWindow","query"])]),_:1})]),_:1},8,["bordered"])}const ta=V(De,[["render",Oe],["__file","ChatComponent.vue"]]);export{ta as C};
