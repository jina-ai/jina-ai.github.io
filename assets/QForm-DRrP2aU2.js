import{aD as T,e as m,dr as c,s as w,k as A,bG as q,bH as E,V as F,p as O,K as j,J as L,au as U,L as C,U as $,bP as V,aQ as z,ds as J}from"./index-DQJewzDQ.js";import{u as p}from"./embedding-DWMaJRDE.js";const N=T("apiKey",{state:()=>({keys:[],isLoading:!1,keysInfoCache:{},isBusyState:new Set}),getters:{},actions:{async addKey(e){var a;if(!(!((a=m.currentUser)!=null&&a.uid)||!e))try{const{data:o}=await c.request("apiKey","addKey",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${await c.getIdToken()}`},body:JSON.stringify({key:e})});return o&&(this.keys.unshift(o),this.getKeyInfo(e)),o}catch(o){console.error(o)}},async setPrimaryKey(e){var a;if((a=m.currentUser)!=null&&a.uid){this.isBusyState.add(e);try{const{data:o}=await c.request("apiKey","setPrimaryKey",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${await c.getIdToken()}`},body:JSON.stringify({key:e,isPrimary:!0})});return o&&(this.keys.forEach(n=>(n.key===e?n.isPrimary=!0:n.isPrimary=!1,n)),p().apiKey=e,p().getCurrentKeyInfo()),o}catch(o){console.error(o)}finally{this.isBusyState.delete(e)}}},async removeKey(e){var a;if((a=m.currentUser)!=null&&a.uid){this.isBusyState.add(e);try{const{data:o}=await c.request("apiKey","removeKey",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${await c.getIdToken()}`},body:JSON.stringify({key:e})});o&&(this.keys.splice(this.keys.findIndex(n=>n.key===e),1),delete this.keysInfoCache[e])}catch(o){console.error(o)}finally{this.isBusyState.delete(e)}}},async fetchKeys(){var e;if(!(!((e=m.currentUser)!=null&&e.uid)||this.isLoading)){this.isLoading=!0;try{const{data:a}=await c.request("apiKey","keyList",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${await c.getIdToken()}`}});this.keys=a;for(const o of this.keys)this.getKeyInfo(o.key)}catch(a){console.error(a)}finally{this.isLoading=!1}}},async getKeyInfo(e){var a;if(e&&!this.isBusyState.has(e))try{this.isBusyState.add(e);const o=await p().getKeyInfo(e),n=await p().getUsage(e);this.keysInfoCache[e]={...o,usage:n,last_used_at:(a=n==null?void 0:n[0])==null?void 0:a.updated_at}}finally{this.isBusyState.delete(e)}}}}),_=w({name:"QForm",props:{autofocus:Boolean,noErrorFocus:Boolean,noResetFocus:Boolean,greedy:Boolean,onSubmit:Function},emits:["reset","validationSuccess","validationError"],setup(e,{slots:a,emit:o}){const n=L(),f=A(null);let l=0;const d=[];function v(t){const u=typeof t=="boolean"?t:e.noErrorFocus!==!0,h=++l,I=(s,i)=>{o(`validation${s===!0?"Success":"Error"}`,i)},P=s=>{const i=s.validate();return typeof i.then=="function"?i.then(r=>({valid:r,comp:s}),r=>({valid:!1,comp:s,err:r})):Promise.resolve({valid:i,comp:s})};return(e.greedy===!0?Promise.all(d.map(P)).then(s=>s.filter(i=>i.valid!==!0)):d.reduce((s,i)=>s.then(()=>P(i).then(r=>{if(r.valid===!1)return Promise.reject(r)})),Promise.resolve()).catch(s=>[s])).then(s=>{if(s===void 0||s.length===0)return h===l&&I(!0),!0;if(h===l){const{comp:i,err:r}=s[0];if(r!==void 0&&console.error(r),I(!1,i),u===!0){const B=s.find(({comp:x})=>typeof x.focus=="function"&&U(x.$)===!1);B!==void 0&&B.comp.focus()}}return!1})}function g(){l++,d.forEach(t=>{typeof t.resetValidation=="function"&&t.resetValidation()})}function S(t){t!==void 0&&C(t);const u=l+1;v().then(h=>{u===l&&h===!0&&(e.onSubmit!==void 0?o("submit",t):t!==void 0&&t.target!==void 0&&typeof t.target.submit=="function"&&t.target.submit())})}function b(t){t!==void 0&&C(t),o("reset"),$(()=>{g(),e.autofocus===!0&&e.noResetFocus!==!0&&y()})}function y(){V(()=>{if(f.value===null)return;const t=f.value.querySelector("[autofocus][tabindex], [data-autofocus][tabindex]")||f.value.querySelector("[autofocus] [tabindex], [data-autofocus] [tabindex]")||f.value.querySelector("[autofocus], [data-autofocus]")||Array.prototype.find.call(f.value.querySelectorAll("[tabindex]"),u=>u.tabIndex!==-1);t!=null&&t.focus({preventScroll:!0})})}z(J,{bindComponent(t){d.push(t)},unbindComponent(t){const u=d.indexOf(t);u!==-1&&d.splice(u,1)}});let K=!1;return q(()=>{K=!0}),E(()=>{K===!0&&e.autofocus===!0&&y()}),F(()=>{e.autofocus===!0&&y()}),Object.assign(n.proxy,{validate:v,resetValidation:g,submit:S,reset:b,focus:y,getValidationComponents:()=>d}),()=>O("form",{class:"q-form",ref:f,onSubmit:S,onReset:b},j(a.default))}});export{_ as Q,N as u};
