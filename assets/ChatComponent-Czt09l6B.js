import{s as gt,m as B,p as P,ce as bt,j as Ne,a0 as De,u as at,am as ke,k as ie,n as st,a2 as ze,a3 as k,a4 as E,a5 as q,aa as se,ah as ge,b5 as be,a6 as j,ab as ce,ad as Ke,ae as Te,aq as vt,af as Ce,ag as we,q as oe,aj as pt,f as yt,h as xt,aB as _t,bS as Ct,aQ as wt,aU as kt,aL as St,aP as qt,W as jt,ba as Ot,a9 as Et,a7 as Tt,V as Ze,ap as Qt,ai as It,a8 as Ye,T as Nt,bT as Dt}from"./index-CZ7uG9Zj.js";import{Q as Le,b as zt}from"./QChip-BPrFpjVy.js";import{Q as Lt}from"./QScrollObserver-C1vqzxVd.js";import{Q as Mt}from"./QResizeObserver-DxjqpLpi.js";import{f as Pt,i as At}from"./date-BCGnXUH8.js";import{Q as Rt}from"./QSpinnerDots-O4Kp7UE_.js";import{Q as Ft,d as Bt,U as Ht}from"./BrowserInfoDialog-Z5nlUOPh.js";import{Q as Xe}from"./QItemLabel-w7jAPFor.js";import{Q as Ut}from"./QExpansionItem-CUhsn-e6.js";import{T as Wt}from"./QSpinnerRings-B56eSVAQ.js";import{u as it}from"./use-dialog-plugin-component-DxeINddx.js";import{P as Vt}from"./crypto-CLPfvLQb.js";import{Q as Jt}from"./QTooltip-DeVAt5gX.js";import{a as Kt}from"./finetune-DN1EXAbQ.js";const Zt=gt({name:"QChatMessage",props:{sent:Boolean,label:String,bgColor:String,textColor:String,name:String,avatar:String,text:Array,stamp:String,size:String,labelHtml:Boolean,nameHtml:Boolean,textHtml:Boolean,stampHtml:Boolean},setup(e,{slots:r}){const a=B(()=>e.sent===!0?"sent":"received"),n=B(()=>`q-message-text-content q-message-text-content--${a.value}`+(e.textColor!==void 0?` text-${e.textColor}`:"")),l=B(()=>`q-message-text q-message-text--${a.value}`+(e.bgColor!==void 0?` text-${e.bgColor}`:"")),o=B(()=>"q-message-container row items-end no-wrap"+(e.sent===!0?" reverse":"")),t=B(()=>e.size!==void 0?`col-${e.size}`:""),i=B(()=>({msg:e.textHtml===!0?"innerHTML":"textContent",stamp:e.stampHtml===!0?"innerHTML":"textContent",name:e.nameHtml===!0?"innerHTML":"textContent",label:e.labelHtml===!0?"innerHTML":"textContent"}));function v(b){return r.stamp!==void 0?[b,P("div",{class:"q-message-stamp"},r.stamp())]:e.stamp?[b,P("div",{class:"q-message-stamp",[i.value.stamp]:e.stamp})]:[b]}function C(b,S){const g=S===!0?b.length>1?c=>c:c=>P("div",[c]):c=>P("div",{[i.value.msg]:c});return b.map((c,w)=>P("div",{key:w,class:l.value},[P("div",{class:n.value},v(g(c)))]))}return()=>{const b=[];r.avatar!==void 0?b.push(r.avatar()):e.avatar!==void 0&&b.push(P("img",{class:`q-message-avatar q-message-avatar--${a.value}`,src:e.avatar,"aria-hidden":"true"}));const S=[];r.name!==void 0?S.push(P("div",{class:`q-message-name q-message-name--${a.value}`},r.name())):e.name!==void 0&&S.push(P("div",{class:`q-message-name q-message-name--${a.value}`,[i.value.name]:e.name})),r.default!==void 0?S.push(C(bt(r.default()),!0)):e.text!==void 0&&S.push(C(e.text)),b.push(P("div",{class:t.value},S));const g=[];return r.label!==void 0?g.push(P("div",{class:"q-message-label"},r.label())):e.label!==void 0&&g.push(P("div",{class:"q-message-label",[i.value.label]:e.label})),g.push(P("div",{class:o.value},b)),P("div",{class:`q-message q-message-${a.value}`},g)}}}),Yt=Ne({__name:"MessageComponent",props:{message:{},width:{},index:{},disabled:{type:Boolean}},setup(e,{expose:r}){r();const a=e,n=st(),{t:l}=De(),o=at(),{user:t}=ke(o),i=it(),v=ie(!1),C=B(()=>a.message.role==="user"),b=B(()=>a.message.role==="assistant"),S=B(()=>{var y;return((y=a.message.usage)==null?void 0:y.total_tokens)||0}),g=B(()=>{const y=a.message.content,p="<think>",I="</think>";if(y.includes(p))if(y.includes(I)){const L=/<think>(.*?)<\/think>/s,Z=y.match(L);if(Z)return Z[1]}else return y.substring(y.indexOf(p)+p.length);return""}),c=B(()=>a.message.content.includes("<think>")&&!a.message.content.includes("</think>")),w=B(()=>{const y=a.message.content;let p="";const I="</think>";return y.includes(I)?p=y.substring(y.indexOf(I)+I.length):y.includes("<think>")||(p=y),p.replace(/<references>|<\/references>/g,"")}),d={props:a,$q:n,t:l,userStore:o,user:t,embeddingStore:i,isLoading:v,isUserRole:C,isAssistantRole:b,tokens:S,think:g,isThinking:c,answer:w,onPurchase:()=>{n.dialog({component:Vt,componentProps:{purchaseKey:i.apiKey}})},TypingText:Wt,get formatNumber(){return Pt}};return Object.defineProperty(d,"__isScriptSetup",{enumerable:!1,value:!0}),d}}),Xt={key:0},Gt={key:1,class:"relative-position"};function $t(e,r,a,n,l,o){return k(),E(Zt,{class:pt(["q-pa-md q-pb-lg relative-position message",n.isUserRole?"user-message":"assistant-message"]),sent:n.isUserRole,"text-color":"white"},{avatar:q(()=>{var t;return[n.isUserRole?(k(),se(ge,{key:0},[(t=n.user)!=null&&t.photoURL?(k(),E(be,{key:0,size:"md",round:"",class:"bordered-avatar q-ml-md"},{default:q(()=>[j(Le,{src:n.user.photoURL,referrerpolicy:"no-referrer",alt:n.user.displayName||""},null,8,["src","alt"])]),_:1})):(k(),E(be,{key:1,icon:"person",size:"md",class:"bordered-avatar q-ml-md"}))],64)):(k(),E(be,{key:1,icon:"img:/J.svg",class:"bordered-avatar q-mr-md bg-mixed-200",size:"md"}))]}),stamp:q(()=>[n.tokens?(k(),E(zt,{key:0,icon:"straighten",label:`${n.formatNumber(n.tokens)} ${n.t("embedding.tokens")}`,size:"sm",class:"text-dim bg-transparent"},null,8,["label"])):ce("",!0)]),default:q(()=>[n.isUserRole?(k(),se("div",Xt,[j(n.TypingText,{text:a.message.content,dark:n.isAssistantRole},null,8,["text","dark"])])):(k(),se("div",Gt,[a.message.content.length?(k(),se(ge,{key:1},[n.isLoading||!n.isLoading&&a.message.content.includes("<think>")?(k(),E(Ut,{key:0,class:"full-width","expand-separator":"","model-value":n.isThinking,"header-class":"bg-mixed-200 text-black"},{header:q(()=>[j(Ke,{class:"full-width",dense:""},{default:q(()=>[j(Te,{side:""},{default:q(()=>[n.isThinking?(k(),E(Ft,{key:0})):(k(),E(vt,{key:1,name:"task_alt"}))]),_:1}),j(Te,null,{default:q(()=>[n.isThinking?(k(),E(Xe,{key:0},{default:q(()=>[Ce(we(n.t("deepsearch.chat_ui.thinking")),1)]),_:1})):(k(),E(Xe,{key:1},{default:q(()=>[Ce(we(n.t("deepsearch.chat_ui.thinking_done")),1)]),_:1}))]),_:1})]),_:1})]),default:q(()=>[j(Ke,{class:"q-pa-lg"},{default:q(()=>[j(Te,{class:"text-dim",style:{"font-family":"monospace"}},{default:q(()=>[Ce(we(n.think),1)]),_:1})]),_:1})]),_:1},8,["model-value"])):ce("",!0),n.answer?(k(),E(n.TypingText,{key:1,text:n.answer,loading:n.isLoading,"content-class":"q-ma-md"},null,8,["text","loading","content-class"])):ce("",!0),a.message.statusCode===402?(k(),se(ge,{key:2},[j(oe,{color:"primary",square:"",outline:"",label:n.t("deepsearch.chat_ui.purchase"),onClick:n.onPurchase,icon:"shopping_cart",class:"q-ma-sm"},null,8,["label"]),j(oe,{color:"white",square:"",outline:"",label:n.t("deepsearch.chat_ui.keyman"),to:"/api-dashboard/key-manager",icon:"key",class:"q-ma-sm"},null,8,["label"])],64)):ce("",!0)],64)):(k(),E(Rt,{key:0,size:"md",class:"q-ma-md"}))]))]),_:1},8,["class","sent"])}const en=ze(Yt,[["render",$t],["__file","MessageComponent.vue"]]),tn=(e,r)=>{if(e.shiftKey&&e.key==="Enter")return 13;e.key==="Enter"&&(e.preventDefault(),r())},nn={},rn=Object.freeze(Object.defineProperty({__proto__:null,default:nn},Symbol.toStringTag,{value:"Module"})),an=yt(rn);var sn=an;function on(e,r){var a,n="",l=0,o=!0,t=0,i;function v(){return i=e.charAt(t),t++,i}for(v(),i==="-"&&(n="-",v());i>="0"&&i<="9";)o&&(i=="0"?l++:o=!1),n+=i,v();if(o&&l--,i===".")for(n+=".";v()&&i>="0"&&i<="9";)n+=i;if(i==="e"||i==="E")for(n+=i,v(),(i==="-"||i==="+")&&(n+=i,v());i>="0"&&i<="9";)n+=i,v();for(;i&&i<=" ";)v();if(r&&(i===","||i==="}"||i==="]"||i==="#"||i==="/"&&(e[t]==="/"||e[t]==="*"))&&(i=0),a=+n,!(i||l||!isFinite(a)))return a}function ln(e,r){return Object.defineProperty&&Object.defineProperty(e,"__COMMENTS__",{enumerable:!1,writable:!0}),e.__COMMENTS__=r||{}}function fn(e){Object.defineProperty(e,"__COMMENTS__",{value:void 0})}function un(e){return e.__COMMENTS__}function cn(e){if(!e)return"";var r=e.split(`
`),a,n,l,o;for(l=0;l<r.length;l++)for(a=r[l],o=a.length,n=0;n<o;n++){var t=a[n];if(t==="#")break;if(t==="/"&&(a[n+1]==="/"||a[n+1]==="*")){a[n+1]==="*"&&(l=r.length);break}else if(t>" "){r[l]="# "+a;break}}return r.join(`
`)}var qe={EOL:sn.EOL||`
`,tryParseNumber:on,createComment:ln,removeComment:fn,getComment:un,forceComment:cn},mn="3.2.1";function dn(e,r){if(Object.prototype.toString.apply(e)!=="[object Array]"){if(e)throw new Error("dsf option must contain an array!");return Ge}else if(e.length===0)return Ge;var a=[];function n(l){return{}.toString.call(l)==="[object Function]"}return e.forEach(function(l){if(!l.name||!n(l.parse)||!n(l.stringify))throw new Error("extension does not match the DSF interface");a.push(function(){try{if(r=="parse")return l.parse.apply(null,arguments);if(r=="stringify"){var o=l.stringify.apply(null,arguments);if(o!==void 0&&(typeof o!="string"||o.length===0||o[0]==='"'||[].some.call(o,function(t){return gn(t)})))throw new Error("value may not be empty, start with a quote or contain a punctuator character except colon: "+o);return o}else throw new Error("Invalid type")}catch(t){throw new Error("DSF-"+l.name+" failed; "+t.message)}})}),hn.bind(null,a)}function hn(e,r){if(e)for(var a=0;a<e.length;a++){var n=e[a](r);if(n!==void 0)return n}}function Ge(){}function gn(e){return e==="{"||e==="}"||e==="["||e==="]"||e===","}function ot(){return{name:"math",parse:function(e){switch(e){case"+inf":case"inf":case"+Inf":case"Inf":return 1/0;case"-inf":case"-Inf":return-1/0;case"nan":case"NaN":return NaN}},stringify:function(e){if(typeof e=="number"){if(1/e===-1/0)return"-0";if(e===1/0)return"Inf";if(e===-1/0)return"-Inf";if(isNaN(e))return"NaN"}}}}ot.description="support for Inf/inf, -Inf/-inf, Nan/naN and -0";function lt(e){var r=e&&e.out;return{name:"hex",parse:function(a){if(/^0x[0-9A-Fa-f]+$/.test(a))return parseInt(a,16)},stringify:function(a){if(r&&Number.isInteger(a))return"0x"+a.toString(16)}}}lt.description="parse hexadecimal numbers prefixed with 0x";function ft(){return{name:"date",parse:function(e){if(/^\d{4}-\d{2}-\d{2}$/.test(e)||/^\d{4}-\d{2}-\d{2}T\d{2}\:\d{2}\:\d{2}(?:.\d+)(?:Z|[+-]\d{2}:\d{2})$/.test(e)){var r=Date.parse(e);if(!isNaN(r))return new Date(r)}},stringify:function(e){if(Object.prototype.toString.call(e)==="[object Date]"){var r=e.toISOString();return r.indexOf("T00:00:00.000Z",r.length-14)!==-1?r.substr(0,10):r}}}}ft.description="support ISO dates";var Me={loadDsf:dn,std:{math:ot,hex:lt,date:ft}},bn=function(e,r){var a=qe,n=Me,l,o,t,i={'"':'"',"'":"'","\\":"\\","/":"/",b:"\b",f:"\f",n:`
`,r:"\r",t:"	"},v,C;function b(){o=0,t=" "}function S(s){return s==="{"||s==="}"||s==="["||s==="]"||s===","||s===":"}function g(s){var m,f=0,u=1;for(m=o-1;m>0&&l[m]!==`
`;m--,f++);for(;m>0;m--)l[m]===`
`&&u++;throw new Error(s+" at line "+u+","+f+" >>>"+l.substr(o-f,20)+" ...")}function c(){return t=l.charAt(o),o++,t}function w(s){return l.charAt(o+s)}function O(s){for(var m="",f=t;c();){if(t===f)return c(),s&&f==="'"&&t==="'"&&m.length===0?(c(),d()):m;if(t==="\\")if(c(),t==="u"){for(var u=0,x=0;x<4;x++){c();var _=t.charCodeAt(0),N;t>="0"&&t<="9"?N=_-48:t>="a"&&t<="f"?N=_-97+10:t>="A"&&t<="F"?N=_-65+10:g("Bad \\u char "+t),u=u*16+N}m+=String.fromCharCode(u)}else if(typeof i[t]=="string")m+=i[t];else break;else t===`
`||t==="\r"?g("Bad string containing newline"):m+=t}g("Bad string")}function d(){for(var s="",m=0,f=0;;){var u=w(-f-5);if(!u||u===`
`)break;f++}function x(){for(var _=f;t&&t<=" "&&t!==`
`&&_-- >0;)c()}for(;t&&t<=" "&&t!==`
`;)c();for(t===`
`&&(c(),x());;){if(!t)g("Bad multiline string");else if(t==="'"){if(m++,c(),m===3)return s.slice(-1)===`
`&&(s=s.slice(0,-1)),s;continue}else for(;m>0;)s+="'",m--;t===`
`?(s+=`
`,c(),x()):(t!=="\r"&&(s+=t),c())}}function y(){if(t==='"'||t==="'")return O(!1);for(var s="",m=o,f=-1;;){if(t===":")return s?f>=0&&f!==s.length&&(o=m+f,g("Found whitespace in your key name (use quotes to include)")):g("Found ':' but no key name (for an empty key name use quotes)"),s;t<=" "?t?f<0&&(f=s.length):g("Found EOF while looking for a key name (check your syntax)"):S(t)?g("Found '"+t+"' where a key name was expected (check your syntax or use quotes if the key name includes {}[],: or whitespace)"):s+=t,c()}}function p(){for(;t;){for(;t&&t<=" ";)c();if(t==="#"||t==="/"&&w(0)==="/")for(;t&&t!==`
`;)c();else if(t==="/"&&w(0)==="*"){for(c(),c();t&&!(t==="*"&&w(0)==="/");)c();t&&(c(),c())}else break}}function I(){var s=t;for(S(t)&&g("Found a punctuator character '"+t+"' when expecting a quoteless string (check your syntax)");;){c();var m=t==="\r"||t===`
`||t==="";if(m||t===","||t==="}"||t==="]"||t==="#"||t==="/"&&(w(0)==="/"||w(0)==="*")){var f=s[0];switch(f){case"f":if(s.trim()==="false")return!1;break;case"n":if(s.trim()==="null")return null;break;case"t":if(s.trim()==="true")return!0;break;default:if(f==="-"||f>="0"&&f<="9"){var u=a.tryParseNumber(s);if(u!==void 0)return u}}if(m){s=s.trim();var x=C(s);return x!==void 0?x:s}}s+=t}}function L(s,m){var f;for(s--,f=o-2;f>s&&l[f]<=" "&&l[f]!==`
`;f--);l[f]===`
`&&f--,l[f]==="\r"&&f--;var u=l.substr(s,f-s+1);for(f=0;f<u.length;f++)if(u[f]>" "){var x=u.indexOf(`
`);if(x>=0){var _=[u.substr(0,x),u.substr(x+1)];return m&&_[0].trim().length===0&&_.shift(),_}else return[u]}return[]}function Z(s){function m(u,x){var _,N,R,h;switch(typeof u){case"string":u.indexOf(x)>=0&&(h=u);break;case"object":if(Object.prototype.toString.apply(u)==="[object Array]")for(_=0,R=u.length;_<R;_++)h=m(u[_],x)||h;else for(N in u)Object.prototype.hasOwnProperty.call(u,N)&&(h=m(u[N],x)||h)}return h}function f(u){var x=m(s,u);return x?"found '"+u+`' in a string value, your mistake could be with:
  > `+x+`
  (unquoted strings contain everything up to the next line!)`:""}return f("}")||f("]")}function Y(){var s=[],m,f,u;try{if(v&&(m=a.createComment(s,{a:[]})),c(),f=o,p(),m&&(u=L(f,!0).join(`
`)),t==="]")return c(),m&&(m.e=[u]),s;for(;t;){if(s.push(ne()),f=o,p(),t===","&&(c(),f=o,p()),m){var x=L(f);m.a.push([u||"",x[0]||""]),u=x[1]}if(t==="]")return c(),m&&(m.a[m.a.length-1][1]+=u||""),s;p()}g("End of input while parsing an array (missing ']')")}catch(_){throw _.hint=_.hint||Z(s),_}}function te(s){var m="",f={},u,x,_;try{if(v&&(u=a.createComment(f,{c:{},o:[]})),s?x=1:(c(),x=o),p(),u&&(_=L(x,!0).join(`
`)),t==="}"&&!s)return u&&(u.e=[_]),c(),f;for(;t;){if(m=y(),p(),t!==":"&&g("Expected ':' instead of '"+t+"'"),c(),f[m]=ne(),x=o,p(),t===","&&(c(),x=o,p()),u){var N=L(x);u.c[m]=[_||"",N[0]||""],_=N[1],u.o.push(m)}if(t==="}"&&!s)return c(),u&&(u.c[m][1]+=_||""),f;p()}if(s)return f;g("End of input while parsing an object (missing '}')")}catch(R){throw R.hint=R.hint||Z(f),R}}function ne(){switch(p(),t){case"{":return te();case"[":return Y();case"'":case'"':return O(!0);default:return I()}}function W(s,m){var f=o;if(p(),t&&g("Syntax error, found trailing characters"),v){var u=m.join(`
`),x=L(f).join(`
`);if(x||u){var _=a.createComment(s,a.getComment(s));_.r=[u,x]}}return s}function je(){p();var s=v?L(1):null;switch(t){case"{":return W(te(),s);case"[":return W(Y(),s);default:return W(ne(),s)}}function Oe(){p();var s=v?L(1):null;switch(t){case"{":return W(te(),s);case"[":return W(Y(),s)}try{return W(te(!0),s)}catch(m){b();try{return W(ne(),s)}catch{throw m}}}if(typeof e!="string")throw new Error("source is not a string");var $=null,A=!0;return r&&typeof r=="object"&&(v=r.keepWsc,$=r.dsf,A=r.legacyRoot!==!1),C=n.loadDsf($,"parse"),l=e,b(),A?Oe():je()},vn=function(e,r){var a=qe,n=Me,l={obj:["{","}"],arr:["[","]"],key:["",""],qkey:['"','"'],col:[":",""],com:[",",""],str:["",""],qstr:['"','"'],mstr:["'''","'''"],num:["",""],lit:["",""],dsf:["",""],esc:["\\",""],uni:["\\u",""],rem:["",""]},o=a.EOL,t="  ",i=!1,v=!1,C=!1,b=!1,S=0,g=1,c="",w=null,O=!1,d=l;if(r&&typeof r=="object"){r.quotes=r.quotes==="always"?"strings":r.quotes,(r.eol===`
`||r.eol===`\r
`)&&(o=r.eol),i=r.keepWsc,S=r.condense||0,v=r.bracesSameLine,C=r.quotes==="all"||r.quotes==="keys",b=r.quotes==="all"||r.quotes==="strings"||r.separator===!0,b||r.multiline=="off"?g=0:g=r.multiline=="no-tabs"?2:1,c=r.separator===!0?d.com[0]:"",w=r.dsf,O=r.sortProps,typeof r.space=="number"?t=new Array(r.space+1).join(" "):typeof r.space=="string"&&(t=r.space),r.colors===!0&&(d={obj:["\x1B[37m{\x1B[0m","\x1B[37m}\x1B[0m"],arr:["\x1B[37m[\x1B[0m","\x1B[37m]\x1B[0m"],key:["\x1B[33m","\x1B[0m"],qkey:['\x1B[33m"','"\x1B[0m'],col:["\x1B[37m:\x1B[0m",""],com:["\x1B[37m,\x1B[0m",""],str:["\x1B[37;1m","\x1B[0m"],qstr:['\x1B[37;1m"','"\x1B[0m'],mstr:["\x1B[37;1m'''","'''\x1B[0m"],num:["\x1B[36;1m","\x1B[0m"],lit:["\x1B[36m","\x1B[0m"],dsf:["\x1B[37m","\x1B[0m"],esc:["\x1B[31m\\","\x1B[0m"],uni:["\x1B[31m\\u","\x1B[0m"],rem:["\x1B[35m","\x1B[0m"]});var y,p=Object.keys(l);for(y=p.length-1;y>=0;y--){var I=p[y];d[I].push(l[I][0].length,l[I][1].length)}}var L,Z="-­؀-؄܏឴឵‌-‏\u2028- ⁠-⁯\uFEFF￰-￿",Y=new RegExp('[\\\\\\"\0-'+Z+"]","g"),te=new RegExp(`^\\s|^"|^'|^#|^\\/\\*|^\\/\\/|^\\{|^\\}|^\\[|^\\]|^:|^,|\\s$|[\0-`+Z+"]","g"),ne=new RegExp("'''|^[\\s]+$|[\0-"+(g===2?"	":"\b")+"\v\f-"+Z+"]","g"),W=new RegExp("^(true|false|null)\\s*((,|\\]|\\}|#|//|/\\*).*)?$"),je={"\b":"b","	":"t","\n":"n","\f":"f","\r":"r",'"':'"',"\\":"\\"},Oe=/[,\{\[\}\]\s:#"']|\/\/|\/\*/,$="",A=0;function s(h,F){return A+=h[0].length+h[1].length-h[2]-h[3],h[0]+F+h[1]}function m(h){return h.replace(Y,function(F){var H=je[F];return typeof H=="string"?s(d.esc,H):s(d.uni,("0000"+F.charCodeAt(0).toString(16)).slice(-4))})}function f(h,F,H,X){return h?(te.lastIndex=0,W.lastIndex=0,b||H||te.test(h)||a.tryParseNumber(h,!0)!==void 0||W.test(h)?(Y.lastIndex=0,ne.lastIndex=0,Y.test(h)?!ne.test(h)&&!X&&g?u(h,F):s(d.qstr,m(h)):s(d.qstr,h)):s(d.str,h)):s(d.qstr,"")}function u(h,F){var H,X=h.replace(/\r/g,"").split(`
`);if(F+=t,X.length===1)return s(d.mstr,X[0]);var le=o+F+d.mstr[0];for(H=0;H<X.length;H++)le+=o,X[H]&&(le+=F+X[H]);return le+o+F+d.mstr[1]}function x(h){return h?C||Oe.test(h)?(Y.lastIndex=0,s(d.qkey,Y.test(h)?m(h):h)):s(d.key,h):'""'}function _(h,F,H,X){function le(z){return z&&z[z[0]==="\r"?1:0]===`
`}function Pe(z){return z&&!le(z)}function fe(z,dt,ht){if(!z)return"";z=a.forceComment(z);var ae,Je=z.length;for(ae=0;ae<Je&&z[ae]<=" ";ae++);return ht&&ae>0&&(z=z.substr(ae)),ae<Je?dt+s(d.rem,z):z}var Ae=L(h);if(Ae!==void 0)return s(d.dsf,Ae);switch(typeof h){case"string":return f(h,$,F,X);case"number":return isFinite(h)?s(d.num,String(h)):s(d.lit,"null");case"boolean":return s(d.lit,String(h));case"object":if(!h)return s(d.lit,"null");var Q;i&&(Q=a.getComment(h));var mt=Object.prototype.toString.apply(h)==="[object Array]",Re=$;$+=t;var de=o+Re,xe=o+$,Fe=H||v?"":de,T=[],V,D=S?[]:null,Be=b,He=g,Ue=c?"":d.com[0],_e=0,U,ee,G,J,he,M,K,re,ue;if(mt){for(U=0,ee=h.length;U<ee;U++){if(V=U<ee-1,Q?(M=Q.a[U]||[],K=Pe(M[1]),T.push(fe(M[0],`
`)+xe),D&&(M[0]||M[1]||K)&&(D=null)):T.push(xe),A=0,J=h[U],T.push(_(J,Q?K:!1,!0)+(V?c:"")),D){switch(typeof J){case"string":A=0,b=!0,g=0,D.push(_(J,!1,!0)+(V?d.com[0]:"")),b=Be,g=He;break;case"object":if(J){D=null;break}default:D.push(T[T.length-1]+(V?Ue:""));break}V&&(A+=d.com[0].length-d.com[2]),_e+=A}Q&&M[1]&&T.push(fe(M[1],K?" ":`
`,K))}ee===0?Q&&Q.e&&T.push(fe(Q.e[0],`
`)+de):T.push(de),T.length===0?re=s(d.arr,""):(re=Fe+s(d.arr,T.join("")),D&&(ue=D.join(" "),ue.length-_e<=S&&(re=s(d.arr,ue))))}else{var We=Q?Q.o.slice():[],Ee=[];for(G in h)Object.prototype.hasOwnProperty.call(h,G)&&We.indexOf(G)<0&&Ee.push(G);O&&Ee.sort();var Ve=We.concat(Ee);for(U=0,ee=Ve.length;U<ee;U++)if(V=U<ee-1,G=Ve[U],Q?(M=Q.c[G]||[],K=Pe(M[1]),T.push(fe(M[0],`
`)+xe),D&&(M[0]||M[1]||K)&&(D=null)):T.push(xe),A=0,J=h[G],he=_(J,Q&&K),T.push(x(G)+d.col[0]+(le(he)?"":" ")+he+(V?c:"")),Q&&M[1]&&T.push(fe(M[1],K?" ":`
`,K)),D){switch(typeof J){case"string":A=0,b=!0,g=0,he=_(J,!1),b=Be,g=He,D.push(x(G)+d.col[0]+" "+he+(V?d.com[0]:""));break;case"object":if(J){D=null;break}default:D.push(T[T.length-1]+(V?Ue:""));break}A+=d.col[0].length-d.col[2],V&&(A+=d.com[0].length-d.com[2]),_e+=A}ee===0?Q&&Q.e&&T.push(fe(Q.e[0],`
`)+de):T.push(de),T.length===0?re=s(d.obj,""):(re=Fe+s(d.obj,T.join("")),D&&(ue=D.join(" "),ue.length-_e<=S&&(re=s(d.obj,ue))))}return $=Re,re}}L=n.loadDsf(w,"stringify");var N="",R=i?R=(a.getComment(e)||{}).r:null;return R&&R[0]&&(N=R[0]+`
`),N+=_(e,null,!0,!0),R&&(N+=R[1]||""),N},me=qe;function ve(e,r,a){var n;return e&&(n={b:e}),r&&((n=n||{}).a=r),a&&((n=n||{}).x=a),n}function Qe(e,r){if(!(e===null||typeof e!="object")){var a=me.getComment(e);a&&me.removeComment(e);var n,l,o,t;if(Object.prototype.toString.apply(e)==="[object Array]"){for(t={a:{}},n=0,l=e.length;n<l;n++)$e(t.a,n,a.a[n],Qe(e[n]))&&(o=!0);!o&&a.e&&(t.e=ve(a.e[0],a.e[1]),o=!0)}else{t={s:{}};var i,v=Object.keys(e);for(a&&a.o?(i=[],a.o.concat(v).forEach(function(b){Object.prototype.hasOwnProperty.call(e,b)&&i.indexOf(b)<0&&i.push(b)})):i=v,t.o=i,n=0,l=i.length;n<l;n++){var C=i[n];$e(t.s,C,a.c[C],Qe(e[C]))&&(o=!0)}!o&&a.e&&(t.e=ve(a.e[0],a.e[1]),o=!0)}return r&&a&&a.r&&(t.r=ve(a.r[0],a.r[1])),o?t:void 0}}function pn(){var e="";return[].forEach.call(arguments,function(r){r&&r.trim()!==""&&(e&&(e+="; "),e+=r.trim())}),e}function yn(e,r){var a=[];if(Ie(e,r,a,[]),a.length>0){var n=Se(r,null,1);n+=`
# Orphaned comments:
`,a.forEach(function(l){n+=("# "+l.path.join("/")+": "+pn(l.b,l.a,l.e)).replace(`
`,"\\n ")+`
`}),Se(r,n,1)}}function $e(e,r,a,n){var l=ve(a?a[0]:void 0,a?a[1]:void 0,n);return l&&(e[r]=l),l}function pe(e,r){var a=ve(r.b,r.a);return a.path=e,a}function ye(e,r,a){if(e){var n,l;if(e.a)for(n=0,l=e.a.length;n<l;n++){var o=a.slice().concat([n]),t=e.a[n];t&&(r.push(pe(o,t)),ye(t.x,r,o))}else e.o&&e.o.forEach(function(i){var v=a.slice().concat([i]),C=e.s[i];C&&(r.push(pe(v,C)),ye(C.x,r,v))});e.e&&r.push(pe(a,e.e))}}function Ie(e,r,a,n){if(e){if(r===null||typeof r!="object"){ye(e,a,n);return}var l,o=me.createComment(r);if(n.length===0&&e.r&&(o.r=[e.r.b,e.r.a]),Object.prototype.toString.apply(r)==="[object Array]"){o.a=[];var t=e.a||{};for(var i in t)if(t.hasOwnProperty(i)){l=parseInt(i);var v=e.a[i];if(v){var C=n.slice().concat([l]);l<r.length?(o.a[l]=[v.b,v.a],Ie(v.x,r[l],a,C)):(a.push(pe(C,v)),ye(v.x,a,C))}}l===0&&e.e&&(o.e=[e.e.b,e.e.a])}else o.c={},o.o=[],(e.o||[]).forEach(function(b){var S=n.slice().concat([b]),g=e.s[b];Object.prototype.hasOwnProperty.call(r,b)?(o.o.push(b),g&&(o.c[b]=[g.b,g.a],Ie(g.x,r[b],a,S))):g&&(a.push(pe(S,g)),ye(g.x,a,S))}),e.e&&(o.e=[e.e.b,e.e.a])}}function Se(e,r,a){var n=me.createComment(e,me.getComment(e));return n.r||(n.r=["",""]),(r||r==="")&&(n.r[a]=me.forceComment(r)),n.r[a]||""}var xn={extract:function(e){return Qe(e,!0)},merge:yn,header:function(e,r){return Se(e,r,0)},footer:function(e,r){return Se(e,r,1)}};/*!
 * Hjson v3.2.1
 * https://hjson.github.io
 *
 * Copyright 2014-2017 Christian Zangl, MIT license
 * Details and documentation:
 * https://github.com/hjson/hjson-js
 *
 * This code is based on the the JSON version by Douglas Crockford:
 * https://github.com/douglascrockford/JSON-js (json_parse.js, json2.js)
 */var et=qe,_n=mn,tt=bn,nt=vn,Cn=xn,wn=Me,kn={parse:tt,stringify:nt,endOfLine:function(){return et.EOL},setEndOfLine:function(e){(e===`
`||e===`\r
`)&&(et.EOL=e)},version:_n,rt:{parse:function(e,r){return(r=r||{}).keepWsc=!0,tt(e,r)},stringify:function(e,r){return(r=r||{}).keepWsc=!0,nt(e,r)}},comments:Cn,dsf:wn.std};const rt=xt(kn),Sn="https://deepsearch.jina.ai",ut=_t("chatStore",{state:()=>({messages:[],response:[],isLoading:!1,isStreaming:!1,abortController:void 0}),getters:{usage:e=>{var r;return(r=e.response[e.response.length-1])==null?void 0:r.usage}},actions:{async send(e,r,a){var n;if(!this.isLoading){this.abortController=new AbortController,this.isLoading=!0;try{this.messages.push({role:"user",content:e,timestamp:Date.now()});const l={model:a,messages:this.messages.concat().filter(i=>!i.statusCode||i.statusCode===200),stream:!0};this.messages.push({role:"assistant",content:"",timestamp:Date.now()});const o=await fetch(`${Sn}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(l),signal:this.abortController.signal}),t=this.messages[this.messages.length-1];if(t.statusCode=o.status,t.timestamp=Date.now(),(n=o.headers.get("content-type"))!=null&&n.includes("text/event-stream")){if(o.body){const i=o.body.getReader(),v=new TextDecoder;for(;;){const{done:C,value:b}=await i.read();if(C){this.isLoading=!1,this.isStreaming=!1;break}b&&(this.isStreaming=!0,v.decode(b).split(`

data:`).filter(Boolean).forEach(c=>{const w=c.replace(/data: /,"").trim().replace(/\n/g,"\\\\n");console.log("Data:",w);try{if(w){const O=rt.parse(w);this.response.push(O),t.content+=O.choices[0].delta.content,O.usage&&(t.usage=O.usage)}}catch(O){console.error("Error parsing full JSON:",O);try{const d=/"delta":\s*({[^}]+})/,y=w.match(d);if(y&&y[1]){const p=rt.parse(y[1]);p.content&&(t.content+=p.content)}}catch(d){console.error("Failed to parse delta:",d);try{const y=/"content":\s*"((?:[^"\\]|\\.)*)"/,p=w.match(y);if(p&&p[1]){const I=p[1].replace(/\\n/g,`
`).replace(/\\\\/g,"\\").replace(/\\"/g,'"');t.content+=I}}catch(y){console.error("All parsing attempts failed:",y),t.content+="�"}}}}))}}}else{const i=await o.json();i&&(this.response=[i],this.messages.push(i.choices[0].message))}}catch(l){if(l.name!=="AbortError"){let o=l instanceof Error?l.message:String(l);this.messages[this.messages.length-1].statusCode===402&&(o=this.t("deepsearch.chat_ui.payment_required")),this.messages[this.messages.length-1].content=o,this.messages[this.messages.length-1].timestamp=Date.now(),Ct.create({message:o,color:"negative",icon:"error"})}}finally{this.isLoading=!1,this.isStreaming=!1}}},cancel(){var r;(r=this.abortController)==null||r.abort(),this.isLoading=!1,this.messages[this.messages.length-1].role==="assistant"&&this.messages.pop()}}}),qn=Ne({__name:"InputComponent",props:{maximizedWindow:{type:Boolean,default:!1},query:{type:String,default:""}},setup(e,{expose:r}){const{t:a}=De({useScope:"global"}),n=st(),l=ie(),o=ie(""),t=ut(),{isLoading:i,messages:v}=ke(t),C=it(),b=at(),{user:S}=ke(b),g=e,c=B(()=>!(typeof y(o.value)=="string"||i.value)),w=()=>{c.value&&(t.send(o.value,C.apiKey,"jina-deepsearch-v1"),p())},O=()=>{i.value=!1,t.cancel()},d=()=>{n.dialog({title:a("deepsearch.chat_ui.clear_context_title"),message:a("deepsearch.chat_ui.clear_context_message"),cancel:!0}).onOk(()=>{v.value=[]})},y=L=>L.trim().length===0?a("deepsearch.chat_ui.input_cant_be_empty"):!0,p=()=>{o.value=""};r({reset:p}),wt(()=>{g.query&&(o.value=g.query)});const I={t:a,$q:n,form:l,inputMessage:o,chatStore:t,isLoading:i,messages:v,embeddingStore:C,userStore:b,user:S,props:g,sendable:c,onSubmit:w,onCancel:O,onClear:d,validateInput:y,reset:p,get QForm(){return Kt},get handleShiftEnter(){return tn}};return Object.defineProperty(I,"__isScriptSetup",{enumerable:!1,value:!0}),I}});function jn(e,r,a,n,l,o){return k(),E(n.QForm,{ref:"form",class:"full-width",onSubmit:qt(n.onSubmit,["prevent"])},{default:q(()=>[j(kt,{class:"full-height q-mb-xs",modelValue:n.inputMessage,"onUpdate:modelValue":[r[1]||(r[1]=t=>n.inputMessage=t),t=>{}],filled:"",autofocus:"",square:"",autogrow:"","hide-bottom-space":"","lazy-rules":"ondemand",rules:[n.validateInput],onKeydown:r[2]||(r[2]=t=>n.handleShiftEnter(t,()=>{var i;return(i=n.form)==null?void 0:i.submit(t)})),ref:"inputAnchor","input-style":"max-height: 50vh;",placeholder:n.t("deepsearch.chat_ui.input_placeholder")},St({prepend:q(()=>[j(oe,{flat:"",round:"",icon:"add_comment",disable:n.isLoading||!n.messages.length,onClick:n.onClear},{default:q(()=>[j(Jt,null,{default:q(()=>[Ce(we(n.t("deepsearch.chat_ui.new_chat")),1)]),_:1})]),_:1},8,["disable"])]),append:q(()=>[n.isLoading?(k(),E(oe,{key:0,flat:"",round:"",icon:"o_stop_circle",color:"negative",onClick:n.onCancel})):(k(),E(oe,{key:1,flat:"",round:"",icon:"send",color:n.sendable?"primary":"grey",disable:!n.sendable||n.isLoading,onClick:r[0]||(r[0]=t=>{var i;return(i=n.form)==null?void 0:i.submit(t)})},null,8,["color","disable"]))]),_:2},[a.maximizedWindow?void 0:{name:"before",fn:q(()=>{var t;return[(t=n.user)!=null&&t.photoURL?(k(),E(be,{key:0,size:"md",round:"",class:"bordered-avatar q-ml-md"},{default:q(()=>[j(Le,{src:n.user.photoURL,referrerpolicy:"no-referrer",alt:n.user.displayName||""},null,8,["src","alt"])]),_:1})):(k(),E(be,{key:1,icon:"person",size:"md",class:"bordered-avatar q-ml-md"}))]}),key:"0"}]),1032,["modelValue","rules","placeholder"])]),_:1},512)}const On=ze(qn,[["render",jn],["__file","InputComponent.vue"]]);var ct=(e=>(e[e.TOP=0]="TOP",e[e.BOTTOM=1]="BOTTOM",e))(ct||{});const En=Ne({__name:"ChatComponent",props:{maximizedWindow:{type:Boolean,default:!1}},setup(e,{expose:r}){r();const{t:a}=De({useScope:"global"}),n=ut(),{messages:l,isLoading:o}=ke(n),t=ie(null),i=ie(!0),v=ie(""),C=ie(0),b=w=>{Ze(()=>{i.value&&(C.value=w.height,g(1))})},S=w=>{Ze(()=>{var y,p;const O=(y=t.value)==null?void 0:y.$el,d=O.offsetHeight+O.scrollTop-O.scrollHeight;w.direction==="up"&&((p=l.value)!=null&&p.length)&&d<-5&&(i.value=!1),w.direction==="down"&&d>=-5&&(i.value=!0)})},g=w=>{setTimeout(()=>{if(t.value&&t.value.$el){const O=w===0?0:t.value.$el.scrollHeight;t.value.$el.scrollTo({top:O,behavior:"smooth"})}},10)};jt(()=>{o.value=!1,l.value=[]}),Ot(async()=>{i.value=!0});const c={t:a,chatStore:n,messages:l,isLoading:o,scrollTarget:t,autoScroll:i,exampleQuery:v,virtualScrollHeight:C,onResize:b,onScroll:S,SCROLL_POSITION:ct,scrollTo:g,get QVirtualScroll(){return At},get QCardSection(){return Et},get QCard(){return Tt},MessageComponent:en,InputComponent:On,get deepSearchFlow(){return Bt},UsageHeader:Ht};return Object.defineProperty(c,"__isScriptSetup",{enumerable:!1,value:!0}),c}}),Tn={class:"column no-wrap"},Qn={class:"col-12"};function In(e,r,a,n,l,o){return k(),E(n.QCard,{bordered:!a.maximizedWindow,flat:"",square:"",class:"column fit relative-position no-wrap",style:{"max-height":"100vh"}},{default:q(()=>[a.maximizedWindow?(k(),se(ge,{key:0},[j(n.UsageHeader,{class:"full-width","home-link":"/deepsearch","faq-link":"/deepsearch#faq","issue-link":"https://github.com/jina-ai/node-DeepResearch/issues","is-support-c-s-p":!1,"api-link":"https://github.com/jina-ai/node-DeepResearch?tab=readme-ov-file#openai-compatible-server-api"}),j(Qt)],64)):ce("",!0),a.maximizedWindow?ce("",!0):(k(),E(oe,{key:1,flat:"",round:"",icon:"fullscreen",class:"absolute-top-left q-ml-md q-mt-md z-top",to:"/api-dashboard/deepsearch-chat"})),n.messages.length?(k(),E(n.QCardSection,{key:3,class:"column justify-between no-wrap q-px-lg scroll q-mb-xl",ref:"scrollTarget"},{default:q(()=>[j(Lt,{onScroll:n.onScroll,debounce:300}),Ye("div",Tn,[j(Nt,{appear:"","enter-active-class":"animated fadeIn","leave-active-class":"animated fadeOut",duration:50},{default:q(()=>[Ye("div",Qn,[j(n.QVirtualScroll,{items:n.messages},{default:q(({item:t,index:i})=>[j(Mt,{onResize:n.onResize,debounce:300}),j(n.MessageComponent,{message:t,index:i},null,8,["message","index"])]),_:1},8,["items"])])]),_:1})])]),_:1},512)):(k(),E(n.QCardSection,{key:2,class:"full-height column justify-center"},{default:q(()=>[j(Le,{src:n.deepSearchFlow,"img-style":{opacity:.1},fit:"fill",class:"col-5"},null,8,["src"]),(k(),se(ge,null,It([1,2,3],t=>j(oe,{"no-caps":"",flat:"",label:n.t(`deepsearch.chat_ui.example_q${t}`),key:t,class:"text-dim q-py-md",onClick:i=>n.exampleQuery=n.t(`deepsearch.chat_ui.example_q${t}`)},null,8,["label","onClick"])),64))]),_:1})),j(Dt,{class:"lock-blur absolute-bottom"},{default:q(()=>[j(n.InputComponent,{maximizedWindow:a.maximizedWindow,query:n.exampleQuery},null,8,["maximizedWindow","query"])]),_:1})]),_:1},8,["bordered"])}const Jn=ze(En,[["render",In],["__file","ChatComponent.vue"]]);export{Jn as C};
