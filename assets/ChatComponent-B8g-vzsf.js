import{s as G,m as C,p as b,ce as Y,j as D,a0 as E,u as W,am as R,k as w,n as N,a2 as I,a3 as i,a4 as u,a5 as c,aa as q,ah as z,b5 as M,a6 as l,ad as P,ae as H,aq as X,af as U,ag as j,ab as B,q as Q,aj as Z,aB as $,bS as ee,aQ as ae,aU as te,aL as se,aP as ne,W as oe,ba as re,a9 as ie,a7 as le,V as A,ap as ce,ai as de,a8 as O,T as me,bT as ue}from"./index-Be8_06zm.js";import{Q as V}from"./QChip-C5s1Apqj.js";import{Q as ge}from"./QScrollObserver-BSt7lbwa.js";import{Q as he}from"./QResizeObserver-NSKdq0Ap.js";import{i as fe}from"./date-Dm7r_ugb.js";import{Q as pe}from"./QSpinnerDots-DbQXM-sb.js";import{Q as ve,d as _e,U as be}from"./BrowserInfoDialog-BWtQYzyr.js";import{Q as ye}from"./QItemLabel-EJ0rSKbC.js";import{Q as xe}from"./QExpansionItem-D0basnx9.js";import{T as ke}from"./QSpinnerRings-B8v_M3e-.js";import{u as F}from"./use-dialog-plugin-component-FZ5RKWqm.js";import{P as Ce}from"./crypto-B0wQaBEZ.js";import{Q as Se}from"./QTooltip-bbEXEkxy.js";import{a as qe}from"./finetune-BEc_4AJo.js";const we=G({name:"QChatMessage",props:{sent:Boolean,label:String,bgColor:String,textColor:String,name:String,avatar:String,text:Array,stamp:String,size:String,labelHtml:Boolean,nameHtml:Boolean,textHtml:Boolean,stampHtml:Boolean},setup(a,{slots:s}){const n=C(()=>a.sent===!0?"sent":"received"),e=C(()=>`q-message-text-content q-message-text-content--${n.value}`+(a.textColor!==void 0?` text-${a.textColor}`:"")),m=C(()=>`q-message-text q-message-text--${n.value}`+(a.bgColor!==void 0?` text-${a.bgColor}`:"")),r=C(()=>"q-message-container row items-end no-wrap"+(a.sent===!0?" reverse":"")),t=C(()=>a.size!==void 0?`col-${a.size}`:""),o=C(()=>({msg:a.textHtml===!0?"innerHTML":"textContent",stamp:a.stampHtml===!0?"innerHTML":"textContent",name:a.nameHtml===!0?"innerHTML":"textContent",label:a.labelHtml===!0?"innerHTML":"textContent"}));function S(d){return s.stamp!==void 0?[d,b("div",{class:"q-message-stamp"},s.stamp())]:a.stamp?[d,b("div",{class:"q-message-stamp",[o.value.stamp]:a.stamp})]:[d]}function x(d,_){const h=_===!0?d.length>1?g=>g:g=>b("div",[g]):g=>b("div",{[o.value.msg]:g});return d.map((g,p)=>b("div",{key:p,class:m.value},[b("div",{class:e.value},S(h(g)))]))}return()=>{const d=[];s.avatar!==void 0?d.push(s.avatar()):a.avatar!==void 0&&d.push(b("img",{class:`q-message-avatar q-message-avatar--${n.value}`,src:a.avatar,"aria-hidden":"true"}));const _=[];s.name!==void 0?_.push(b("div",{class:`q-message-name q-message-name--${n.value}`},s.name())):a.name!==void 0&&_.push(b("div",{class:`q-message-name q-message-name--${n.value}`,[o.value.name]:a.name})),s.default!==void 0?_.push(x(Y(s.default()),!0)):a.text!==void 0&&_.push(x(a.text)),d.push(b("div",{class:t.value},_));const h=[];return s.label!==void 0?h.push(b("div",{class:"q-message-label"},s.label())):a.label!==void 0&&h.push(b("div",{class:"q-message-label",[o.value.label]:a.label})),h.push(b("div",{class:r.value},d)),b("div",{class:`q-message q-message-${n.value}`},h)}}}),Qe=D({__name:"MessageComponent",props:{message:{},width:{},index:{},disabled:{type:Boolean}},setup(a,{expose:s}){s();const n=a,e=N(),{t:m}=E(),r=W(),{user:t}=R(r),o=F(),S=w(!1),x=C(()=>n.message.role==="user"),d=C(()=>n.message.role==="assistant"),_=C(()=>{const f=n.message.content,y="<think>",k="</think>";if(f.includes(y))if(f.includes(k)){const L=/<think>(.*?)<\/think>/s,T=f.match(L);if(T)return T[1]}else return f.substring(f.indexOf(y)+y.length);return""}),h=C(()=>n.message.content.includes("<think>")&&!n.message.content.includes("</think>")),g=C(()=>{const f=n.message.content;let y="";const k="</think>";return f.includes(k)?y=f.substring(f.indexOf(k)+k.length):f.includes("<think>")||(y=f),y.replace(/<references>|<\/references>/g,"")}),v={props:n,$q:e,t:m,userStore:r,user:t,embeddingStore:o,isLoading:S,isUserRole:x,isAssistantRole:d,think:_,isThinking:h,answer:g,onPurchase:()=>{e.dialog({component:Ce,componentProps:{purchaseKey:o.apiKey}})},TypingText:ke};return Object.defineProperty(v,"__isScriptSetup",{enumerable:!1,value:!0}),v}}),Te={key:0},ze={key:1,class:"relative-position"};function Me(a,s,n,e,m,r){return i(),u(we,{class:Z(["q-pa-md q-pb-lg relative-position message",e.isUserRole?"user-message":"assistant-message"]),sent:e.isUserRole,size:e.isUserRole?"auto":8,"text-color":"white"},{avatar:c(()=>{var t;return[e.isUserRole?(i(),q(z,{key:0},[(t=e.user)!=null&&t.photoURL?(i(),u(M,{key:0,size:"md",round:"",class:"bordered-avatar q-ml-md"},{default:c(()=>[l(V,{src:e.user.photoURL,referrerpolicy:"no-referrer",alt:e.user.displayName||""},null,8,["src","alt"])]),_:1})):(i(),u(M,{key:1,icon:"person",size:"md",class:"bordered-avatar q-ml-md"}))],64)):(i(),u(M,{key:1,icon:"img:/J.svg",class:"bordered-avatar q-mr-md bg-mixed-200",size:"md"}))]}),default:c(()=>[e.isUserRole?(i(),q("div",Te,[l(e.TypingText,{text:n.message.content,dark:e.isAssistantRole},null,8,["text","dark"])])):(i(),q("div",ze,[n.message.content.length?(i(),q(z,{key:1},[e.isLoading||!e.isLoading&&n.message.content.includes("<think>")?(i(),u(xe,{key:0,class:"full-width","expand-separator":"","model-value":e.isThinking,"header-class":"bg-mixed-200 text-black"},{header:c(()=>[l(P,{class:"full-width",dense:""},{default:c(()=>[l(H,{side:""},{default:c(()=>[e.isThinking?(i(),u(ve,{key:0})):(i(),u(X,{key:1,name:"task_alt"}))]),_:1}),l(H,null,{default:c(()=>[l(ye,null,{default:c(()=>[U(j(e.t("deepsearch.chat_ui.thinking")),1)]),_:1})]),_:1})]),_:1})]),default:c(()=>[l(P,{class:"q-pa-lg"},{default:c(()=>[l(H,{class:"text-dim",style:{"font-family":"monospace"}},{default:c(()=>[U(j(e.think),1)]),_:1})]),_:1})]),_:1},8,["model-value"])):B("",!0),e.answer?(i(),u(e.TypingText,{key:1,text:e.answer,loading:e.isLoading,"content-class":"q-ma-md"},null,8,["text","loading","content-class"])):B("",!0),n.message.statusCode===402?(i(),q(z,{key:2},[l(Q,{color:"primary",square:"",outline:"",label:e.t("deepsearch.chat_ui.purchase"),onClick:e.onPurchase,icon:"shopping_cart",class:"q-ma-sm"},null,8,["label"]),l(Q,{color:"white",square:"",outline:"",label:e.t("deepsearch.chat_ui.keyman"),to:"/api-dashboard/key-manager",icon:"key",class:"q-ma-sm"},null,8,["label"])],64)):B("",!0)],64)):(i(),u(pe,{key:0,size:"md",class:"q-ma-md"}))]))]),_:1},8,["class","sent","size"])}const Be=I(Qe,[["render",Me],["__file","MessageComponent.vue"]]),Le=(a,s)=>{if(a.shiftKey&&a.key==="Enter")return 13;a.key==="Enter"&&(a.preventDefault(),s())},Re="https://deepsearch.jina.ai",K=$("chatStore",{state:()=>({messages:[],response:[],isLoading:!1,isStreaming:!1,abortController:void 0}),getters:{usage:a=>{var s;return(s=a.response[a.response.length-1])==null?void 0:s.usage}},actions:{async send(a,s,n){var e;if(!this.isLoading){this.abortController=new AbortController,this.isLoading=!0;try{this.messages.push({role:"user",content:a,timestamp:Date.now()});const m={model:n,messages:this.messages.concat().filter(o=>!o.statusCode||o.statusCode===200),stream:!0};this.messages.push({role:"assistant",content:"",timestamp:Date.now()});const r=await fetch(`${Re}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify(m),signal:this.abortController.signal}),t=this.messages[this.messages.length-1];if(t.statusCode=r.status,t.timestamp=Date.now(),(e=r.headers.get("content-type"))!=null&&e.includes("text/event-stream")){if(r.body){const o=r.body.getReader(),S=new TextDecoder;for(;;){const{done:x,value:d}=await o.read();if(x){this.isLoading=!1,this.isStreaming=!1;break}d&&(this.isStreaming=!0,S.decode(d).split(`

`).filter(Boolean).forEach(g=>{const p=g.replace(/data: /,"").replace(/\n/g,"\\\\n");console.log("Data:",p);try{if(p){const v=JSON.parse(p);this.response.push(v),t.content+=v.choices[0].delta.content}}catch(v){console.error("Error:",v)}}))}}}else{const o=await r.json();o&&(this.response=[o],this.messages.push(o.choices[0].message))}}catch(m){if(m.name!=="AbortError"){let r=m instanceof Error?m.message:String(m);this.messages[this.messages.length-1].statusCode===402&&(r=this.t("deepsearch.chat_ui.payment_required")),this.messages[this.messages.length-1].content=r,this.messages[this.messages.length-1].timestamp=Date.now(),ee.create({message:r,color:"negative",icon:"error"})}}finally{this.isLoading=!1,this.isStreaming=!1}}},cancel(){var s;(s=this.abortController)==null||s.abort(),this.isLoading=!1,this.messages[this.messages.length-1].role==="assistant"&&this.messages.pop()}}}),He=D({__name:"InputComponent",props:{maximizedWindow:{type:Boolean,default:!1},query:{type:String,default:""}},setup(a,{expose:s}){const{t:n}=E({useScope:"global"}),e=N(),m=w(),r=w(""),t=K(),{isLoading:o,messages:S}=R(t),x=F(),d=W(),{user:_}=R(d),h=a,g=C(()=>!(typeof y(r.value)=="string"||o.value)),p=()=>{g.value&&(t.send(r.value,x.apiKey,"jina-deepsearch-v1"),k())},v=()=>{o.value=!1,t.cancel()},f=()=>{e.dialog({title:n("deepsearch.chat_ui.clear_context_title"),message:n("deepsearch.chat_ui.clear_context_message"),cancel:!0}).onOk(()=>{S.value=[]})},y=T=>T.trim().length===0?n("deepsearch.chat_ui.input_cant_be_empty"):!0,k=()=>{r.value=""};s({reset:k}),ae(()=>{h.query&&(r.value=h.query)});const L={t:n,$q:e,form:m,inputMessage:r,chatStore:t,isLoading:o,messages:S,embeddingStore:x,userStore:d,user:_,props:h,sendable:g,onSubmit:p,onCancel:v,onClear:f,validateInput:y,reset:k,get QForm(){return qe},get handleShiftEnter(){return Le}};return Object.defineProperty(L,"__isScriptSetup",{enumerable:!1,value:!0}),L}});function Ue(a,s,n,e,m,r){return i(),u(e.QForm,{ref:"form",class:"full-width",onSubmit:ne(e.onSubmit,["prevent"])},{default:c(()=>[l(te,{class:"full-height q-mb-xs",modelValue:e.inputMessage,"onUpdate:modelValue":[s[1]||(s[1]=t=>e.inputMessage=t),t=>{}],filled:"",autofocus:"",square:"",autogrow:"","hide-bottom-space":"","lazy-rules":"ondemand",rules:[e.validateInput],onKeydown:s[2]||(s[2]=t=>e.handleShiftEnter(t,()=>{var o;return(o=e.form)==null?void 0:o.submit(t)})),ref:"inputAnchor","input-style":"max-height: 50vh;",placeholder:e.t("deepsearch.chat_ui.input_placeholder")},se({prepend:c(()=>[l(Q,{flat:"",round:"",icon:"add_comment",disable:e.isLoading||!e.messages.length,onClick:e.onClear},{default:c(()=>[l(Se,null,{default:c(()=>[U(j(e.t("deepsearch.chat_ui.new_chat")),1)]),_:1})]),_:1},8,["disable"])]),append:c(()=>[e.isLoading?(i(),u(Q,{key:0,flat:"",round:"",icon:"o_stop_circle",color:"negative",onClick:e.onCancel})):(i(),u(Q,{key:1,flat:"",round:"",icon:"send",color:e.sendable?"primary":"grey",disable:!e.sendable||e.isLoading,onClick:s[0]||(s[0]=t=>{var o;return(o=e.form)==null?void 0:o.submit(t)})},null,8,["color","disable"]))]),_:2},[n.maximizedWindow?void 0:{name:"before",fn:c(()=>{var t;return[(t=e.user)!=null&&t.photoURL?(i(),u(M,{key:0,size:"md",round:"",class:"bordered-avatar q-ml-md"},{default:c(()=>[l(V,{src:e.user.photoURL,referrerpolicy:"no-referrer",alt:e.user.displayName||""},null,8,["src","alt"])]),_:1})):(i(),u(M,{key:1,icon:"person",size:"md",class:"bordered-avatar q-ml-md"}))]}),key:"0"}]),1032,["modelValue","rules","placeholder"])]),_:1},512)}const je=I(He,[["render",Ue],["__file","InputComponent.vue"]]);var J=(a=>(a[a.TOP=0]="TOP",a[a.BOTTOM=1]="BOTTOM",a))(J||{});const De=D({__name:"ChatComponent",props:{maximizedWindow:{type:Boolean,default:!1}},setup(a,{expose:s}){s();const{t:n}=E({useScope:"global"}),e=K(),{messages:m,isLoading:r}=R(e),t=w(null),o=w(!0),S=w(""),x=w(0),d=p=>{A(()=>{o.value&&(x.value=p.height,h(1))})},_=p=>{A(()=>{var y,k;const v=(y=t.value)==null?void 0:y.$el,f=v.offsetHeight+v.scrollTop-v.scrollHeight;p.direction==="up"&&((k=m.value)!=null&&k.length)&&f<-5&&(o.value=!1),p.direction==="down"&&f>=-5&&(o.value=!0)})},h=p=>{setTimeout(()=>{if(t.value&&t.value.$el){const v=p===0?0:t.value.$el.scrollHeight;t.value.$el.scrollTo({top:v,behavior:"smooth"})}},10)};oe(()=>{r.value=!1,m.value=[]}),re(async()=>{o.value=!0});const g={t:n,chatStore:e,messages:m,isLoading:r,scrollTarget:t,autoScroll:o,exampleQuery:S,virtualScrollHeight:x,onResize:d,onScroll:_,SCROLL_POSITION:J,scrollTo:h,get QVirtualScroll(){return fe},get QCardSection(){return ie},get QCard(){return le},MessageComponent:Be,InputComponent:je,get deepSearchFlow(){return _e},UsageHeader:be};return Object.defineProperty(g,"__isScriptSetup",{enumerable:!1,value:!0}),g}}),Ee={class:"column no-wrap"},Ie={class:"col-12"};function Ve(a,s,n,e,m,r){return i(),u(e.QCard,{bordered:!n.maximizedWindow,flat:"",square:"",class:"column fit relative-position no-wrap",style:{"max-height":"100vh"}},{default:c(()=>[n.maximizedWindow?(i(),q(z,{key:0},[l(e.UsageHeader,{class:"full-width","home-link":"/deepsearch","faq-link":"/deepsearch#faq","issue-link":"https://github.com/jina-ai/node-DeepResearch/issues","is-support-c-s-p":!1,"api-link":"https://github.com/jina-ai/node-DeepResearch?tab=readme-ov-file#openai-compatible-server-api"}),l(ce)],64)):B("",!0),n.maximizedWindow?B("",!0):(i(),u(Q,{key:1,flat:"",round:"",icon:"fullscreen",class:"absolute-top-left q-ml-md q-mt-md z-top",to:"/api-dashboard/deepsearch-chat"})),e.messages.length?(i(),u(e.QCardSection,{key:3,class:"column justify-between no-wrap q-px-lg scroll q-mb-xl",ref:"scrollTarget"},{default:c(()=>[l(ge,{onScroll:e.onScroll,debounce:300}),O("div",Ee,[l(me,{appear:"","enter-active-class":"animated fadeIn","leave-active-class":"animated fadeOut",duration:50},{default:c(()=>[O("div",Ie,[l(e.QVirtualScroll,{items:e.messages},{default:c(({item:t,index:o})=>[l(he,{onResize:e.onResize,debounce:300}),l(e.MessageComponent,{message:t,index:o},null,8,["message","index"])]),_:1},8,["items"])])]),_:1})])]),_:1},512)):(i(),u(e.QCardSection,{key:2,class:"full-height column justify-center"},{default:c(()=>[l(V,{src:e.deepSearchFlow,"img-style":{opacity:.1},fit:"fill",class:"col-5"},null,8,["src"]),(i(),q(z,null,de([1,2,3],t=>l(Q,{"no-caps":"",flat:"",label:e.t(`deepsearch.chat_ui.example_q${t}`),key:t,class:"text-dim q-py-md",onClick:o=>e.exampleQuery=e.t(`deepsearch.chat_ui.example_q${t}`)},null,8,["label","onClick"])),64))]),_:1})),l(ue,{class:"lock-blur absolute-bottom"},{default:c(()=>[l(e.InputComponent,{maximizedWindow:n.maximizedWindow,query:e.exampleQuery},null,8,["maximizedWindow","query"])]),_:1})]),_:1},8,["bordered"])}const aa=I(De,[["render",Ve],["__file","ChatComponent.vue"]]);export{aa as C};
