import{s as X,m as k,p as y,ce as Z,j as E,a0 as D,u as F,am as U,k as Q,n as K,a2 as I,a3 as r,a4 as m,a5 as l,aa as w,ah as M,b5 as B,a6 as c,ab as z,ad as P,ae as j,aq as $,af as H,ag as R,q as T,aj as ee,aB as ae,bS as te,aQ as se,aU as ne,aL as oe,aP as re,W as ie,ba as le,a9 as ce,a7 as de,V as A,ap as me,ai as ue,a8 as O,T as ge,bT as he}from"./index-CtB9QYP8.js";import{Q as N,b as fe}from"./QChip-CKAHW3LY.js";import{Q as pe}from"./QScrollObserver-DLsF4ign.js";import{Q as ve}from"./QResizeObserver-KoRNEdyj.js";import{f as _e,i as be}from"./date-mrPLZ0P5.js";import{Q as ye}from"./QSpinnerDots-B9JLA_x3.js";import{Q as ke,d as xe,U as Ce}from"./BrowserInfoDialog-p-iyVHcP.js";import{Q as W}from"./QItemLabel-9w5--C14.js";import{Q as Se}from"./QExpansionItem-_uXh4fmE.js";import{T as qe}from"./QSpinnerRings-CvKRDIOm.js";import{u as J}from"./use-dialog-plugin-component-Cal4FLHO.js";import{P as we}from"./crypto-XwkKj832.js";import{Q as Qe}from"./QTooltip-CE5kKNn_.js";import{a as Te}from"./finetune-DmhG2GWv.js";const ze=X({name:"QChatMessage",props:{sent:Boolean,label:String,bgColor:String,textColor:String,name:String,avatar:String,text:Array,stamp:String,size:String,labelHtml:Boolean,nameHtml:Boolean,textHtml:Boolean,stampHtml:Boolean},setup(a,{slots:o}){const s=k(()=>a.sent===!0?"sent":"received"),e=k(()=>`q-message-text-content q-message-text-content--${s.value}`+(a.textColor!==void 0?` text-${a.textColor}`:"")),g=k(()=>`q-message-text q-message-text--${s.value}`+(a.bgColor!==void 0?` text-${a.bgColor}`:"")),i=k(()=>"q-message-container row items-end no-wrap"+(a.sent===!0?" reverse":"")),t=k(()=>a.size!==void 0?`col-${a.size}`:""),n=k(()=>({msg:a.textHtml===!0?"innerHTML":"textContent",stamp:a.stampHtml===!0?"innerHTML":"textContent",name:a.nameHtml===!0?"innerHTML":"textContent",label:a.labelHtml===!0?"innerHTML":"textContent"}));function C(d){return o.stamp!==void 0?[d,y("div",{class:"q-message-stamp"},o.stamp())]:a.stamp?[d,y("div",{class:"q-message-stamp",[n.value.stamp]:a.stamp})]:[d]}function x(d,_){const p=_===!0?d.length>1?f=>f:f=>y("div",[f]):f=>y("div",{[n.value.msg]:f});return d.map((f,v)=>y("div",{key:v,class:g.value},[y("div",{class:e.value},C(p(f)))]))}return()=>{const d=[];o.avatar!==void 0?d.push(o.avatar()):a.avatar!==void 0&&d.push(y("img",{class:`q-message-avatar q-message-avatar--${s.value}`,src:a.avatar,"aria-hidden":"true"}));const _=[];o.name!==void 0?_.push(y("div",{class:`q-message-name q-message-name--${s.value}`},o.name())):a.name!==void 0&&_.push(y("div",{class:`q-message-name q-message-name--${s.value}`,[n.value.name]:a.name})),o.default!==void 0?_.push(x(Z(o.default()),!0)):a.text!==void 0&&_.push(x(a.text)),d.push(y("div",{class:t.value},_));const p=[];return o.label!==void 0?p.push(y("div",{class:"q-message-label"},o.label())):a.label!==void 0&&p.push(y("div",{class:"q-message-label",[n.value.label]:a.label})),p.push(y("div",{class:i.value},d)),y("div",{class:`q-message q-message-${s.value}`},p)}}}),Me=E({__name:"MessageComponent",props:{message:{},width:{},index:{},disabled:{type:Boolean}},setup(a,{expose:o}){o();const s=a,e=K(),{t:g}=D(),i=F(),{user:t}=U(i),n=J(),C=Q(!1),x=k(()=>s.message.role==="user"),d=k(()=>s.message.role==="assistant"),_=k(()=>{var u;return((u=s.message.usage)==null?void 0:u.total_tokens)||0}),p=k(()=>{const u=s.message.content,b="<think>",S="</think>";if(u.includes(b))if(u.includes(S)){const L=/<think>(.*?)<\/think>/s,V=u.match(L);if(V)return V[1]}else return u.substring(u.indexOf(b)+b.length);return""}),f=k(()=>s.message.content.includes("<think>")&&!s.message.content.includes("</think>")),v=k(()=>{const u=s.message.content;let b="";const S="</think>";return u.includes(S)?b=u.substring(u.indexOf(S)+S.length):u.includes("<think>")||(b=u),b.replace(/<references>|<\/references>/g,"")}),q={props:s,$q:e,t:g,userStore:i,user:t,embeddingStore:n,isLoading:C,isUserRole:x,isAssistantRole:d,tokens:_,think:p,isThinking:f,answer:v,onPurchase:()=>{e.dialog({component:we,componentProps:{purchaseKey:n.apiKey}})},TypingText:qe,get formatNumber(){return _e}};return Object.defineProperty(q,"__isScriptSetup",{enumerable:!1,value:!0}),q}}),Be={key:0},Le={key:1,class:"relative-position"};function He(a,o,s,e,g,i){return r(),m(ze,{class:ee(["q-pa-md q-pb-lg relative-position message",e.isUserRole?"user-message":"assistant-message"]),sent:e.isUserRole,"text-color":"white"},{avatar:l(()=>{var t;return[e.isUserRole?(r(),w(M,{key:0},[(t=e.user)!=null&&t.photoURL?(r(),m(B,{key:0,size:"md",round:"",class:"bordered-avatar q-ml-md"},{default:l(()=>[c(N,{src:e.user.photoURL,referrerpolicy:"no-referrer",alt:e.user.displayName||""},null,8,["src","alt"])]),_:1})):(r(),m(B,{key:1,icon:"person",size:"md",class:"bordered-avatar q-ml-md"}))],64)):(r(),m(B,{key:1,icon:"img:/J.svg",class:"bordered-avatar q-mr-md bg-mixed-200",size:"md"}))]}),stamp:l(()=>[e.tokens?(r(),m(fe,{key:0,icon:"straighten",label:`${e.formatNumber(e.tokens)} ${e.t("embedding.tokens")}`,size:"sm",class:"text-dim bg-transparent"},null,8,["label"])):z("",!0)]),default:l(()=>[e.isUserRole?(r(),w("div",Be,[c(e.TypingText,{text:s.message.content,dark:e.isAssistantRole},null,8,["text","dark"])])):(r(),w("div",Le,[s.message.content.length?(r(),w(M,{key:1},[e.isLoading||!e.isLoading&&s.message.content.includes("<think>")?(r(),m(Se,{key:0,class:"full-width","expand-separator":"","model-value":e.isThinking,"header-class":"bg-mixed-200 text-black"},{header:l(()=>[c(P,{class:"full-width",dense:""},{default:l(()=>[c(j,{side:""},{default:l(()=>[e.isThinking?(r(),m(ke,{key:0})):(r(),m($,{key:1,name:"task_alt"}))]),_:1}),c(j,null,{default:l(()=>[e.isThinking?(r(),m(W,{key:0},{default:l(()=>[H(R(e.t("deepsearch.chat_ui.thinking")),1)]),_:1})):(r(),m(W,{key:1},{default:l(()=>[H(R(e.t("deepsearch.chat_ui.thinking_done")),1)]),_:1}))]),_:1})]),_:1})]),default:l(()=>[c(P,{class:"q-pa-lg"},{default:l(()=>[c(j,{class:"text-dim",style:{"font-family":"monospace"}},{default:l(()=>[H(R(e.think),1)]),_:1})]),_:1})]),_:1},8,["model-value"])):z("",!0),e.answer?(r(),m(e.TypingText,{key:1,text:e.answer,loading:e.isLoading,"content-class":"q-ma-md"},null,8,["text","loading","content-class"])):z("",!0),s.message.statusCode===402?(r(),w(M,{key:2},[c(T,{color:"primary",square:"",outline:"",label:e.t("deepsearch.chat_ui.purchase"),onClick:e.onPurchase,icon:"shopping_cart",class:"q-ma-sm"},null,8,["label"]),c(T,{color:"white",square:"",outline:"",label:e.t("deepsearch.chat_ui.keyman"),to:"/api-dashboard/key-manager",icon:"key",class:"q-ma-sm"},null,8,["label"])],64)):z("",!0)],64)):(r(),m(ye,{key:0,size:"md",class:"q-ma-md"}))]))]),_:1},8,["class","sent"])}const Re=I(Me,[["render",He],["__file","MessageComponent.vue"]]),Ue=(a,o)=>{if(a.shiftKey&&a.key==="Enter")return 13;a.key==="Enter"&&(a.preventDefault(),o())},je="https://deepsearch.jina.ai",G=ae("chatStore",{state:()=>({messages:[],response:[],isLoading:!1,isStreaming:!1,abortController:void 0}),getters:{usage:a=>{var o;return(o=a.response[a.response.length-1])==null?void 0:o.usage}},actions:{async send(a,o,s){var e;if(!this.isLoading){this.abortController=new AbortController,this.isLoading=!0;try{this.messages.push({role:"user",content:a,timestamp:Date.now()});const g={model:s,messages:this.messages.concat().filter(n=>!n.statusCode||n.statusCode===200),stream:!0};this.messages.push({role:"assistant",content:"",timestamp:Date.now()});const i=await fetch(`${je}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify(g),signal:this.abortController.signal}),t=this.messages[this.messages.length-1];if(t.statusCode=i.status,t.timestamp=Date.now(),(e=i.headers.get("content-type"))!=null&&e.includes("text/event-stream")){if(i.body){const n=i.body.getReader(),C=new TextDecoder;for(;;){const{done:x,value:d}=await n.read();if(x){this.isLoading=!1,this.isStreaming=!1;break}d&&(this.isStreaming=!0,C.decode(d).split(`

data:`).filter(Boolean).forEach(f=>{const v=f.replace(/data: /,"").trim().replace(/\n/g,"\\\\n");console.log("Data:",v);try{if(v){const h=JSON.parse(v);this.response.push(h),t.content+=h.choices[0].delta.content,h.usage&&(t.usage=h.usage)}}catch(h){console.error("Error:",h),t.content+=h instanceof Error?h.message:String(h),n.cancel()}}))}}}else{const n=await i.json();n&&(this.response=[n],this.messages.push(n.choices[0].message))}}catch(g){if(g.name!=="AbortError"){let i=g instanceof Error?g.message:String(g);this.messages[this.messages.length-1].statusCode===402&&(i=this.t("deepsearch.chat_ui.payment_required")),this.messages[this.messages.length-1].content=i,this.messages[this.messages.length-1].timestamp=Date.now(),te.create({message:i,color:"negative",icon:"error"})}}finally{this.isLoading=!1,this.isStreaming=!1}}},cancel(){var o;(o=this.abortController)==null||o.abort(),this.isLoading=!1,this.messages[this.messages.length-1].role==="assistant"&&this.messages.pop()}}}),Ee=E({__name:"InputComponent",props:{maximizedWindow:{type:Boolean,default:!1},query:{type:String,default:""}},setup(a,{expose:o}){const{t:s}=D({useScope:"global"}),e=K(),g=Q(),i=Q(""),t=G(),{isLoading:n,messages:C}=U(t),x=J(),d=F(),{user:_}=U(d),p=a,f=k(()=>!(typeof u(i.value)=="string"||n.value)),v=()=>{f.value&&(t.send(i.value,x.apiKey,"jina-deepsearch-v1"),b())},h=()=>{n.value=!1,t.cancel()},q=()=>{e.dialog({title:s("deepsearch.chat_ui.clear_context_title"),message:s("deepsearch.chat_ui.clear_context_message"),cancel:!0}).onOk(()=>{C.value=[]})},u=L=>L.trim().length===0?s("deepsearch.chat_ui.input_cant_be_empty"):!0,b=()=>{i.value=""};o({reset:b}),se(()=>{p.query&&(i.value=p.query)});const S={t:s,$q:e,form:g,inputMessage:i,chatStore:t,isLoading:n,messages:C,embeddingStore:x,userStore:d,user:_,props:p,sendable:f,onSubmit:v,onCancel:h,onClear:q,validateInput:u,reset:b,get QForm(){return Te},get handleShiftEnter(){return Ue}};return Object.defineProperty(S,"__isScriptSetup",{enumerable:!1,value:!0}),S}});function De(a,o,s,e,g,i){return r(),m(e.QForm,{ref:"form",class:"full-width",onSubmit:re(e.onSubmit,["prevent"])},{default:l(()=>[c(ne,{class:"full-height q-mb-xs",modelValue:e.inputMessage,"onUpdate:modelValue":[o[1]||(o[1]=t=>e.inputMessage=t),t=>{}],filled:"",autofocus:"",square:"",autogrow:"","hide-bottom-space":"","lazy-rules":"ondemand",rules:[e.validateInput],onKeydown:o[2]||(o[2]=t=>e.handleShiftEnter(t,()=>{var n;return(n=e.form)==null?void 0:n.submit(t)})),ref:"inputAnchor","input-style":"max-height: 50vh;",placeholder:e.t("deepsearch.chat_ui.input_placeholder")},oe({prepend:l(()=>[c(T,{flat:"",round:"",icon:"add_comment",disable:e.isLoading||!e.messages.length,onClick:e.onClear},{default:l(()=>[c(Qe,null,{default:l(()=>[H(R(e.t("deepsearch.chat_ui.new_chat")),1)]),_:1})]),_:1},8,["disable"])]),append:l(()=>[e.isLoading?(r(),m(T,{key:0,flat:"",round:"",icon:"o_stop_circle",color:"negative",onClick:e.onCancel})):(r(),m(T,{key:1,flat:"",round:"",icon:"send",color:e.sendable?"primary":"grey",disable:!e.sendable||e.isLoading,onClick:o[0]||(o[0]=t=>{var n;return(n=e.form)==null?void 0:n.submit(t)})},null,8,["color","disable"]))]),_:2},[s.maximizedWindow?void 0:{name:"before",fn:l(()=>{var t;return[(t=e.user)!=null&&t.photoURL?(r(),m(B,{key:0,size:"md",round:"",class:"bordered-avatar q-ml-md"},{default:l(()=>[c(N,{src:e.user.photoURL,referrerpolicy:"no-referrer",alt:e.user.displayName||""},null,8,["src","alt"])]),_:1})):(r(),m(B,{key:1,icon:"person",size:"md",class:"bordered-avatar q-ml-md"}))]}),key:"0"}]),1032,["modelValue","rules","placeholder"])]),_:1},512)}const Ie=I(Ee,[["render",De],["__file","InputComponent.vue"]]);var Y=(a=>(a[a.TOP=0]="TOP",a[a.BOTTOM=1]="BOTTOM",a))(Y||{});const Ne=E({__name:"ChatComponent",props:{maximizedWindow:{type:Boolean,default:!1}},setup(a,{expose:o}){o();const{t:s}=D({useScope:"global"}),e=G(),{messages:g,isLoading:i}=U(e),t=Q(null),n=Q(!0),C=Q(""),x=Q(0),d=v=>{A(()=>{n.value&&(x.value=v.height,p(1))})},_=v=>{A(()=>{var u,b;const h=(u=t.value)==null?void 0:u.$el,q=h.offsetHeight+h.scrollTop-h.scrollHeight;v.direction==="up"&&((b=g.value)!=null&&b.length)&&q<-5&&(n.value=!1),v.direction==="down"&&q>=-5&&(n.value=!0)})},p=v=>{setTimeout(()=>{if(t.value&&t.value.$el){const h=v===0?0:t.value.$el.scrollHeight;t.value.$el.scrollTo({top:h,behavior:"smooth"})}},10)};ie(()=>{i.value=!1,g.value=[]}),le(async()=>{n.value=!0});const f={t:s,chatStore:e,messages:g,isLoading:i,scrollTarget:t,autoScroll:n,exampleQuery:C,virtualScrollHeight:x,onResize:d,onScroll:_,SCROLL_POSITION:Y,scrollTo:p,get QVirtualScroll(){return be},get QCardSection(){return ce},get QCard(){return de},MessageComponent:Re,InputComponent:Ie,get deepSearchFlow(){return xe},UsageHeader:Ce};return Object.defineProperty(f,"__isScriptSetup",{enumerable:!1,value:!0}),f}}),Ve={class:"column no-wrap"},Pe={class:"col-12"};function Ae(a,o,s,e,g,i){return r(),m(e.QCard,{bordered:!s.maximizedWindow,flat:"",square:"",class:"column fit relative-position no-wrap",style:{"max-height":"100vh"}},{default:l(()=>[s.maximizedWindow?(r(),w(M,{key:0},[c(e.UsageHeader,{class:"full-width","home-link":"/deepsearch","faq-link":"/deepsearch#faq","issue-link":"https://github.com/jina-ai/node-DeepResearch/issues","is-support-c-s-p":!1,"api-link":"https://github.com/jina-ai/node-DeepResearch?tab=readme-ov-file#openai-compatible-server-api"}),c(me)],64)):z("",!0),s.maximizedWindow?z("",!0):(r(),m(T,{key:1,flat:"",round:"",icon:"fullscreen",class:"absolute-top-left q-ml-md q-mt-md z-top",to:"/api-dashboard/deepsearch-chat"})),e.messages.length?(r(),m(e.QCardSection,{key:3,class:"column justify-between no-wrap q-px-lg scroll q-mb-xl",ref:"scrollTarget"},{default:l(()=>[c(pe,{onScroll:e.onScroll,debounce:300}),O("div",Ve,[c(ge,{appear:"","enter-active-class":"animated fadeIn","leave-active-class":"animated fadeOut",duration:50},{default:l(()=>[O("div",Pe,[c(e.QVirtualScroll,{items:e.messages},{default:l(({item:t,index:n})=>[c(ve,{onResize:e.onResize,debounce:300}),c(e.MessageComponent,{message:t,index:n},null,8,["message","index"])]),_:1},8,["items"])])]),_:1})])]),_:1},512)):(r(),m(e.QCardSection,{key:2,class:"full-height column justify-center"},{default:l(()=>[c(N,{src:e.deepSearchFlow,"img-style":{opacity:.1},fit:"fill",class:"col-5"},null,8,["src"]),(r(),w(M,null,ue([1,2,3],t=>c(T,{"no-caps":"",flat:"",label:e.t(`deepsearch.chat_ui.example_q${t}`),key:t,class:"text-dim q-py-md",onClick:n=>e.exampleQuery=e.t(`deepsearch.chat_ui.example_q${t}`)},null,8,["label","onClick"])),64))]),_:1})),c(he,{class:"lock-blur absolute-bottom"},{default:l(()=>[c(e.InputComponent,{maximizedWindow:s.maximizedWindow,query:e.exampleQuery},null,8,["maximizedWindow","query"])]),_:1})]),_:1},8,["bordered"])}const na=I(Ne,[["render",Ae],["__file","ChatComponent.vue"]]);export{na as C};
