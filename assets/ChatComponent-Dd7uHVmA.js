import{s as Y,m as C,p as b,ce as X,j as D,a0 as E,u as N,am as U,k as w,n as F,a2 as I,a3 as r,a4 as m,a5 as l,aa as q,ah as z,b5 as M,a6 as c,ad as P,ae as j,aq as Z,af as H,ag as R,ab as B,q as Q,aj as $,aB as ee,bS as ae,aQ as te,aU as se,aL as ne,aP as oe,W as re,ba as ie,a9 as le,a7 as ce,V as A,ap as de,ai as me,a8 as O,T as ue,bT as ge}from"./index-BZqvqV5N.js";import{Q as V}from"./QChip-BZxR-Wb2.js";import{Q as he}from"./QScrollObserver-W23JRi7F.js";import{Q as fe}from"./QResizeObserver-DJQGuGlW.js";import{i as pe}from"./date-9aJ-ZHvQ.js";import{Q as ve}from"./QSpinnerDots-BMagjLtI.js";import{Q as _e,d as be,U as ye}from"./BrowserInfoDialog-BKHtbgx4.js";import{Q as W}from"./QItemLabel-Cvon-8K8.js";import{Q as xe}from"./QExpansionItem-C_X_UAxR.js";import{T as ke}from"./QSpinnerRings-CHda6gb2.js";import{u as K}from"./use-dialog-plugin-component-BVmmavIR.js";import{P as Ce}from"./crypto-Cu9W9_Sk.js";import{Q as Se}from"./QTooltip-O5YWR2K_.js";import{a as qe}from"./finetune-BU_Jl_ds.js";const we=Y({name:"QChatMessage",props:{sent:Boolean,label:String,bgColor:String,textColor:String,name:String,avatar:String,text:Array,stamp:String,size:String,labelHtml:Boolean,nameHtml:Boolean,textHtml:Boolean,stampHtml:Boolean},setup(a,{slots:s}){const n=C(()=>a.sent===!0?"sent":"received"),e=C(()=>`q-message-text-content q-message-text-content--${n.value}`+(a.textColor!==void 0?` text-${a.textColor}`:"")),u=C(()=>`q-message-text q-message-text--${n.value}`+(a.bgColor!==void 0?` text-${a.bgColor}`:"")),i=C(()=>"q-message-container row items-end no-wrap"+(a.sent===!0?" reverse":"")),t=C(()=>a.size!==void 0?`col-${a.size}`:""),o=C(()=>({msg:a.textHtml===!0?"innerHTML":"textContent",stamp:a.stampHtml===!0?"innerHTML":"textContent",name:a.nameHtml===!0?"innerHTML":"textContent",label:a.labelHtml===!0?"innerHTML":"textContent"}));function S(d){return s.stamp!==void 0?[d,b("div",{class:"q-message-stamp"},s.stamp())]:a.stamp?[d,b("div",{class:"q-message-stamp",[o.value.stamp]:a.stamp})]:[d]}function x(d,_){const h=_===!0?d.length>1?g=>g:g=>b("div",[g]):g=>b("div",{[o.value.msg]:g});return d.map((g,p)=>b("div",{key:p,class:u.value},[b("div",{class:e.value},S(h(g)))]))}return()=>{const d=[];s.avatar!==void 0?d.push(s.avatar()):a.avatar!==void 0&&d.push(b("img",{class:`q-message-avatar q-message-avatar--${n.value}`,src:a.avatar,"aria-hidden":"true"}));const _=[];s.name!==void 0?_.push(b("div",{class:`q-message-name q-message-name--${n.value}`},s.name())):a.name!==void 0&&_.push(b("div",{class:`q-message-name q-message-name--${n.value}`,[o.value.name]:a.name})),s.default!==void 0?_.push(x(X(s.default()),!0)):a.text!==void 0&&_.push(x(a.text)),d.push(b("div",{class:t.value},_));const h=[];return s.label!==void 0?h.push(b("div",{class:"q-message-label"},s.label())):a.label!==void 0&&h.push(b("div",{class:"q-message-label",[o.value.label]:a.label})),h.push(b("div",{class:i.value},d)),b("div",{class:`q-message q-message-${n.value}`},h)}}}),Qe=D({__name:"MessageComponent",props:{message:{},width:{},index:{},disabled:{type:Boolean}},setup(a,{expose:s}){s();const n=a,e=F(),{t:u}=E(),i=N(),{user:t}=U(i),o=K(),S=w(!1),x=C(()=>n.message.role==="user"),d=C(()=>n.message.role==="assistant"),_=C(()=>{const f=n.message.content,y="<think>",k="</think>";if(f.includes(y))if(f.includes(k)){const L=/<think>(.*?)<\/think>/s,T=f.match(L);if(T)return T[1]}else return f.substring(f.indexOf(y)+y.length);return""}),h=C(()=>n.message.content.includes("<think>")&&!n.message.content.includes("</think>")),g=C(()=>{const f=n.message.content;let y="";const k="</think>";return f.includes(k)?y=f.substring(f.indexOf(k)+k.length):f.includes("<think>")||(y=f),y.replace(/<references>|<\/references>/g,"")}),v={props:n,$q:e,t:u,userStore:i,user:t,embeddingStore:o,isLoading:S,isUserRole:x,isAssistantRole:d,think:_,isThinking:h,answer:g,onPurchase:()=>{e.dialog({component:Ce,componentProps:{purchaseKey:o.apiKey}})},TypingText:ke};return Object.defineProperty(v,"__isScriptSetup",{enumerable:!1,value:!0}),v}}),Te={key:0},ze={key:1,class:"relative-position"};function Me(a,s,n,e,u,i){return r(),m(we,{class:$(["q-pa-md q-pb-lg relative-position message",e.isUserRole?"user-message":"assistant-message"]),sent:e.isUserRole,"text-color":"white"},{avatar:l(()=>{var t;return[e.isUserRole?(r(),q(z,{key:0},[(t=e.user)!=null&&t.photoURL?(r(),m(M,{key:0,size:"md",round:"",class:"bordered-avatar q-ml-md"},{default:l(()=>[c(V,{src:e.user.photoURL,referrerpolicy:"no-referrer",alt:e.user.displayName||""},null,8,["src","alt"])]),_:1})):(r(),m(M,{key:1,icon:"person",size:"md",class:"bordered-avatar q-ml-md"}))],64)):(r(),m(M,{key:1,icon:"img:/J.svg",class:"bordered-avatar q-mr-md bg-mixed-200",size:"md"}))]}),default:l(()=>[e.isUserRole?(r(),q("div",Te,[c(e.TypingText,{text:n.message.content,dark:e.isAssistantRole},null,8,["text","dark"])])):(r(),q("div",ze,[n.message.content.length?(r(),q(z,{key:1},[e.isLoading||!e.isLoading&&n.message.content.includes("<think>")?(r(),m(xe,{key:0,class:"full-width","expand-separator":"","model-value":e.isThinking,"header-class":"bg-mixed-200 text-black"},{header:l(()=>[c(P,{class:"full-width",dense:""},{default:l(()=>[c(j,{side:""},{default:l(()=>[e.isThinking?(r(),m(_e,{key:0})):(r(),m(Z,{key:1,name:"task_alt"}))]),_:1}),c(j,null,{default:l(()=>[e.isThinking?(r(),m(W,{key:0},{default:l(()=>[H(R(e.t("deepsearch.chat_ui.thinking")),1)]),_:1})):(r(),m(W,{key:1},{default:l(()=>[H(R(e.t("deepsearch.chat_ui.thinking_done")),1)]),_:1}))]),_:1})]),_:1})]),default:l(()=>[c(P,{class:"q-pa-lg"},{default:l(()=>[c(j,{class:"text-dim",style:{"font-family":"monospace"}},{default:l(()=>[H(R(e.think),1)]),_:1})]),_:1})]),_:1},8,["model-value"])):B("",!0),e.answer?(r(),m(e.TypingText,{key:1,text:e.answer,loading:e.isLoading,"content-class":"q-ma-md"},null,8,["text","loading","content-class"])):B("",!0),n.message.statusCode===402?(r(),q(z,{key:2},[c(Q,{color:"primary",square:"",outline:"",label:e.t("deepsearch.chat_ui.purchase"),onClick:e.onPurchase,icon:"shopping_cart",class:"q-ma-sm"},null,8,["label"]),c(Q,{color:"white",square:"",outline:"",label:e.t("deepsearch.chat_ui.keyman"),to:"/api-dashboard/key-manager",icon:"key",class:"q-ma-sm"},null,8,["label"])],64)):B("",!0)],64)):(r(),m(ve,{key:0,size:"md",class:"q-ma-md"}))]))]),_:1},8,["class","sent"])}const Be=I(Qe,[["render",Me],["__file","MessageComponent.vue"]]),Le=(a,s)=>{if(a.shiftKey&&a.key==="Enter")return 13;a.key==="Enter"&&(a.preventDefault(),s())},He="https://deepsearch.jina.ai",J=ee("chatStore",{state:()=>({messages:[],response:[],isLoading:!1,isStreaming:!1,abortController:void 0}),getters:{usage:a=>{var s;return(s=a.response[a.response.length-1])==null?void 0:s.usage}},actions:{async send(a,s,n){var e;if(!this.isLoading){this.abortController=new AbortController,this.isLoading=!0;try{this.messages.push({role:"user",content:a,timestamp:Date.now()});const u={model:n,messages:this.messages.concat().filter(o=>!o.statusCode||o.statusCode===200),stream:!0};this.messages.push({role:"assistant",content:"",timestamp:Date.now()});const i=await fetch(`${He}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify(u),signal:this.abortController.signal}),t=this.messages[this.messages.length-1];if(t.statusCode=i.status,t.timestamp=Date.now(),(e=i.headers.get("content-type"))!=null&&e.includes("text/event-stream")){if(i.body){const o=i.body.getReader(),S=new TextDecoder;for(;;){const{done:x,value:d}=await o.read();if(x){this.isLoading=!1,this.isStreaming=!1;break}d&&(this.isStreaming=!0,S.decode(d).split(`

`).filter(Boolean).forEach(g=>{const p=g.replace(/data: /,"").replace(/\n/g,"\\\\n");console.log("Data:",p);try{if(p){const v=JSON.parse(p);this.response.push(v),t.content+=v.choices[0].delta.content}}catch(v){console.error("Error:",v)}}))}}}else{const o=await i.json();o&&(this.response=[o],this.messages.push(o.choices[0].message))}}catch(u){if(u.name!=="AbortError"){let i=u instanceof Error?u.message:String(u);this.messages[this.messages.length-1].statusCode===402&&(i=this.t("deepsearch.chat_ui.payment_required")),this.messages[this.messages.length-1].content=i,this.messages[this.messages.length-1].timestamp=Date.now(),ae.create({message:i,color:"negative",icon:"error"})}}finally{this.isLoading=!1,this.isStreaming=!1}}},cancel(){var s;(s=this.abortController)==null||s.abort(),this.isLoading=!1,this.messages[this.messages.length-1].role==="assistant"&&this.messages.pop()}}}),Re=D({__name:"InputComponent",props:{maximizedWindow:{type:Boolean,default:!1},query:{type:String,default:""}},setup(a,{expose:s}){const{t:n}=E({useScope:"global"}),e=F(),u=w(),i=w(""),t=J(),{isLoading:o,messages:S}=U(t),x=K(),d=N(),{user:_}=U(d),h=a,g=C(()=>!(typeof y(i.value)=="string"||o.value)),p=()=>{g.value&&(t.send(i.value,x.apiKey,"jina-deepsearch-v1"),k())},v=()=>{o.value=!1,t.cancel()},f=()=>{e.dialog({title:n("deepsearch.chat_ui.clear_context_title"),message:n("deepsearch.chat_ui.clear_context_message"),cancel:!0}).onOk(()=>{S.value=[]})},y=T=>T.trim().length===0?n("deepsearch.chat_ui.input_cant_be_empty"):!0,k=()=>{i.value=""};s({reset:k}),te(()=>{h.query&&(i.value=h.query)});const L={t:n,$q:e,form:u,inputMessage:i,chatStore:t,isLoading:o,messages:S,embeddingStore:x,userStore:d,user:_,props:h,sendable:g,onSubmit:p,onCancel:v,onClear:f,validateInput:y,reset:k,get QForm(){return qe},get handleShiftEnter(){return Le}};return Object.defineProperty(L,"__isScriptSetup",{enumerable:!1,value:!0}),L}});function Ue(a,s,n,e,u,i){return r(),m(e.QForm,{ref:"form",class:"full-width",onSubmit:oe(e.onSubmit,["prevent"])},{default:l(()=>[c(se,{class:"full-height q-mb-xs",modelValue:e.inputMessage,"onUpdate:modelValue":[s[1]||(s[1]=t=>e.inputMessage=t),t=>{}],filled:"",autofocus:"",square:"",autogrow:"","hide-bottom-space":"","lazy-rules":"ondemand",rules:[e.validateInput],onKeydown:s[2]||(s[2]=t=>e.handleShiftEnter(t,()=>{var o;return(o=e.form)==null?void 0:o.submit(t)})),ref:"inputAnchor","input-style":"max-height: 50vh;",placeholder:e.t("deepsearch.chat_ui.input_placeholder")},ne({prepend:l(()=>[c(Q,{flat:"",round:"",icon:"add_comment",disable:e.isLoading||!e.messages.length,onClick:e.onClear},{default:l(()=>[c(Se,null,{default:l(()=>[H(R(e.t("deepsearch.chat_ui.new_chat")),1)]),_:1})]),_:1},8,["disable"])]),append:l(()=>[e.isLoading?(r(),m(Q,{key:0,flat:"",round:"",icon:"o_stop_circle",color:"negative",onClick:e.onCancel})):(r(),m(Q,{key:1,flat:"",round:"",icon:"send",color:e.sendable?"primary":"grey",disable:!e.sendable||e.isLoading,onClick:s[0]||(s[0]=t=>{var o;return(o=e.form)==null?void 0:o.submit(t)})},null,8,["color","disable"]))]),_:2},[n.maximizedWindow?void 0:{name:"before",fn:l(()=>{var t;return[(t=e.user)!=null&&t.photoURL?(r(),m(M,{key:0,size:"md",round:"",class:"bordered-avatar q-ml-md"},{default:l(()=>[c(V,{src:e.user.photoURL,referrerpolicy:"no-referrer",alt:e.user.displayName||""},null,8,["src","alt"])]),_:1})):(r(),m(M,{key:1,icon:"person",size:"md",class:"bordered-avatar q-ml-md"}))]}),key:"0"}]),1032,["modelValue","rules","placeholder"])]),_:1},512)}const je=I(Re,[["render",Ue],["__file","InputComponent.vue"]]);var G=(a=>(a[a.TOP=0]="TOP",a[a.BOTTOM=1]="BOTTOM",a))(G||{});const De=D({__name:"ChatComponent",props:{maximizedWindow:{type:Boolean,default:!1}},setup(a,{expose:s}){s();const{t:n}=E({useScope:"global"}),e=J(),{messages:u,isLoading:i}=U(e),t=w(null),o=w(!0),S=w(""),x=w(0),d=p=>{A(()=>{o.value&&(x.value=p.height,h(1))})},_=p=>{A(()=>{var y,k;const v=(y=t.value)==null?void 0:y.$el,f=v.offsetHeight+v.scrollTop-v.scrollHeight;p.direction==="up"&&((k=u.value)!=null&&k.length)&&f<-5&&(o.value=!1),p.direction==="down"&&f>=-5&&(o.value=!0)})},h=p=>{setTimeout(()=>{if(t.value&&t.value.$el){const v=p===0?0:t.value.$el.scrollHeight;t.value.$el.scrollTo({top:v,behavior:"smooth"})}},10)};re(()=>{i.value=!1,u.value=[]}),ie(async()=>{o.value=!0});const g={t:n,chatStore:e,messages:u,isLoading:i,scrollTarget:t,autoScroll:o,exampleQuery:S,virtualScrollHeight:x,onResize:d,onScroll:_,SCROLL_POSITION:G,scrollTo:h,get QVirtualScroll(){return pe},get QCardSection(){return le},get QCard(){return ce},MessageComponent:Be,InputComponent:je,get deepSearchFlow(){return be},UsageHeader:ye};return Object.defineProperty(g,"__isScriptSetup",{enumerable:!1,value:!0}),g}}),Ee={class:"column no-wrap"},Ie={class:"col-12"};function Ve(a,s,n,e,u,i){return r(),m(e.QCard,{bordered:!n.maximizedWindow,flat:"",square:"",class:"column fit relative-position no-wrap",style:{"max-height":"100vh"}},{default:l(()=>[n.maximizedWindow?(r(),q(z,{key:0},[c(e.UsageHeader,{class:"full-width","home-link":"/deepsearch","faq-link":"/deepsearch#faq","issue-link":"https://github.com/jina-ai/node-DeepResearch/issues","is-support-c-s-p":!1,"api-link":"https://github.com/jina-ai/node-DeepResearch?tab=readme-ov-file#openai-compatible-server-api"}),c(de)],64)):B("",!0),n.maximizedWindow?B("",!0):(r(),m(Q,{key:1,flat:"",round:"",icon:"fullscreen",class:"absolute-top-left q-ml-md q-mt-md z-top",to:"/api-dashboard/deepsearch-chat"})),e.messages.length?(r(),m(e.QCardSection,{key:3,class:"column justify-between no-wrap q-px-lg scroll q-mb-xl",ref:"scrollTarget"},{default:l(()=>[c(he,{onScroll:e.onScroll,debounce:300}),O("div",Ee,[c(ue,{appear:"","enter-active-class":"animated fadeIn","leave-active-class":"animated fadeOut",duration:50},{default:l(()=>[O("div",Ie,[c(e.QVirtualScroll,{items:e.messages},{default:l(({item:t,index:o})=>[c(fe,{onResize:e.onResize,debounce:300}),c(e.MessageComponent,{message:t,index:o},null,8,["message","index"])]),_:1},8,["items"])])]),_:1})])]),_:1},512)):(r(),m(e.QCardSection,{key:2,class:"full-height column justify-center"},{default:l(()=>[c(V,{src:e.deepSearchFlow,"img-style":{opacity:.1},fit:"fill",class:"col-5"},null,8,["src"]),(r(),q(z,null,me([1,2,3],t=>c(Q,{"no-caps":"",flat:"",label:e.t(`deepsearch.chat_ui.example_q${t}`),key:t,class:"text-dim q-py-md",onClick:o=>e.exampleQuery=e.t(`deepsearch.chat_ui.example_q${t}`)},null,8,["label","onClick"])),64))]),_:1})),c(ge,{class:"lock-blur absolute-bottom"},{default:l(()=>[c(e.InputComponent,{maximizedWindow:n.maximizedWindow,query:e.exampleQuery},null,8,["maximizedWindow","query"])]),_:1})]),_:1},8,["bordered"])}const aa=I(De,[["render",Ve],["__file","ChatComponent.vue"]]);export{aa as C};
