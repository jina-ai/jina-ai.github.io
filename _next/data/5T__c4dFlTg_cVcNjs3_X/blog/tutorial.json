{"pageProps":{"post":{"title":"Tutorial: A Walkthrough of Hello World Chatbot","date":"2021-06-28","slug":"tutorial","author":"Susana Guzman","content":"<p>We will use the <a href=\"https://github.com/jina-ai/jina#run-quick-demo\">hello world chatbot</a> for this tutorial. You can find the complete code <a href=\"https://github.com/jina-ai/jina/tree/master/jina/helloworld/chatbot\">here</a> and we will go step by step.</p>\n<p>At the end of this tutorial, you will have your own chatbot. You will use text as an input and get a text result as output. For this example, we will use a <a href=\"https://www.kaggle.com/xhlulu/covidqa\">covid dataset</a>. You will understand how every part of this example works and how you can create new apps with different datasets on your own.</p>\n<h2>Set-up &#x26; overview</h2>\n<p>We recommend creating a <a href=\"https://docs.python.org/3/tutorial/venv.html\">new python virtual environment</a>, to have a clean install of Jina and prevent dependency clashing.</p>\n<p>We can start by installing Jina:</p>\n<pre><code class=\"language-bash\">pip install jina\n</code></pre>\n<p>For more information on installing Jina, refer to this <a href=\"https://github.com/jina-ai/jina#install\">page</a>.</p>\n<p>And we need the following dependencies:</p>\n<pre><code class=\"language-bash\">pip install click==7.1.2\npip install transformers==4.1.1\npip install torch==1.7.1\n</code></pre>\n<p>Once you have Jina and the dependencies installed, let's get a broad overview of the process we'll follow:</p>\n<p><img src=\"/assets/images/blog/tutorials/flow.png\" alt=\"image\"></p>\n<p>You see from this image that you have your data at the beginning of this Flow process, and this can be any data type:</p>\n<ul>\n<li>Text</li>\n<li>Images</li>\n<li>Audio</li>\n<li>Video</li>\n<li>Or any other type</li>\n</ul>\n<p>In this case, we are using text, but it can be whatever data type you want.</p>\n<p>Because our use case is very simple we don't need to process this data any further, and we can move straight on and encode our data into vectors then finally store those vectors, so they are ready for indexing and querying.</p>\n<p>Note: If you have a different use case or dataset you may need to process your data somehow (this is a very common task in machine learning)</p>\n<h2>Tutorial</h2>\n<h3>Define data and work directories</h3>\n<p>We can start creating an empty folder, I'll call mine <code>tutorial</code> and that's the name you'll see through the tutorial but feel free to use whatever you wish.</p>\n<p>We will display our results in our browser, so download the static folder from <a href=\"https://github.com/jina-ai/jina/tree/master/jina/helloworld/chatbot/static\">here</a>, and paste it into your tutorial folder. This is only the CSS and HTML files to render our results. We will use a dataset in a <code>.csv</code> format. I'll use the <a href=\"https://www.kaggle.com/xhlulu/covidqa\">COVID</a> dataset from Kaggle. You don't need to download this by hand, we'll do it later in our app.</p>\n<h3>Create a Flow</h3>\n<p>The very first concept you'll see in Jina is a Flow. You can see <a href=\"https://github.com/jina-ai/jina/blob/master/.github/2.0/cookbooks/Flow.md\">here</a> a more formal introduction of what it is, but for now, think of the Flow as a manager in Jina, it takes care of the all the tasks that will run on your application and each Flow object will take care of one real-world task.</p>\n<p>To create a Flow you only need to import it from Jina. So open your favorite IDE, create a <code>app.py</code> file and let's start writing our code:</p>\n<pre><code class=\"language-python\">from jina import Flow\nflow = Flow()\n</code></pre>\n<p>But this is an empty Flow. Since we want to encode our data and then index it, we need to add elements to it. The only things we add to a Flow are Executors. We will talk about them more formally later, but think of them as the elements that will do all the data processing you want.</p>\n<h3>Add elements to a Flow</h3>\n<p>To add elements to your Flow you just need to use the <code>.add()</code> method. You can add as many pods as you wish.</p>\n<pre><code class=\"language-python\">from jina import Flow\nflow = Flow().add().add()\n</code></pre>\n<p>And for our example, we need to add two <code>Executors</code>:</p>\n<ol>\n<li>A transformer (to encode our data)</li>\n<li>An indexer</li>\n</ol>\n<p>So add the following to our code:</p>\n<pre><code class=\"language-python\">from jina import Flow\nflow = (\n        Flow()\n        .add(uses=MyTransformer)\n        .add(uses=MyIndexer)\n    )\n</code></pre>\n<p>Right now we haven't defined <code>MyTransformer</code> or <code>MyIndexer</code>. Let's create some dummy Executors so we can try our app. These will not be our final Executors but just something basic to learn first.</p>\n<h3>Create dummy Executors</h3>\n<p>Now we have a Flow with two Executors. Write the following in your code:</p>\n<pre><code class=\"language-python\">from jina import Jina, Executor, requests\n\nclass MyTransformer(Executor):\n    @requests(on='/foo')\n    def foo(self, **kwargs):\n        print(f'foo is doing cool stuff: {kwargs}')\n\nclass MyIndexer(Executor):\n    @requests(on='/bar')\n    def bar(self, **kwargs):\n        print(f'bar is doing cool stuff: {kwargs}')\n</code></pre>\n<p>We will have more complex Executors later. For now our two Executors are only printing a line.</p>\n<p>So far it's a simple Flow but it is still useful to visualize it to make sure we have what we want.</p>\n<h3>Visualize a Flow</h3>\n<p>By now, your code should look like this:</p>\n<pre><code class=\"language-python\">from jina import Flow, Document, Executor, requests\n\nclass MyTransformer(Executor):\n    @requests(on='/foo')\n    def foo(self, **kwargs):\n        print(f'foo is doing cool stuff: {kwargs}')\n\nclass MyIndexer(Executor):\n    @requests(on='/bar')\n    def bar(self, **kwargs):\n        print(f'bar is doing cool stuff: {kwargs}')\n\nflow = (\n        Flow()\n        .add(uses=MyTransformer)\n        .add(uses=MyIndexer)\n    )\n\n</code></pre>\n<p>If you want to visualize your Flow you can do that with <code>plot</code>. So add the <code>.plot()</code> function at the end of your Flow</p>\n<pre><code class=\"language-python\">from jina import Flow\n\nflow = (\n        Flow()\n        .add(uses=MyTransformer)\n        .add(uses=MyIndexer)\n        .plot('our_flow.svg')\n    )\n</code></pre>\n<p>Let's run the code we have so far. If you try it, not much will happen since we are not indexing anything yet, but you will see the new file <code>our_flow.svg</code> created on your working folder, and if you open it you would see this:</p>\n<p><img src=\"/assets/images/blog/tutorials/plot_flow1.png\" alt=\"image\"></p>\n<p>You can see a Flow with two Executors, but what if you have many Executors? this can quickly become very messy, so it is better to name the Executors with <code>name='CoolName'</code>. So in our example, we use:</p>\n<pre><code class=\"language-python\">from jina import Flow\n\nflow = (\n        Flow()\n        .add(name='MyTransformer', uses=MyTransformer)\n        .add(name='MyIndexer', uses=MyIndexer)\n        .plot('our_flow.svg')\n    )\n</code></pre>\n<p>Now if you run this, you should have a Flow that is more explicit:</p>\n<p><img src=\"/assets/images/blog/tutorials/plot_flow2.png\" alt=\"image\"></p>\n<h3>Use a Flow</h3>\n<p>Ok, we have our Flow created and visualized. Let's put it to use now. The correct way to use a Flow is to open it as a context manager, using the with keyword:</p>\n<pre><code class=\"language-python\">with flow:\n    ...\n</code></pre>\n<p>Before we use it in our example, let's recap a bit of what we have seen:</p>\n<pre><code class=\"language-python\">from jina import Flow\nflow = Flow()          # Create Flow\n\nflow.add().add()       # Add elements to Flow\nflow.plot()            # Visualize a Flow\n\nwith flow:             # Use Flow as a context manager\n    flow.index()\n</code></pre>\n<p>In our example, we have a Flow with two Executors (<code>MyTransformer</code> and <code>MyIndexer</code>) and we want to use our Flow to index our data. But in this case, our data is a csv file. We need to open it first.</p>\n<pre><code class=\"language-python\">with flow, open('our_dataset.csv') as fp:\n        flow.index()\n</code></pre>\n<p>Now we have our Flow ready, we can start to index. But we can't just pass the dataset in the original format to our Flow. We need to create a Document with the data we want to use.</p>\n<h3>To create a Document</h3>\n<p>To create a Document in Jina, we do it like this:</p>\n<pre><code class=\"language-python\">from jina import Document\ndoc = Document(content='hello, world!')\n</code></pre>\n<p>In our case, the content of our Document needs to be the dataset we want to use:</p>\n<pre><code class=\"language-python\">from jina import Document\ndoc = Document.from_csv(fp, field_resolver={'question': 'text'})\n</code></pre>\n<p>So what happened there? We created a Document <code>doc</code>, and we use <code>from_csv</code> to load our dataset. We use <code>field_resolver</code> to map the text from our dataset to the Document attributes.</p>\n<h3>Get our data</h3>\n<p>We have everything ready to use our Flow, but so far we have been using dummy data. Let's download our dataset now. Copy and paste this snippet, we don't need to go into the details for this. What it does is to download the <a href=\"https://www.kaggle.com/xhlulu/covidqa\">covid dataset</a>.</p>\n<pre><code class=\"language-python\">def download_data(targets, download_proxy=None, task_name='download covid-dataset'):\n\n\"\"\"\nDownload data.\n\n:param targets: target path for data.\n:param download_proxy: download proxy (e.g. 'http', 'https')\n:param task_name: name of the task\n\"\"\"\nopener = urllib.request.build_opener()\nopener.addheaders = [('User-agent', 'Mozilla/5.0')]\nif download_proxy:\n    proxy = urllib.request.ProxyHandler(\n        {'http': download_proxy, 'https': download_proxy}\n    )\n    opener.add_handler(proxy)\nurllib.request.install_opener(opener)\nwith ProgressBar(task_name=task_name, batch_unit='') as t:\n    for key, value in targets.items():\n        if not os.path.exists(value['filename']):\n            urllib.request.urlretrieve(\n                value['url'], value['filename'], reporthook=lambda *x: t.update_tick(0.01)\n            )\n</code></pre>\n<p>Let's re-organize our code a little bit. First, we should import everything we need:</p>\n<pre><code class=\"language-python\">import os\nimport urllib.request\nimport webbrowser\nfrom pathlib import Path\n\nfrom jina import Flow, Executor\nfrom jina.logging import default_logger\nfrom jina.logging.profile import ProgressBar\nfrom jina.parsers.helloworld import set_hw_chatbot_parser\nfrom jina.types.document.generators import from_csv\n</code></pre>\n<p>Then we should have our <code>main</code>, a <code>download_data</code> function and a <code>tutorial</code> function</p>\n<pre><code class=\"language-python\">def download_data(targets, download_proxy=None, task_name='download covid-dataset'):\n    # This is exactly as the previous snippet we just saw\n\ndef tutorial(args):\n    # Here we will have everything for our tutorial\n\nif __name__ == '__main__':\n    args = set_hw_chatbot_parser().parse_args()\n    tutorial(args)\n</code></pre>\n<p>Now let's see our tutorial function with all the code we've done so far:</p>\n<pre><code class=\"language-python\">def tutorial(args):\n    Path(args.workdir).mkdir(parents=True, exist_ok=True)\n\n    class MyTransformer(Executor):\n        @requests(on='/foo')\n        def foo(self, **kwargs):\n            print(f'foo is doing cool stuff: {kwargs}')\n\n    class MyIndexer(Executor):\n        @requests(on='/bar')\n        def bar(self, **kwargs):\n            print(f'bar is doing cool stuff: {kwargs}')\n\n    targets = {\n        'covid-csv': {\n            'url': args.index_data_url,\n            'filename': os.path.join(args.workdir, 'dataset.csv'),\n        }\n    }\n\n    # download the data\n    download_data(targets, args.download_proxy, task_name='download covid-dataset')\n\n    flow = (\n        Flow()\n            .add(name='MyTransformer', uses=MyTransformer)\n            .add(name='MyIndexer', uses=MyIndexer)\n            .plot('test.svg')\n    )\n\n    with flow, open(targets['covid-csv']['filename']) as fp:\n        flow.index(from_csv(fp, field_resolver={'question': 'text'}))\n</code></pre>\n<p>If you run this, it should finish without errors. You won't see much yet because we are not showing anything after we index. But you should see a new directory created with the downloaded dataset:</p>\n<p><img src=\"/assets/images/blog/tutorials/downloaded_dataset.png\" alt=\"image\"></p>\n<p>To actually see something we need to specify how we will display it. For our tutorial we will do so in our browser. Add the following after indexing:</p>\n<pre><code class=\"language-python\">flow.use_rest_gateway(args.port_expose)\n\nurl_html_path = 'file://' + os.path.abspath(\n    os.path.join(\n        os.path.dirname(os.path.realpath(__file__)), 'static/index.html'\n    )\n)\ntry:\n    webbrowser.open(url_html_path, new=2)\nexcept:\n    pass  # intentional pass, browser support isn't cross-platform\nfinally:\n    default_logger.success(\n        f'You should see a demo page opened in your browser, '\n        f'if not, you may open {url_html_path} manually'\n    )\n\nif not args.unblock_query_flow:\n    flow.block()\n</code></pre>\n<p>For more information on what the Flow is doing, specially in <code>f.use_rest_gateway(args.port_expose)</code> and <code>f.block()</code> check our <a href=\"https://github.com/jina-ai/jina/blob/master/.github/2.0/cookbooks/Flow.md\">cookbook</a></p>\n<p>Ok, so it seems that we have plenty of work done already. If you run this you will see a new tab open in your browser, and there you will have a text box ready for you to input some text. However, if you try to enter anything you won't get any results. This is because we are using dummy Executors. Our <code>MyTransformer</code> and <code>MyIndexer</code> aren't actually doing anything. So far they only print a line when they are called. So we need real Executors.</p>\n<p>This has been plenty of new information you've learned so far, so we won't go deep into Executors today. Instead you can copy-paste the ones we are using for <a href=\"https://github.com/jina-ai/jina/blob/master/jina/helloworld/chatbot/my_executors.py\">this example</a>, save that <code>executors.py</code> file in the same directory where the rest of your code is. The important part to understand is that all Executors' behavior is defined in <code>executors.py</code></p>\n<p>To try the Executors from the Github repo, just add this before the <code>download_data</code> function:</p>\n<pre><code class=\"language-python\">if __name__ == '__main__':\n    from executors import MyTransformer, MyIndexer\nelse:\n    from .executors import MyTransformer, MyIndexer\n</code></pre>\n<p>And remove the dummy executors we made. Your <code>app.py</code> should now look like this:</p>\n<pre><code class=\"language-python\">\nimport os\nimport urllib.request\nimport webbrowser\nfrom pathlib import Path\n\nfrom jina import Flow, Executor\nfrom jina.logging import default_logger\nfrom jina.logging.profile import ProgressBar\nfrom jina.parsers.helloworld import set_hw_chatbot_parser\nfrom jina.types.document.generators import from_csv\n\nif __name__ == '__main__':\n    from executors import MyTransformer, MyIndexer\nelse:\n    from .executors import MyTransformer, MyIndexer\n\n\ndef download_data(targets, download_proxy=None, task_name='download fashion-mnist'):\n    \"\"\"\n    Download data.\n\n    :param targets: target path for data.\n    :param download_proxy: download proxy (e.g. 'http', 'https')\n    :param task_name: name of the task\n    \"\"\"\n    opener = urllib.request.build_opener()\n    opener.addheaders = [('User-agent', 'Mozilla/5.0')]\n    if download_proxy:\n        proxy = urllib.request.ProxyHandler(\n            {'http': download_proxy, 'https': download_proxy}\n        )\n        opener.add_handler(proxy)\n    urllib.request.install_opener(opener)\n    with ProgressBar(task_name=task_name, batch_unit='') as t:\n        for k, v in targets.items():\n            if not os.path.exists(v['filename']):\n                urllib.request.urlretrieve(\n                    v['url'], v['filename'], reporthook=lambda *x: t.update_tick(0.01)\n                )\n\ndef tutorial(args):\n\n    Path(args.workdir).mkdir(parents=True, exist_ok=True)\n\n    '''\n    Comment this to use the exectors you have in `executors.py`\n    class MyTransformer(Executor):\n        def foo(self, **kwargs):\n            print(f'foo is doing cool stuff: {kwargs}')\n\n    class MyIndexer(Executor):\n        def bar(self, **kwargs):\n            print(f'bar is doing cool stuff: {kwargs}')\n    '''\n\n    targets = {\n        'covid-csv': {\n            'url': args.index_data_url,\n            'filename': os.path.join(args.workdir, 'dataset.csv'),\n        }\n    }\n\n    # download the data\n    download_data(targets, args.download_proxy, task_name='download covid-dataset')\n\n    f = (\n        Flow()\n            .add(name='MyTransformer', uses=MyTransformer)\n            .add(name='MyIndexer', uses=MyIndexer)\n            .plot('test.svg')\n    )\n\n    with f, open(targets['covid-csv']['filename']) as fp:\n        f.index(from_csv(fp, field_resolver={'question': 'text'}))\n\n        # switch to REST gateway at runtime\n        f.use_rest_gateway(args.port_expose)\n\n        url_html_path = 'file://' + os.path.abspath(\n            os.path.join(\n                os.path.dirname(os.path.realpath(__file__)), 'static/index.html'\n            )\n        )\n        try:\n            webbrowser.open(url_html_path, new=2)\n        except:\n            pass  # intentional pass, browser support isn't cross-platform\n        finally:\n            default_logger.success(\n                f'You should see a demo page opened in your browser, '\n                f'if not, you may open {url_html_path} manually'\n            )\n\n        if not args.unblock_query_flow:\n            f.block()\n\nif __name__ == '__main__':\n    args = set_hw_chatbot_parser().parse_args()\n    tutorial(args)\n</code></pre>\n<p>And your directory should be:</p>\n<pre><code>.\n├── project                    \n│   ├── app.py          \n│   ├── executors.py         \n│   └── static/         \n│   └── our_flow.svg #This will be here if you used the .plot() function       \n└── ...\n</code></pre>\n<p>And we are done! If you followed all the steps, now you should have something like this in your browser:</p>\n<p><img src=\"/assets/images/blog/tutorials/results.png\" alt=\"image\"></p>\n<p>There are still a lot of concepts to learn. So stay tuned for our next tutorials.</p>\n<p>If you have any issues following this tutorial, you can always get support from our <a href=\"https://slack.jina.ai/\">Slack community</a></p>\n<h2>Community</h2>\n<ul>\n<li><a href=\"https://slack.jina.ai/\">Slack community</a> - a communication platform for developers to discuss Jina.</li>\n<li><a href=\"https://www.linkedin.com/company/jinaai/\">LinkedIn</a> - get to know Jina AI as a company and find job opportunities.</li>\n<li><a href=\"https://twitter.com/JinaAI_\">Twitter</a> - follow us and interact with us using hashtag #JinaSearch.</li>\n<li><a href=\"https://jina.ai\">Company</a> - know more about our company, we are fully committed to open-source!</li>\n</ul>\n<h2>License</h2>\n<p>Copyright (c) 2021 Jina AI Limited. All rights reserved.</p>\n<p>Jina is licensed under the Apache License, Version 2.0. See <a href=\"https://github.com/jina-ai/jina/blob/master/LICENSE\">LICENSE</a> for the full license text.</p>\n","coverImage":"/assets/images/blog/tutorials/jina_chatbot_tutorial.png"}},"__N_SSG":true}